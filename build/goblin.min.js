!function(){function t(t){if(null!=t.limit.constraint_row){var i=t.rows.indexOf(t.limit.constraint_row);t.rows.splice(i,1),t.limit.constraint_row=null}}function i(t){if(null!=t.motor.constraint_row){var i=t.rows.indexOf(t.motor.constraint_row);t.rows.splice(i,1),t.motor.constraint_row=null}}var e={};e.Matrix3=function(t,i,e,o,s,a,n,r,h){this.e00=t||0,this.e01=i||0,this.e02=e||0,this.e10=o||0,this.e11=s||0,this.e12=a||0,this.e20=n||0,this.e21=r||0,this.e22=h||0},e.Matrix3.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e10=0,this.e11=1,this.e12=0,this.e20=0,this.e21=0,this.e22=1},fromMatrix4:function(t){this.e00=t.e00,this.e01=t.e01,this.e02=t.e02,this.e10=t.e10,this.e11=t.e11,this.e12=t.e12,this.e20=t.e20,this.e21=t.e21,this.e22=t.e22},fromQuaternion:function(t){var i=t.x+t.x,e=t.y+t.y,o=t.z+t.z,s=t.x*i,a=t.x*e,n=t.x*o,r=t.y*e,h=t.y*o,c=t.z*o,l=t.w*i,p=t.w*e,_=t.w*o;this.e00=1-(r+c),this.e10=a+_,this.e20=n-p,this.e01=a-_,this.e11=1-(s+c),this.e21=h+l,this.e02=n+p,this.e12=h-l,this.e22=1-(s+r)},transformVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o,t.y=this.e10*i+this.e11*e+this.e12*o,t.z=this.e20*i+this.e21*e+this.e22*o},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},transposeInto:function(t){t.e00=this.e00,t.e10=this.e01,t.e20=this.e02,t.e01=this.e10,t.e11=this.e11,t.e21=this.e12,t.e02=this.e20,t.e12=this.e21,t.e22=this.e22},invert:function(){var t,i=this.e00,e=this.e01,o=this.e02,s=this.e10,a=this.e11,n=this.e12,r=this.e20,h=this.e21,c=this.e22,l=c*a-n*h,p=-c*s+n*r,_=h*s-a*r,u=i*l+e*p+o*_;return u?(t=1/u,this.e00=l*t,this.e01=(-c*e+o*h)*t,this.e02=(n*e-o*a)*t,this.e10=p*t,this.e11=(c*i-o*r)*t,this.e12=(-n*i+o*s)*t,this.e20=_*t,this.e21=(-h*i+e*r)*t,this.e22=(a*i-e*s)*t,!0):!0},invertInto:function(t){var i,e=this.e00,o=this.e01,s=this.e02,a=this.e10,n=this.e11,r=this.e12,h=this.e20,c=this.e21,l=this.e22,p=l*n-r*c,_=-l*a+r*h,u=c*a-n*h,b=e*p+o*_+s*u;return b?(i=1/b,t.e00=p*i,t.e01=(-l*o+s*c)*i,t.e02=(r*o-s*n)*i,t.e10=_*i,t.e11=(l*e-s*h)*i,t.e12=(-r*e+s*a)*i,t.e20=u*i,t.e21=(-c*e+o*h)*i,t.e22=(n*e-o*a)*i,!0):!1},multiply:function(t){var i=this.e00,e=this.e01,o=this.e02,s=this.e10,a=this.e11,n=this.e12,r=this.e20,h=this.e21,c=this.e22,l=t.e00,p=t.e01,_=t.e02,u=t.e10,b=t.e11,f=t.e12,d=t.e20,m=t.e21,y=t.e22;this.e00=l*i+u*e+d*o,this.e10=l*s+u*a+d*n,this.e20=l*r+u*h+d*c,this.e01=p*i+b*e+m*o,this.e11=p*s+b*a+m*n,this.e21=p*r+b*h+m*c,this.e02=_*i+f*e+y*o,this.e12=_*s+f*a+y*n,this.e22=_*r+f*h+y*c},multiplyFrom:function(t,i){var e=t.e00,o=t.e01,s=t.e02,a=t.e10,n=t.e11,r=t.e12,h=t.e20,c=t.e21,l=t.e22,p=i.e00,_=i.e01,u=i.e02,b=i.e10,f=i.e11,d=i.e12,m=i.e20,y=i.e21,j=i.e22;this.e00=p*e+b*o+m*s,this.e10=p*a+b*n+m*r,this.e20=p*h+b*c+m*l,this.e01=_*e+f*o+y*s,this.e11=_*a+f*n+y*r,this.e21=_*h+f*c+y*l,this.e02=u*e+d*o+j*s,this.e12=u*a+d*n+j*r,this.e22=u*h+d*c+j*l}},e.Matrix4=function(){this.e00=0,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=0,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=0,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=0},e.Matrix4.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=1,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=1,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=1},copy:function(t){this.e00=t.e00,this.e01=t.e01,this.e02=t.e02,this.e03=t.e03,this.e10=t.e10,this.e11=t.e11,this.e12=t.e12,this.e13=t.e13,this.e20=t.e20,this.e21=t.e21,this.e22=t.e22,this.e23=t.e23,this.e30=t.e30,this.e31=t.e31,this.e32=t.e32,this.e33=t.e33},getTranslation:function(t){return t=t||new e.Vector3,t.set(this.e03,this.e13,this.e23),t},getRotation:function(t){return t=t||new e.Quaternion,t.setFromMat4(this),t},makeTransform:function(t,i){var e=t.x+t.x,o=t.y+t.y,s=t.z+t.z,a=t.x*e,n=t.x*o,r=t.x*s,h=t.y*o,c=t.y*s,l=t.z*s,p=t.w*e,_=t.w*o,u=t.w*s;this.e00=1-(h+l),this.e10=n+u,this.e20=r-_,this.e30=0,this.e01=n-u,this.e11=1-(a+l),this.e21=c+p,this.e31=0,this.e02=r+_,this.e12=c-p,this.e22=1-(a+h),this.e32=0,this.e03=i.x,this.e13=i.y,this.e23=i.z,this.e33=1},transformVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o+this.e03,t.y=this.e10*i+this.e11*e+this.e12*o+this.e13,t.z=this.e20*i+this.e21*e+this.e22*o+this.e23},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z+this.e03,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z+this.e13,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z+this.e23},rotateVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o,t.y=this.e10*i+this.e11*e+this.e12*o,t.z=this.e20*i+this.e21*e+this.e22*o},rotateVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},invert:function(){var t,i=this.e00,e=this.e01,o=this.e02,s=this.e03,a=this.e10,n=this.e11,r=this.e12,h=this.e13,c=this.e20,l=this.e21,p=this.e22,_=this.e23,u=this.e30,b=this.e31,f=this.e32,d=this.e33,m=i*n-e*a,y=i*r-o*a,j=i*h-s*a,w=e*r-o*n,x=e*h-s*n,g=o*h-s*r,v=c*b-l*u,V=c*f-p*u,z=c*d-_*u,B=l*f-p*b,C=l*d-_*b,S=p*d-_*f,P=m*S-y*C+j*B+w*z-x*V+g*v;return P?(t=1/P,this.e00=(n*S-r*C+h*B)*t,this.e01=(-e*S+o*C-s*B)*t,this.e02=(b*g-f*x+d*w)*t,this.e03=(-l*g+p*x-_*w)*t,this.e10=(-a*S+r*z-h*V)*t,this.e11=(i*S-o*z+s*V)*t,this.e12=(-u*g+f*j-d*y)*t,this.e13=(c*g-p*j+_*y)*t,this.e20=(a*C-n*z+h*v)*t,this.e21=(-i*C+e*z-s*v)*t,this.e22=(u*x-b*j+d*m)*t,this.e23=(-c*x+l*j-_*m)*t,this.e30=(-a*B+n*V-r*v)*t,this.e31=(i*B-e*V+o*v)*t,this.e32=(-u*w+b*y-f*m)*t,this.e33=(c*w-l*y+p*m)*t,!0):!1},invertInto:function(t){var i,e=this.e00,o=this.e10,s=this.e20,a=this.e30,n=this.e01,r=this.e11,h=this.e21,c=this.e31,l=this.e02,p=this.e12,_=this.e22,u=this.e32,b=this.e03,f=this.e13,d=this.e23,m=this.e33,y=e*r-o*n,j=e*h-s*n,w=e*c-a*n,x=o*h-s*r,g=o*c-a*r,v=s*c-a*h,V=l*f-p*b,z=l*d-_*b,B=l*m-u*b,C=p*d-_*f,S=p*m-u*f,P=_*m-u*d,M=y*P-j*S+w*C+x*B-g*z+v*V;return M?(i=1/M,t.e00=(r*P-h*S+c*C)*i,t.e10=(-o*P+s*S-a*C)*i,t.e20=(f*v-d*g+m*x)*i,t.e30=(-p*v+_*g-u*x)*i,t.e01=(-n*P+h*B-c*z)*i,t.e11=(e*P-s*B+a*z)*i,t.e21=(-b*v+d*w-m*j)*i,t.e31=(l*v-_*w+u*j)*i,t.e02=(n*S-r*B+c*V)*i,t.e12=(-e*S+o*B-a*V)*i,t.e22=(b*g-f*w+m*y)*i,t.e32=(-l*g+p*w-u*y)*i,t.e03=(-n*C+r*z-h*V)*i,t.e13=(e*C-o*z+s*V)*i,t.e23=(-b*x+f*j-d*y)*i,void(t.e33=(l*x-p*j+_*y)*i)):!1},multiply:function(t){var i=this.e00,e=this.e10,o=this.e20,s=this.e30,a=this.e01,n=this.e11,r=this.e21,h=this.e31,c=this.e02,l=this.e12,p=this.e22,_=this.e32,u=this.e03,b=this.e13,f=this.e23,d=this.e33,m=t.e00,y=t.e10,j=t.e20,w=t.e30;this.e00=m*i+y*a+j*c+w*u,this.e10=m*e+y*n+j*l+w*b,this.e20=m*o+y*r+j*p+w*f,this.e30=m*s+y*h+j*_+w*d,m=t.e01,y=t.e11,j=t.e21,w=t.e31,this.e01=m*i+y*a+j*c+w*u,this.e11=m*e+y*n+j*l+w*b,this.e21=m*o+y*r+j*p+w*f,this.e31=m*s+y*h+j*_+w*d,m=t.e02,y=t.e12,j=t.e22,w=t.e32,this.e02=m*i+y*a+j*c+w*u,this.e12=m*e+y*n+j*l+w*b,this.e22=m*o+y*r+j*p+w*f,this.e32=m*s+y*h+j*_+w*d,m=t.e03,y=t.e13,j=t.e23,w=t.e33,this.e03=m*i+y*a+j*c+w*u,this.e13=m*e+y*n+j*l+w*b,this.e23=m*o+y*r+j*p+w*f,this.e33=m*s+y*h+j*_+w*d}},Object.defineProperty(e.Matrix4.prototype,"data",{get:function(){return[this.e00,this.e10,this.e20,this.e30,this.e01,this.e11,this.e21,this.e31,this.e02,this.e12,this.e22,this.e32,this.e03,this.e13,this.e23,this.e33]}}),e.Quaternion=function(t,i,e,o){this.x=null!=t?t:0,this.y=null!=i?i:0,this.z=null!=e?e:0,this.w=null!=o?o:1,this.normalize()},e.Quaternion.prototype={set:function(t,i,e,o){this.x=t,this.y=i,this.z=e,this.w=o},copy:function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},toString:function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},multiply:function(t){var i=this.x,e=this.y,o=this.z,s=this.w,a=t.x,n=t.y,r=t.z,h=t.w;this.x=i*h+s*a+e*r-o*n,this.y=e*h+s*n+o*a-i*r,this.z=o*h+s*r+i*n-e*a,this.w=s*h-i*a-e*n-o*r},multiplyQuaternions:function(t,i){this.x=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,this.y=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,this.z=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,this.w=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z},normalize:function(){var t=this.x,i=this.y,e=this.z,o=this.w,s=Math.sqrt(t*t+i*i+e*e+o*o);0===s?this.x=this.y=this.z=this.w=0:(s=1/s,this.x*=s,this.y*=s,this.z*=s,this.w*=s)},invertQuaternion:function(t){var i=t.x,e=t.y,o=t.z,s=t.w,a=i*i+e*e+o*o+s*s;if(0===a)this.x=this.y=this.z=this.w=0;else{var n=-1/a;this.x=t.x*n,this.y=t.y*n,this.z=t.z*n,this.w=t.w*-n}},transformVector3:function(t){var i=t.x,e=t.y,o=t.z,s=this.x,a=this.y,n=this.z,r=this.w,h=r*i+a*o-n*e,c=r*e+n*i-s*o,l=r*o+s*e-a*i,p=-s*i-a*e-n*o;t.x=h*r+p*-s+c*-n-l*-a,t.y=c*r+p*-a+l*-s-h*-n,t.z=l*r+p*-n+h*-a-c*-s},transformVector3Into:function(t,i){var e=t.x,o=t.y,s=t.z,a=this.x,n=this.y,r=this.z,h=this.w,c=h*e+n*s-r*o,l=h*o+r*e-a*s,p=h*s+a*o-n*e,_=-a*e-n*o-r*s;i.x=c*h+_*-a+l*-r-p*-n,i.y=l*h+_*-n+p*-a-c*-r,i.z=p*h+_*-r+c*-n-l*-a},setFromMat4:function(t){var i,e,o,s,a,n,r,h,c,l,p,_,u,b,f;return i=t.e00,e=t.e10,o=t.e20,s=t.e01,a=t.e11,n=t.e21,r=t.e02,h=t.e12,c=t.e22,u=1/Math.sqrt(i*i+e*e+o*o),b=1/Math.sqrt(s*s+a*a+n*n),f=1/Math.sqrt(r*r+h*h+c*c),i*=u,e*=u,o*=u,s*=b,a*=b,n*=b,r*=f,h*=f,c*=f,l=i+a+c,l>=0?(p=Math.sqrt(l+1),this.w=.5*p,p=.5/p,this.x=(n-h)*p,this.y=(r-o)*p,this.z=(e-s)*p):i>a?i>c?(_=i-(a+c)+1,_=Math.sqrt(_),this.x=.5*_,_=.5/_,this.w=(n-h)*_,this.y=(e+s)*_,this.z=(o+r)*_):(_=c-(i+a)+1,_=Math.sqrt(_),this.z=.5*_,_=.5/_,this.w=(e-s)*_,this.x=(r+o)*_,this.y=(h+n)*_):a>c?(_=a-(c+i)+1,_=Math.sqrt(_),this.y=.5*_,_=.5/_,this.w=(r-o)*_,this.z=(n+h)*_,this.x=(s+e)*_):(_=c-(i+a)+1,_=Math.sqrt(_),this.z=.5*_,_=.5/_,this.w=(e-s)*_,this.x=(r+o)*_,this.y=(h+n)*_),this},angleBetween:function(t){return 2*Math.acos(this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w)},signedAngleBetween:function(t,i){return Math.abs(n.dot(i))<.5?o.set(1,0,0):o.set(0,0,1),this.transformVector3Into(o,s),t.transformVector3Into(o,a),o.crossVectors(s,a),Math.atan2(i.dot(o),s.dot(a))}},e.Quaternion.IDENTITY=new e.Quaternion,e.Vector3=function(t,i,e){this.x=t||0,this.y=i||0,this.z=e||0},e.Vector3.prototype={set:function(t,i,e){this.x=t,this.y=i,this.z=e},copy:function(t){this.x=t.x,this.y=t.y,this.z=t.z},add:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},addVectors:function(t,i){this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z},subtract:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},subtractVectors:function(t,i){this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z},multiply:function(t){this.x*=t.x,this.y*=t.y,this.z*=t.z},multiplyVectors:function(t,i){this.x=t.x*i.x,this.y=t.y*i.y,this.z=t.z*i.z},scale:function(t){this.x*=t,this.y*=t,this.z*=t},scaleVector:function(t,i){this.x=t.x*i,this.y=t.y*i,this.z=t.z*i},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){var t=this.length();0===t?this.x=this.y=this.z=0:this.scale(1/t)},normalizeVector:function(t){this.copy(t),this.normalize()},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){var i=this.x,e=this.y,o=this.z;this.x=e*t.z-o*t.y,this.y=o*t.x-i*t.z,this.z=i*t.y-e*t.x},crossVectors:function(t,i){this.x=t.y*i.z-t.z*i.y,this.y=t.z*i.x-t.x*i.z,this.z=t.x*i.y-t.y*i.x},distanceTo:function(t){var i=t.x-this.x,e=t.y-this.y,o=t.z-this.z;return Math.sqrt(i*i+e*e+o*o)},findOrthogonal:function(t,i){var e,o;Math.abs(this.z)>.7071067811865476?(e=-this.y*this.y+this.z*this.z,o=1/Math.sqrt(e),t.set(0,-this.z*o,this.y*o),i.set(e*o,-this.x*t.z,this.x*t.y)):(e=this.x*this.x+this.y*this.y,o=1/Math.sqrt(e),t.set(-this.y*o,this.x*o,0),i.set(-this.z*t.y,this.z*t.x,e*o))}},e.EPSILON=1e-5;{var o=new e.Vector3,s=new e.Vector3,a=new e.Vector3,n=new e.Vector3(1,0,0),r=(new e.Vector3(0,1,0),new e.Vector3(0,0,1),new e.Quaternion),h=new e.Quaternion,c=new e.Matrix3,l=new e.Matrix3;new e.Matrix4}e.EventEmitter=function(){},e.EventEmitter.prototype={addListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(i)&&this.listeners[t].push(i)},removeListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]);var e=this.listeners[t].indexOf(i);-1!==e&&this.listeners[t].splice(e,1)},removeAllListeners:function(){for(var t=Object.keys(this.listeners),i=0;i<t.length;i++)this.listeners[t[i]].length=0},emit:function(t){var i,e=Array.prototype.slice.call(arguments,1);if(this.listeners[t]instanceof Array)for(var o=this.listeners[t].slice(),s=0;s<o.length;s++)if(i=o[s].apply(this,e),i===!1)return!1}},e.EventEmitter.apply=function(t){t.prototype.addListener=e.EventEmitter.prototype.addListener,t.prototype.removeListener=e.EventEmitter.prototype.removeListener,t.prototype.removeAllListeners=e.EventEmitter.prototype.removeAllListeners,t.prototype.emit=e.EventEmitter.prototype.emit},e.RigidBody=function(){var t=0;return function(i,o){this.id=t++,this.shape=i,this.aabb=new e.AABB,this._mass=o||1/0,this._mass_inverted=1/o,this._is_static=!1,this._is_kinematic=!1,this.use_gravity=!0,this.position=new e.Vector3,this.rotation=new e.Quaternion(0,0,0,1),this.linear_velocity=new e.Vector3,this.angular_velocity=new e.Vector3,this.transform=new e.Matrix4,this.transform.identity(),this.transform_inverse=new e.Matrix4,this.transform_inverse.identity(),this._computeInertiaTensor(),this.inverseInertiaTensor=new e.Matrix3,this.inertiaTensor.invertInto(this.inverseInertiaTensor),this.inertiaTensorWorldFrame=new e.Matrix3,this.inverseInertiaTensorWorldFrame=new e.Matrix3,this.acceleration=new e.Vector3,this.restitution=0,this.friction=.6,this.gravity=null,this.linear_acceleration=new e.Vector3,this.angular_acceleration=new e.Vector3,this.linear_damping=0,this.angular_damping=0,this.linear_factor=new e.Vector3(1,1,1),this.angular_factor=new e.Vector3(1,1,1),this.center_of_mass=new e.Vector3(0,0,0),this.world=null,this._layer=null,this.accumulated_force=new e.Vector3,this.accumulated_torque=new e.Vector3,this._world_transform=new e.Matrix4,this.push_velocity=new e.Vector3,this.turn_velocity=new e.Vector3,this.solver_impulse=new Float64Array(6),this.listeners={}}}(),e.EventEmitter.apply(e.RigidBody),Object.defineProperty(e.RigidBody.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t,this._mass_inverted=1/t,this.updateShapeDerivedValues()}}),Object.defineProperty(e.RigidBody.prototype,"is_kinematic",{get:function(){return this._is_kinematic},set:function(t){t!==this._is_kinematic&&(this.world&&this.world.updateObjectKinematicFlag(this,t),this._is_kinematic=t),this.updateShapeDerivedValues()}}),Object.defineProperty(e.RigidBody.prototype,"layer",{get:function(){return this._layer},set:function(t){t!==this._layer&&(this.world&&this.world.updateObjectLayer(this,t),this._layer=t)}}),Object.defineProperty(e.RigidBody.prototype,"is_static",{get:function(){return this._is_static},set:function(t){t!==this._is_static&&(this.world&&this.world.updateObjectStaticFlag(this,t),this._is_static=t)}}),e.RigidBody.prototype.markDynamic=function(){this.world.broadphase.markDynamic(this)},e.RigidBody.prototype.setTransform=function(t,i){this.rotation.copy(i),this.rotation.transformVector3Into(this.center_of_mass,o),this.position.copy(t),this.position.add(o)},e.RigidBody.prototype.getTransform=function(t,i){this.updateDerived(),i.copy(this.rotation),this.rotation.transformVector3Into(this.center_of_mass,o),t.copy(this.position),t.sub(o)},e.RigidBody.prototype.updateShapeDerivedValues=function(){return this.shape.center_of_mass?(this.shape.updateCenterOfMass(),this.shape.updateAABB(),this.aabb.transform(this.shape.aabb,this.transform),this._computeInertiaTensor(),o.copy(this.shape.center_of_mass),o.subtract(this.center_of_mass),this.rotation.transformVector3Into(o,s),this.position.add(s),void this.center_of_mass.copy(this.shape.center_of_mass)):void this._computeInertiaTensor()},e.RigidBody.prototype._computeInertiaTensor=function(){this.inertiaTensor=this.shape.getInertiaTensor(this._is_kinematic?1/0:this._mass)},e.RigidBody.prototype.findSupportPoint=function(){var t=new e.Vector3;return function(i,e){this.transform_inverse.rotateVector3Into(i,t),this.shape.findSupportPoint(t,e),this.transform.transformVector3(e)}}(),e.RigidBody.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o,s,a){this.transform_inverse.transformVector3Into(e,t),this.transform_inverse.transformVector3Into(o,i);var n=this.shape.rayIntersect(t,i,s-a.length);null===n||Array.isArray(n)||(n=[n]);for(var r=0;r<n.length;r++){var h=n[r];h.object=this,this.transform.transformVector3(h.point),this.transform.rotateVector3(h.normal),a.push(h)}}}(),e.RigidBody.prototype.integrate=function(t){this._mass!==1/0&&(o.scaleVector(this.accumulated_force,this._mass_inverted),o.multiply(this.linear_factor),this.linear_velocity.add(o),this.inverseInertiaTensorWorldFrame.transformVector3Into(this.accumulated_torque,o),o.multiply(this.angular_factor),this.angular_velocity.add(o),this.linear_velocity.scale(Math.max(0,1-this.linear_damping*t)),this.angular_velocity.scale(Math.max(0,1-this.angular_damping*t)),this.integratePosition(t,this.linear_velocity),this.integrateRotation(t,this.angular_velocity),this.accumulated_force.x=this.accumulated_force.y=this.accumulated_force.z=0,this.accumulated_torque.x=this.accumulated_torque.y=this.accumulated_torque.z=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity.x=this.push_velocity.y=this.push_velocity.z=0,this.turn_velocity.x=this.turn_velocity.y=this.turn_velocity.z=0)},e.RigidBody.prototype.integratePosition=function(t,i){o.scaleVector(i,t),this.position.add(o)},e.RigidBody.prototype.integrateRotation=function(t,i){o.copy(i);var e=o.length();e*t>Math.PI/4&&(e=Math.PI/4/t),o.scale(.001>e?.5*t-t*t*t*.020833333333*e*e:Math.sin(.5*e*t)/e),r.x=o.x,r.y=o.y,r.z=o.z,r.w=Math.cos(e*t*.5),r.multiply(this.rotation),this.rotation.copy(r)},e.RigidBody.prototype.setGravity=function(t,i,o){this.gravity?(this.gravity.x=t,this.gravity.y=i,this.gravity.z=o):this.gravity=new e.Vector3(t,i,o)},e.RigidBody.prototype.applyImpulse=function(t){o.multiplyVectors(t,this.linear_factor),this.linear_velocity.add(o)},e.RigidBody.prototype.addLinearAcceleration=function(t){this.linear_acceleration.add(t)},e.RigidBody.prototype.addAngularAcceleration=function(t){this.angular_acceleration.add(t)},e.RigidBody.prototype.applyForce=function(t){this.accumulated_force.add(t)},e.RigidBody.prototype.applyTorque=function(t){this.accumulated_torque.add(t)},e.RigidBody.prototype.applyForceAtWorldPoint=function(t,i){o.copy(i),o.subtract(this.position),o.cross(t),this.accumulated_force.add(t),this.accumulated_torque.add(o)},e.RigidBody.prototype.applyForceAtLocalPoint=function(t,i){this.transform.transformVector3Into(i,s),this.applyForceAtWorldPoint(t,s)},e.RigidBody.prototype.getVelocityInLocalPoint=function(t,i){this._mass===1/0?i.set(0,0,0):(i.copy(this.angular_velocity),i.cross(t),i.add(this.linear_velocity))},e.RigidBody.prototype.updateDerived=function(){this.rotation.normalize(),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this._mass!==1/0&&(c.fromMatrix4(this.transform_inverse),c.transposeInto(l),l.multiply(this.inertiaTensor),this.inertiaTensorWorldFrame.multiplyFrom(l,c),this.inertiaTensorWorldFrame.invertInto(this.inverseInertiaTensorWorldFrame)),this.aabb.transform(this.shape.aabb,this.transform)},e.ForceGenerator=function(t){this.force=t||new e.Vector3,this.enabled=!0,this.affected=[]},e.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,i;for(t=0,i=this.affected.length;i>t;t++)this.affected[t].applyForce(this.force)}},e.ForceGenerator.prototype.enable=function(){this.enabled=!0},e.ForceGenerator.prototype.disable=function(){this.enabled=!1},e.ForceGenerator.prototype.affect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return;this.affected.push(t)},e.ForceGenerator.prototype.unaffect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return void this.affected.splice(i,1)},e.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},e.BasicBroadphase.prototype.getDynamicBodies=function(){return this.bodies},e.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},e.BasicBroadphase.prototype.removeBody=function(t){this._removeBodyFrom(t,this.bodies)},e.BasicBroadphase.prototype._removeBodyFrom=function(t,i){var e,o=i.length;for(e=0;o>e;e++)if(i[e]===t){i[e]=i[0],i.shift();break}},e.BasicBroadphase.prototype.update=function(){var t,i,o,s,a=this.bodies.length;for(this.collision_pairs.length=0,t=0;a>t;t++)for(o=this.bodies[t],i=0;a>i;i++)i>=t||(s=this.bodies[i],e.CollisionUtils.canBodiesCollide(o,s)&&o.aabb.intersects(s.aabb)&&this.collision_pairs.push([s,o]))},e.BasicBroadphase.prototype.intersectsWith=function(t){var i,e,o=this.bodies.length,s=[];for(i=0;o>i;i++)e=this.bodies[i],t!==e&&t.aabb.intersects(e.aabb)&&s.push(e);return s},e.BasicBroadphase.prototype.rayIntersect=function(t,i){var e,o,s=this.bodies.length,a=[];for(e=0;s>e;e++)o=this.bodies[e],o.aabb.testRayIntersect(t,i)&&o.rayIntersect(t,i,a);return a},e.BasicPooledBroadphase=function(){e.BasicBroadphase.call(this),this.static_bodies=[],this.dynamic_bodies=[],this.kinematic_bodies=[],this._layers=new Array(32);for(var t=0;32>t;t++)this._layers[t]=[]},e.BasicPooledBroadphase.prototype=Object.create(e.BasicBroadphase.prototype),e.BasicPooledBroadphase.prototype.getDynamicBodies=function(){return this.dynamic_bodies},e.BasicBroadphase.prototype.updateObjectLayer=function(t,i){null!==t._layer&&this._layers[t._layer]&&this._removeBodyFrom(t,this._layers[t._layer]),null!==i&&this._layers[i].push(t)},e.BasicBroadphase.prototype._getBodyPool=function(t){return t._is_static?this.static_bodies:t._is_kinematic?this.kinematic_bodies:this.dynamic_bodies},e.BasicBroadphase.prototype.markDynamic=function(t){this._removeBodyFrom(t,this._getBodyPool(t)),this.dynamic_bodies.push(t)},e.BasicBroadphase.prototype.updateObjectStaticFlag=function(t,i){this._removeBodyFrom(t,this._getBodyPool(t)),t._is_static=i,this._getBodyPool(t).push(t)},e.BasicBroadphase.prototype.updateObjectKinematicFlag=function(t,i){this._removeBodyFrom(t,this._getBodyPool(t)),t._is_kinematic=i,this._getBodyPool(t).push(t)},e.BasicPooledBroadphase.prototype.addBody=function(t){e.BasicBroadphase.prototype.addBody.call(this,t),this._getBodyPool(t).push(t),null!==t._layer&&this._layers[t._layer].push(t)},e.BasicPooledBroadphase.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o,s,a){t.copy(e),i.copy(o);for(var n=[],r=0;r<this._layers.length;r++){var h=this._layers[r];if(!a||0!==(a&1<<r))for(var c=0;c<h.length;c++){var l=h[c];if(l.aabb.testRayIntersect(t,i)&&l.rayIntersect(t,i,s,n),s&&n.length>=s)return n.slice(0,s)}}return n.sort(function(t,i){return t.t-i.t}),n}}(),e.BasicPooledBroadphase.prototype.removeBody=function(t){e.BasicBroadphase.prototype.removeBody.call(this,t),this._removeBodyFrom(t,this._getBodyPool(t))},e.BasicPooledBroadphase.prototype.update=function(){var t,i,o,s;for(this.collision_pairs.length=0,t=0;t<this.dynamic_bodies.length;t++){for(o=this.dynamic_bodies[t],i=t+1;i<this.dynamic_bodies.length;i++)s=this.dynamic_bodies[i],e.CollisionUtils.canBodiesCollide(o,s)&&o.aabb.intersects(s.aabb)&&this.collision_pairs.push([s,o]);for(i=0;i<this.static_bodies.length;i++)s=this.static_bodies[i],e.CollisionUtils.canBodiesCollide(o,s)&&o.aabb.intersects(s.aabb)&&this.collision_pairs.push([s,o]);for(i=0;i<this.kinematic_bodies.length;i++)s=this.kinematic_bodies[i],e.CollisionUtils.canBodiesCollide(o,s)&&o.aabb.intersects(s.aabb)&&this.collision_pairs.push([s,o])}},function(){var t=function(t,i,e){this.type=t,this.body=i,this.position=e,this.prev=null,this.next=null};t.TYPES={START:0,END:1};var i=function(){this.first=null,this.last=null};e.SAPBroadphase=function(){this.markers_x=new i,this.markers_y=new i,this.markers_z=new i,this.overlap_counter={},this.collision_pairs=[],this.pending_bodies=[]},e.SAPBroadphase.prototype={incrementOverlaps:function(t,i){if(e.CollisionUtils.canBodiesCollide(t,i)){var o=t.id<i.id?t.id+"-"+i.id:i.id+"-"+t.id;this.overlap_counter.hasOwnProperty(o)||(this.overlap_counter[o]=0),this.overlap_counter[o]++,3===this.overlap_counter[o]&&this.collision_pairs.push([t.id<i.id?t:i,t.id<i.id?i:t])}},decrementOverlaps:function(t,i){var e=t.id<i.id?t.id+"-"+i.id:i.id+"-"+t.id;this.overlap_counter.hasOwnProperty(e)||(this.overlap_counter[e]=0),this.overlap_counter[e]--,0===this.overlap_counter[e]?delete this.overlap_counter[e]:2===this.overlap_counter[e]&&(this.collision_pairs=this.collision_pairs.filter(function(e){return e[0]===t&&e[1]===i?!1:e[0]===i&&e[1]===t?!1:!0}))},updateObjectStaticFlag:function(t,i){},updateObjectKinematicFlag:function(t,i){},updateObjectLayer:function(t,i){},addBody:function(t){this.pending_bodies.push(t)},removeBody:function(t){var i=this.pending_bodies.indexOf(t);if(-1!==i)return void this.pending_bodies.splice(i,1);for(var e,o,s=this.markers_x.first;s;)s.body===t&&(e=s.next,o=s.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_x.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_x.first=e),s=s.next;for(s=this.markers_y.first;s;)s.body===t&&(e=s.next,o=s.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_y.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_y.first=e),s=s.next;for(s=this.markers_z.first;s;)s.body===t&&(e=s.next,o=s.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_z.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_z.first=e),s=s.next;this.collision_pairs=this.collision_pairs.filter(function(i){return i[0]===t||i[1]===t?!1:!0})},insertPending:function(){for(var i;i=this.pending_bodies.pop();){i.updateDerived();var e=new t(t.TYPES.START,i,i.aabb.min.x),o=new t(t.TYPES.START,i,i.aabb.min.y),s=new t(t.TYPES.START,i,i.aabb.min.z),a=new t(t.TYPES.END,i,i.aabb.max.x),n=new t(t.TYPES.END,i,i.aabb.max.y),r=new t(t.TYPES.END,i,i.aabb.max.z);this.insert(this.markers_x,e),this.insert(this.markers_x,a),this.insert(this.markers_y,o),this.insert(this.markers_y,n),this.insert(this.markers_z,s),this.insert(this.markers_z,r)}},insert:function(t,i){null==t.first?t.first=t.last=i:(i.prev=t.last,t.last.next=i,t.last=i,this.sort(t,i))},sort:function(i,e){for(var o;null!=e.prev&&(e.position<e.prev.position||e.position===e.prev.position&&e.type===t.TYPES.START&&e.prev.type===t.TYPES.END);)o=e.prev,e.type!==o.type&&(e.type===t.TYPES.START?this.incrementOverlaps(e.body,o.body):this.decrementOverlaps(e.body,o.body)),e.prev=o.prev,o.next=e.next,e.next=o,o.prev=e,null==e.prev?i.first=e:e.prev.next=e,null==o.next?i.last=o:o.next.prev=o},update:function(){this.collision_pairs.length=0,this.insertPending();for(var i=this.markers_x.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.x:i.body.aabb.max.x,this.sort(this.markers_x,i),i=i.next;for(i=this.markers_y.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.y:i.body.aabb.max.y,this.sort(this.markers_y,i),i=i.next;for(i=this.markers_z.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.z:i.body.aabb.max.z,this.sort(this.markers_z,i),i=i.next},intersectsWith:function(t){this.addBody(t),this.update();var i=this.collision_pairs.filter(function(i){return i[0]===t||i[1]===t?!0:!1}).map(function(i){return i[0]===t?i[1]:i[0]});return this.removeBody(t),i},rayIntersect:function(i,e){this.pending_bodies.length>0&&this.update();var o,s,a,n,r,h,c,l,p={},_=[],u={},b={};for(a=this.markers_x.first,n=!1,p={},o=i.x<e.x?i.x:e.x,s=i.x<e.x?e.x:i.x;a;){if(a.type===t.TYPES.START&&(p[a.body.id]=a.body),a.position>=o)if(n===!1)for(n=!0,l=Object.keys(p),r=0;r<l.length;r++)c=l[r],h=p[c],null!=h&&(u[h.id]=h,b[h.id]=b[h.id]?b[h.id]+1:1);else a.type===t.TYPES.START&&(u[a.body.id]=a.body,b[a.body.id]=b[a.body.id]?b[a.body.id]+1:1);if(a.type===t.TYPES.END&&(p[a.body.id]=null),a.position>s)break;a=a.next}for(l=Object.keys(b),r=0;r<l.length;r++){var f=l[r];1===b[f]&&u[f].aabb.testRayIntersect(i,e)&&u[f].rayIntersect(i,e,_)}return _}}}(),e.BoxSphere=function(t,i){var n,r,h=t.shape instanceof e.SphereShape?t:i,c=t.shape instanceof e.SphereShape?i:t;return c.transform_inverse.transformVector3Into(h.position,o),Math.abs(o.x)-h.shape.radius>c.shape.half_width||Math.abs(o.y)-h.shape.radius>c.shape.half_height||Math.abs(o.z)-h.shape.radius>c.shape.half_depth||(s.x=s.y=s.z=0,r=o.x,r>c.shape.half_width?r=c.shape.half_width:r<-c.shape.half_width&&(r=-c.shape.half_width),s.x=r,r=o.y,r>c.shape.half_height?r=c.shape.half_height:r<-c.shape.half_height&&(r=-c.shape.half_height),s.y=r,r=o.z,r>c.shape.half_depth?r=c.shape.half_depth:r<-c.shape.half_depth&&(r=-c.shape.half_depth),s.z=r,a.subtractVectors(s,o),r=a.lengthSquared(),r>h.shape.radius*h.shape.radius)?void 0:(n=e.ObjectPool.getObject("ContactDetails"),n.object_a=h,n.object_b=c,0===r?e.BoxSphere.spherePenetration(c.shape,o,s,n):(n.contact_normal.subtractVectors(s,o),n.penetration_depth=-n.contact_normal.length(),n.contact_normal.scale(-1/n.penetration_depth),n.contact_point_in_b.copy(s)),n.penetration_depth+=h.shape.radius,c.transform.rotateVector3(n.contact_normal),h.transform_inverse.rotateVector3Into(n.contact_normal,n.contact_point_in_a),n.contact_point_in_a.scale(h.shape.radius),n.contact_point.scaleVector(n.contact_normal,h.shape.radius-n.penetration_depth/2),n.contact_point.add(h.position),n)},e.BoxSphere.spherePenetration=function(t,i,e,o){var a,n;i.x<0?(a=t.half_width+i.x,e.x=-t.half_width,e.y=e.z=0,o.penetration_depth=a):(a=t.half_width-i.x,e.x=t.half_width,e.y=e.z=0,o.penetration_depth=a),i.y<0?(n=t.half_height+i.y,a>n&&(a=n,e.y=-t.half_height,e.x=e.z=0,o.penetration_depth=a)):(n=t.half_height-i.y,a>n&&(a=n,e.y=t.half_height,e.x=e.z=0,o.penetration_depth=a)),i.z<0?(n=t.half_depth+i.z,a>n&&(e.z=-t.half_depth,e.x=e.y=0,o.penetration_depth=a)):(n=t.half_depth-i.z,a>n&&(e.z=t.half_depth,e.x=e.y=0,o.penetration_depth=a)),o.contact_point_in_b.copy(s),o.contact_normal.scaleVector(o.contact_point_in_b,-1),o.contact_normal.normalize()},e.GjkEpa={margins:.01,result:null,max_iterations:20,epa_condition:.001,SupportPoint:function(t,i,e){this.witness_a=t,this.witness_b=i,this.point=e},findSupportPoint:function(){var t=new e.Vector3;return function(i,e,o,s){i.findSupportPoint(o,s.witness_a),t.scaleVector(o,-1),e.findSupportPoint(t,s.witness_b),s.point.subtractVectors(s.witness_a,s.witness_b)}}(),testCollision:function(t,i){var o=e.GjkEpa.GJK(t,i);return null!=e.GjkEpa.result?e.GjkEpa.result:null!=o?e.GjkEpa.EPA(o):void 0},GJK:function(){return function(t,i){var o,s=new e.GjkEpa.Simplex(t,i);for(e.GjkEpa.result=null;o=s.addPoint(););return o===!1?(e.GjkEpa.freeSimplex(s),null):s}}(),freeSimplex:function(t){for(var i=0,o=t.points.length;o>i;i++)e.ObjectPool.freeObject("GJK2SupportPoint",t.points[i])},freePolyhedron:function(t){for(var i=e.ObjectPool.pools.GJK2SupportPoint,o=0,s=t.faces.length;s>o;o++)-1===i.indexOf(t.faces[o].a)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].a),-1===i.indexOf(t.faces[o].b)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].b),-1===i.indexOf(t.faces[o].c)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].c)},EPA:function(){var t=new e.Vector3,i={a:new e.Vector3,b:new e.Vector3,c:new e.Vector3};return function(s){for(var a=new e.GjkEpa.Polyhedron(s),n=0;++n;){a.findFaceClosestToOrigin(),o.copy(a.closest_face_distance<e.EPSILON?a.faces[a.closest_face].normal:a.closest_point);var r=e.ObjectPool.getObject("GJK2SupportPoint");e.GjkEpa.findSupportPoint(s.object_a,s.object_b,o,r),o.subtractVectors(r.point,a.closest_point);var h=o.lengthSquared();if(n===e.GjkEpa.max_iterations||h<e.GjkEpa.epa_condition&&a.closest_face_distance>e.EPSILON){var c=e.ObjectPool.getObject("ContactDetails");return c.object_a=s.object_a,c.object_b=s.object_b,c.contact_normal.normalizeVector(a.closest_point),0===c.contact_normal.lengthSquared()&&c.contact_normal.subtractVectors(c.object_b.position,c.object_a.position),c.contact_normal.normalize(),e.GeometryMethods.findBarycentricCoordinates(a.closest_point,a.faces[a.closest_face].a.point,a.faces[a.closest_face].b.point,a.faces[a.closest_face].c.point,t),
isNaN(t.x)?(e.GjkEpa.freePolyhedron(a),null):(i.a.scaleVector(a.faces[a.closest_face].a.witness_a,t.x),i.b.scaleVector(a.faces[a.closest_face].b.witness_a,t.y),i.c.scaleVector(a.faces[a.closest_face].c.witness_a,t.z),c.contact_point_in_a.addVectors(i.a,i.b),c.contact_point_in_a.add(i.c),i.a.scaleVector(a.faces[a.closest_face].a.witness_b,t.x),i.b.scaleVector(a.faces[a.closest_face].b.witness_b,t.y),i.c.scaleVector(a.faces[a.closest_face].c.witness_b,t.z),c.contact_point_in_b.addVectors(i.a,i.b),c.contact_point_in_b.add(i.c),c.contact_point.addVectors(c.contact_point_in_a,c.contact_point_in_b),c.contact_point.scale(.5),c.object_a.transform_inverse.transformVector3(c.contact_point_in_a),c.object_b.transform_inverse.transformVector3(c.contact_point_in_b),c.penetration_depth=a.closest_point.length()+e.GjkEpa.margins,e.GjkEpa.freePolyhedron(a),c)}a.addVertex(r)}return e.GjkEpa.freePolyhedron(a),null}}(),Face:function(t,i,a,n){this.active=!0,this.a=i,this.b=a,this.c=n,this.normal=new e.Vector3,this.neighbors=[],o.subtractVectors(a.point,i.point),s.subtractVectors(n.point,i.point),this.normal.crossVectors(o,s),this.normal.normalize()}},e.GjkEpa.Polyhedron=function(t){this.closest_face=null,this.closest_face_distance=null,this.closest_point=new e.Vector3,this.faces=[new e.GjkEpa.Face(this,t.points[2],t.points[1],t.points[0]),new e.GjkEpa.Face(this,t.points[3],t.points[1],t.points[2]),new e.GjkEpa.Face(this,t.points[1],t.points[3],t.points[0]),new e.GjkEpa.Face(this,t.points[0],t.points[3],t.points[2])],this.faces[0].neighbors.push(this.faces[1],this.faces[2],this.faces[3]),this.faces[1].neighbors.push(this.faces[2],this.faces[0],this.faces[3]),this.faces[2].neighbors.push(this.faces[1],this.faces[3],this.faces[0]),this.faces[3].neighbors.push(this.faces[2],this.faces[1],this.faces[0])},e.GjkEpa.Polyhedron.prototype={addVertex:function(t){var i,o,s,a,n,r=[],h=[];for(this.faces[this.closest_face].silhouette(t,r),i=0;i<r.length-5;i+=5){if(s=r[i+3],a=r[i+4],0!==i&&n!==s)for(o=i+5;o<r.length;o+=5)if(r[o+3]===n){var c=r.slice(i,i+5);r[i]=r[o],r[i+1]=r[o+1],r[i+2]=r[o+2],r[i+3]=r[o+3],r[i+4]=r[o+4],r[o]=c[0],r[o+1]=c[1],r[o+2]=c[2],r[o+3]=c[3],r[o+4]=c[4],s=r[i+3],a=r[i+4];break}n=a}for(i=0;i<r.length;i+=5){var l=r[i];s=r[i+3],a=r[i+4];var p=new e.GjkEpa.Face(this,a,t,s);p.neighbors[2]=r[i],h.push(p),l.neighbors[l.neighbors.indexOf(r[i+2])]=p}for(i=0;i<h.length;i++)h[i].neighbors[0]=h[i+1===h.length?0:i+1],h[i].neighbors[1]=h[0>i-1?h.length-1:i-1];return Array.prototype.push.apply(this.faces,h),r},findFaceClosestToOrigin:function(){var t=new e.Vector3,i=new e.Vector3;return function(){this.closest_face_distance=1/0;var o,s;for(s=0;s<this.faces.length;s++)this.faces[s].active!==!1&&(e.GeometryMethods.findClosestPointInTriangle(t,this.faces[s].a.point,this.faces[s].b.point,this.faces[s].c.point,i),o=i.lengthSquared(),o<this.closest_face_distance&&(this.closest_face_distance=o,this.closest_face=s,this.closest_point.copy(i)))}}()},e.GjkEpa.Face.prototype={classifyVertex:function(t){var i=this.normal.dot(this.a.point);return this.normal.dot(t.point)-i},silhouette:function(t,i,e){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,i,this),this.neighbors[1].silhouette(t,i,this),this.neighbors[2].silhouette(t,i,this);else if(e){var o,s,a=this.neighbors.indexOf(e);0===a?(o=this.a,s=this.b):1===a?(o=this.b,s=this.c):(o=this.c,s=this.a),i.push(this,a,e,s,o)}}},function(){var t=new e.Vector3,i=new e.Vector3,n=new e.Vector3,r=new e.Vector3,h=new e.Vector3,c=new e.Vector3,l={a:new e.Vector3,b:new e.Vector3,c:new e.Vector3};e.GjkEpa.Simplex=function(t,i){this.object_a=t,this.object_b=i,this.points=[],this.iterations=0,this.next_direction=new e.Vector3,this.updateDirection()},e.GjkEpa.Simplex.prototype={addPoint:function(){if(++this.iterations===e.GjkEpa.max_iterations)return!1;var i=e.ObjectPool.getObject("GJK2SupportPoint");if(e.GjkEpa.findSupportPoint(this.object_a,this.object_b,this.next_direction,i),this.points.push(i),i.point.dot(this.next_direction)<0&&this.points.length>1){if(this.points.length>=3){e.GeometryMethods.findClosestPointInTriangle(t,this.points[0].point,this.points[1].point,this.points[2].point,o);var s=o.lengthSquared();if(s<=e.GjkEpa.margins*e.GjkEpa.margins){var a=e.ObjectPool.getObject("ContactDetails");return a.object_a=this.object_a,a.object_b=this.object_b,a.contact_normal.normalizeVector(o),0===a.contact_normal.lengthSquared()&&a.contact_normal.subtractVectors(a.object_b.position,a.object_a.position),a.contact_normal.normalize(),a.contact_normal.scale(-1),a.penetration_depth=e.GjkEpa.margins-Math.sqrt(s),e.GeometryMethods.findBarycentricCoordinates(o,this.points[0].point,this.points[1].point,this.points[2].point,c),isNaN(c.x)?!1:(l.a.scaleVector(this.points[0].witness_a,c.x),l.b.scaleVector(this.points[1].witness_a,c.y),l.c.scaleVector(this.points[2].witness_a,c.z),a.contact_point_in_a.addVectors(l.a,l.b),a.contact_point_in_a.add(l.c),a.contact_point_in_b.scaleVector(a.contact_normal,-a.penetration_depth),a.contact_point_in_b.add(a.contact_point_in_a),a.contact_point.addVectors(a.contact_point_in_a,a.contact_point_in_b),a.contact_point.scale(.5),a.object_a.transform_inverse.transformVector3(a.contact_point_in_a),a.object_b.transform_inverse.transformVector3(a.contact_point_in_b),a.restitution=(this.object_a.restitution+this.object_b.restitution)/2,a.friction=(this.object_a.friction+this.object_b.friction)/2,e.GjkEpa.result=a,null)}}return!1}return this.updateDirection()===!0?null:i},findDirectionFromLine:function(){i.scaleVector(this.points[1].point,-1),n.subtractVectors(this.points[0].point,this.points[1].point),n.dot(i)<0?(this.next_direction.copy(i),e.ObjectPool.freeObject("GJK2SupportPoint",this.points[1]),this.points.length=1):(this.next_direction.crossVectors(n,i),this.next_direction.cross(n),0===this.next_direction.x&&0===this.next_direction.y&&0===this.next_direction.z&&(n.normalize(),this.next_direction.x=1-Math.abs(n.x),this.next_direction.y=1-Math.abs(n.y),this.next_direction.z=1-Math.abs(n.z)))},findDirectionFromTriangle:function(){var t=this.points[2],h=this.points[1],c=this.points[0];i.scaleVector(t.point,-1),n.subtractVectors(h.point,t.point),r.subtractVectors(c.point,t.point),o.crossVectors(n,r),s.crossVectors(n,o),a.crossVectors(o,r),a.dot(i)>=0?r.dot(i)>=0?(this.points.length=0,this.points.push(c,t),e.ObjectPool.freeObject("GJK2SupportPoint",h),this.next_direction.crossVectors(r,i),this.next_direction.cross(r)):n.dot(i)>=0?(this.points.length=0,this.points.push(h,t),e.ObjectPool.freeObject("GJK2SupportPoint",c),this.next_direction.crossVectors(n,i),this.next_direction.cross(n)):(this.points.length=0,this.points.push(t),e.ObjectPool.freeObject("GJK2SupportPoint",h),e.ObjectPool.freeObject("GJK2SupportPoint",c)):s.dot(i)>=0?n.dot(i)>=0?(this.points.length=0,this.points.push(h,t),e.ObjectPool.freeObject("GJK2SupportPoint",c),this.next_direction.crossVectors(n,i),this.next_direction.cross(n)):(this.points.length=0,this.points.push(t),e.ObjectPool.freeObject("GJK2SupportPoint",h),e.ObjectPool.freeObject("GJK2SupportPoint",c)):o.dot(i)>=0?(this.next_direction.copy(o),this.points.length=0,this.points.push(t,h,c)):(this.next_direction.copy(o),this.next_direction.scale(-1))},getFaceNormal:function(t,i,e,o){n.subtractVectors(i.point,t.point),r.subtractVectors(e.point,t.point),o.crossVectors(n,r),o.normalize()},faceNormalDotOrigin:function(t,i,e){return this.getFaceNormal(t,i,e,o),s.addVectors(t.point,i.point),s.add(e.point),s.scale(-3),s.normalize(),o.dot(s)},findDirectionFromTetrahedron:function(){var t,i=this.points[3],s=this.points[2],a=this.points[1],n=this.points[0],r=null,h=e.EPSILON;return t=this.faceNormalDotOrigin(s,a,n),t>h&&(r=1,h=t),t=this.faceNormalDotOrigin(i,a,s),t>h&&(r=2,h=t),t=this.faceNormalDotOrigin(a,i,n),t>h&&(r=3,h=t),t=this.faceNormalDotOrigin(n,i,s),t>h&&(r=4,h=t),null===r?!0:void(1===r?(this.points.length=0,this.points.push(s,a,n),this.getFaceNormal(s,a,n,o),this.next_direction.copy(o)):2===r?(this.points.length=0,this.points.push(i,a,s),this.getFaceNormal(i,a,s,o),this.next_direction.copy(o)):3===r?(this.points.length=0,this.points.push(a,i,n),this.getFaceNormal(a,i,n,o),this.next_direction.copy(o)):4===r&&(this.points.length=0,this.points.push(n,i,s),this.getFaceNormal(n,i,s,o),this.next_direction.copy(o)))},containsOrigin:function(){var t=this.points[3],i=this.points[2],e=this.points[1],s=this.points[0];return n.subtractVectors(s.point,t.point),h.subtractVectors(e.point,t.point),o.crossVectors(n,h),o.dot(t.point)>0?!1:(n.subtractVectors(e.point,t.point),h.subtractVectors(i.point,t.point),o.crossVectors(n,h),o.dot(t.point)>0?!1:(n.subtractVectors(i.point,t.point),h.subtractVectors(s.point,t.point),o.crossVectors(n,h),o.dot(t.point)>0?!1:(n.subtractVectors(s.point,e.point),h.subtractVectors(i.point,e.point),o.crossVectors(n,h),o.dot(s.point)>0?!1:!0)))},updateDirection:function(){if(0===this.points.length)this.next_direction.subtractVectors(this.object_b.position,this.object_a.position);else if(1===this.points.length)this.next_direction.scale(-1);else if(2===this.points.length)this.findDirectionFromLine();else{if(3!==this.points.length)return this.findDirectionFromTetrahedron();this.findDirectionFromTriangle()}}}}(),e.SphereSphere=function(t,i){var s=t.position,a=i.position;o.subtractVectors(a,s);var n=o.length();if(!(n>t.shape.radius+i.shape.radius)){var r=e.ObjectPool.getObject("ContactDetails");return r.object_a=t,r.object_b=i,r.contact_normal.scaleVector(o,1/n),o.scale(-.5),r.contact_point.addVectors(o,s),r.penetration_depth=t.shape.radius+i.shape.radius-n,r.contact_point_in_a.scaleVector(r.contact_normal,r.object_a.shape.radius),r.contact_point_in_a.add(r.object_a.position),r.contact_point_in_b.scaleVector(r.contact_normal,-r.object_b.shape.radius),r.contact_point_in_b.add(r.object_b.position),r.contact_point.addVectors(r.contact_point_in_a,r.contact_point_in_b),r.contact_point.scale(.5),r.object_a.transform_inverse.transformVector3(r.contact_point_in_a),r.object_b.transform_inverse.transformVector3(r.contact_point_in_b),r}},e.TriangleTriangle=function(t,i){var a=i.classifyVertex(t.a),n=i.classifyVertex(t.b),r=i.classifyVertex(t.c);if(a>0&&n>0&&r>0||0>a&&0>n&&0>r)return null;var h=t.classifyVertex(i.a),c=t.classifyVertex(i.b),l=t.classifyVertex(i.c);if(h>0&&c>0&&l>0||0>h&&0>c&&0>l)return null;var p=new e.Vector3;p.crossVectors(t.normal,i.normal),p.normalize();var _,u=p.dot(t.a),b=p.dot(t.b),f=p.dot(t.c),d=p.dot(i.a),m=p.dot(i.b),y=p.dot(i.c),j=t.a,w=t.b,x=t.c,g=i.a,v=i.b,V=i.c;Math.sign(a)===Math.sign(n)?(_=a,a=r,r=_,_=u,u=f,f=_,_=j,j=x,x=_):Math.sign(a)===Math.sign(r)&&(_=a,a=n,n=_,_=u,u=b,b=_,_=j,j=w,w=_),Math.sign(h)===Math.sign(c)?(_=h,h=l,l=_,_=d,d=y,y=_,_=g,g=V,V=_):Math.sign(h)===Math.sign(l)&&(_=h,h=c,c=_,_=d,d=m,m=_,_=g,g=v,v=_);var z=u+(b-u)*(a/(a-n)),B=u+(f-u)*(a/(a-r)),C=d+(m-d)*(h/(h-c)),S=d+(y-d)*(h/(h-l));if(z>B&&(_=z,z=B,B=_,_=b,b=f,f=_,_=w,w=x,x=_),C>S&&(_=C,C=S,S=_,_=m,m=y,y=_,_=v,v=V,V=_),z>=C&&S>=z||B>=C&&S>=B||C>=z&&B>=C||S>=z&&B>=S){var P=e.ObjectPool.getObject("ContactDetails");P.object_a=t,P.object_b=i;var M=new e.Vector3,O=new e.Vector3,I=new e.Vector3,A=new e.Vector3,T=new e.Vector3,E=new e.Vector3,k=!1,F=!1;return i.classifyVertex(j)<=0?(k=!0,e.GeometryMethods.findClosestPointInTriangle(j,g,v,V,O),M.copy(j),I.copy(i.normal),I.scale(-1)):z>=C&&S>=z?(k=!0,e.GeometryMethods.findClosestPointInTriangle(w,g,v,V,O),M.copy(w),I.copy(i.normal),I.scale(-1)):B>=C&&S>=B&&(k=!0,e.GeometryMethods.findClosestPointInTriangle(x,g,v,V,O),M.copy(x),I.copy(i.normal),I.scale(-1)),t.classifyVertex(g)<=0?(F=!0,e.GeometryMethods.findClosestPointInTriangle(g,j,w,x,A),T.copy(g),E.copy(t.normal)):C>=z&&B>=C?(F=!0,e.GeometryMethods.findClosestPointInTriangle(v,j,w,x,A),T.copy(v),E.copy(t.normal)):S>=z&&B>=S&&(F=!0,e.GeometryMethods.findClosestPointInTriangle(V,j,w,x,A),T.copy(V),E.copy(t.normal)),o.subtractVectors(M,O),s.subtractVectors(A,T),!F||k&&o.lengthSquared()<s.lengthSquared()?(P.contact_point_in_a.copy(M),P.contact_point_in_b.copy(O),P.contact_normal.copy(I)):(P.contact_point_in_a.copy(A),P.contact_point_in_b.copy(T),P.contact_normal.copy(E)),o.subtractVectors(P.contact_point_in_a,P.contact_point_in_b),P.penetration_depth=o.length(),P.contact_point.addVectors(P.contact_point_in_a,P.contact_point_in_b),P.contact_point.scale(.5),P}return null},e.Constraint=function(){var t=0;return function(){this.id=t++,this.active=!0,this.object_a=null,this.object_b=null,this.limit=new e.ConstraintLimit,this.motor=new e.ConstraintMotor,this.rows=[],this.factor=1,this.last_impulse=new e.Vector3,this.breaking_threshold=0,this.listeners={}}}(),e.EventEmitter.apply(e.Constraint),e.Constraint.prototype.deactivate=function(){this.active=!1,this.emit("deactivate")},e.Constraint.prototype.update=function(){},e.Constraint.prototype.object_a_is_dynamic=function(){return null!==this.object_a&&!this.object_a._is_kinematic&&this.object_a._mass!==1/0},e.Constraint.prototype.object_b_is_dynamic=function(){return null!==this.object_b&&!this.object_b._is_kinematic&&this.object_b._mass!==1/0},e.ConstraintLimit=function(t,i){this.erp=.3,this.constraint_row=null,this.set(t,i)},e.ConstraintLimit.prototype.set=function(t,i){this.limit_lower=t,this.limit_upper=i,this.enabled=null!=this.limit_lower||null!=this.limit_upper},e.ConstraintLimit.prototype.createConstraintRow=function(){this.constraint_row=e.ConstraintRow.createConstraintRow()},e.ConstraintMotor=function(t,i){this.constraint_row=null,this.set(t,i)},e.ConstraintMotor.prototype.set=function(t,i){this.enabled=null!=t&&null!=i,this.torque=t,this.max_speed=i},e.ConstraintMotor.prototype.createConstraintRow=function(){this.constraint_row=e.ConstraintRow.createConstraintRow()},e.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-(1/0),this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cached=0,this.cfm=0,this.eta=0,this.eta_row=new Float64Array(12)},e.ConstraintRow.createConstraintRow=function(){var t=e.ObjectPool.getObject("ConstraintRow");return t.lower_limit=-(1/0),t.upper_limit=1/0,t.bias=0,t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0,t},e.ConstraintRow.prototype.nullify=function(t,i){var e=0;for(e=0;t&&6>e;e++)this.jacobian[e]=0;for(e=6;i&&12>e;e++)this.jacobian[e]=0},e.ConstraintRow.prototype.reset=function(){this.nullify(!0,!0),this.lower_limit=-(1/0),this.upper_limit=1/0,this.bias=0},e.ConstraintRow.prototype.computeB=function(t){var i;t.object_a_is_dynamic()?(i=t.object_a._mass_inverted,this.B[0]=i*this.jacobian[0]*t.object_a.linear_factor.x,this.B[1]=i*this.jacobian[1]*t.object_a.linear_factor.y,this.B[2]=i*this.jacobian[2]*t.object_a.linear_factor.z,o.x=this.jacobian[3],o.y=this.jacobian[4],o.z=this.jacobian[5],t.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),this.B[3]=o.x*t.object_a.angular_factor.x,this.B[4]=o.y*t.object_a.angular_factor.y,this.B[5]=o.z*t.object_a.angular_factor.z):(this.B[0]=this.B[1]=this.B[2]=0,this.B[3]=this.B[4]=this.B[5]=0),t.object_b_is_dynamic()?(i=t.object_b._mass_inverted,this.B[6]=i*this.jacobian[6]*t.object_b.linear_factor.x,this.B[7]=i*this.jacobian[7]*t.object_b.linear_factor.y,this.B[8]=i*this.jacobian[8]*t.object_b.linear_factor.z,o.x=this.jacobian[9],o.y=this.jacobian[10],o.z=this.jacobian[11],t.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),this.B[9]=o.x*t.object_b.angular_factor.x,this.B[10]=o.y*t.object_b.angular_factor.y,this.B[11]=o.z*t.object_b.angular_factor.z):(this.B[6]=this.B[7]=this.B[8]=0,this.B[9]=this.B[10]=this.B[11]=0)},e.ConstraintRow.prototype.computeD=function(){this.D=this.jacobian[0]*this.B[0]+this.jacobian[1]*this.B[1]+this.jacobian[2]*this.B[2]+this.jacobian[3]*this.B[3]+this.jacobian[4]*this.B[4]+this.jacobian[5]*this.B[5]+this.jacobian[6]*this.B[6]+this.jacobian[7]*this.B[7]+this.jacobian[8]*this.B[8]+this.jacobian[9]*this.B[9]+this.jacobian[10]*this.B[10]+this.jacobian[11]*this.B[11]},e.ConstraintRow.prototype.computeEta=function(t,i){var e,s=1/i;t.object_a_is_dynamic()?(e=t.object_a._mass_inverted,this.eta_row[0]=t.object_a.linear_factor.x*(t.object_a.linear_velocity.x+e*t.object_a.accumulated_force.x)*s,this.eta_row[1]=t.object_a.linear_factor.y*(t.object_a.linear_velocity.y+e*t.object_a.accumulated_force.y)*s,this.eta_row[2]=t.object_a.linear_factor.z*(t.object_a.linear_velocity.z+e*t.object_a.accumulated_force.z)*s,o.copy(t.object_a.accumulated_torque),t.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),this.eta_row[3]=t.object_a.angular_factor.x*(t.object_a.angular_velocity.x+o.x)*s,this.eta_row[4]=t.object_a.angular_factor.y*(t.object_a.angular_velocity.y+o.y)*s,this.eta_row[5]=t.object_a.angular_factor.z*(t.object_a.angular_velocity.z+o.z)*s):this.eta_row[0]=this.eta_row[1]=this.eta_row[2]=this.eta_row[3]=this.eta_row[4]=this.eta_row[5]=0,t.object_b_is_dynamic()?(e=t.object_b._mass_inverted,this.eta_row[6]=t.object_b.linear_factor.x*(t.object_b.linear_velocity.x+e*t.object_b.accumulated_force.x)*s,this.eta_row[7]=t.object_b.linear_factor.y*(t.object_b.linear_velocity.y+e*t.object_b.accumulated_force.y)*s,this.eta_row[8]=t.object_b.linear_factor.z*(t.object_b.linear_velocity.z+e*t.object_b.accumulated_force.z)*s,o.copy(t.object_b.accumulated_torque),t.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),this.eta_row[9]=t.object_b.angular_factor.x*(t.object_b.angular_velocity.x+o.x)*s,this.eta_row[10]=t.object_b.angular_factor.y*(t.object_b.angular_velocity.y+o.y)*s,this.eta_row[11]=t.object_b.angular_factor.z*(t.object_b.angular_velocity.z+o.z)*s):this.eta_row[6]=this.eta_row[7]=this.eta_row[8]=this.eta_row[9]=this.eta_row[10]=this.eta_row[11]=0;var a=this.jacobian[0]*this.eta_row[0]+this.jacobian[1]*this.eta_row[1]+this.jacobian[2]*this.eta_row[2]+this.jacobian[3]*this.eta_row[3]+this.jacobian[4]*this.eta_row[4]+this.jacobian[5]*this.eta_row[5]+this.jacobian[6]*this.eta_row[6]+this.jacobian[7]*this.eta_row[7]+this.jacobian[8]*this.eta_row[8]+this.jacobian[9]*this.eta_row[9]+this.jacobian[10]*this.eta_row[10]+this.jacobian[11]*this.eta_row[11];this.eta=this.bias*s-a;var n=(t.object_a_is_dynamic()?t.object_a._mass:0)+(t.object_b_is_dynamic()?t.object_b._mass:0);this.eta=this.eta/(1+this.cfm*n)},e.ContactConstraint=function(){e.Constraint.call(this),this.contact=null},e.ContactConstraint.prototype=Object.create(e.Constraint.prototype),e.ContactConstraint.prototype.buildFromContact=function(t){this.object_a=t.object_a,this.object_b=t.object_b,this.contact=t;var i=this,o=function(){this.removeListener("destroy",o),i.deactivate()};this.contact.addListener("destroy",o);var s=this.rows[0]||e.ObjectPool.getObject("ConstraintRow");s.lower_limit=0,s.upper_limit=1/0,this.rows[0]=s,this.update()},e.ContactConstraint.prototype.update=function(){var t=this.rows[0];this.object_a_is_dynamic()?(t.jacobian[0]=-this.contact.contact_normal.x,t.jacobian[1]=-this.contact.contact_normal.y,t.jacobian[2]=-this.contact.contact_normal.z,o.subtractVectors(this.contact.contact_point,this.contact.object_a.position),o.cross(this.contact.contact_normal),t.jacobian[3]=-o.x,t.jacobian[4]=-o.y,t.jacobian[5]=-o.z):(t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=0,t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=0),this.object_b_is_dynamic()?(t.jacobian[6]=this.contact.contact_normal.x,t.jacobian[7]=this.contact.contact_normal.y,t.jacobian[8]=this.contact.contact_normal.z,o.subtractVectors(this.contact.contact_point,this.contact.object_b.position),o.cross(this.contact.contact_normal),t.jacobian[9]=o.x,t.jacobian[10]=o.y,t.jacobian[11]=o.z):(t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=0,t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0),t.bias=0;var i=0;this.object_a_is_dynamic()&&(this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,o),i+=o.dot(this.contact.contact_normal)),this.object_b_is_dynamic()&&(this.object_b.getVelocityInLocalPoint(this.contact.contact_point_in_b,o),i-=o.dot(this.contact.contact_normal)),t.bias+=i*this.contact.restitution},e.FrictionConstraint=function(){e.Constraint.call(this),this.contact=null},e.FrictionConstraint.prototype=Object.create(e.Constraint.prototype),e.FrictionConstraint.prototype.buildFromContact=function(t){this.rows[0]=this.rows[0]||e.ObjectPool.getObject("ConstraintRow"),this.rows[1]=this.rows[1]||e.ObjectPool.getObject("ConstraintRow"),this.object_a=t.object_a,this.object_b=t.object_b,this.contact=t;var i=this,o=function(){this.removeListener("destroy",o),i.deactivate()};this.contact.addListener("destroy",o),this.update()},e.FrictionConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,s=new e.Vector3,a=new e.Vector3;return function(){var e=this.rows[0],n=this.rows[1];t.subtractVectors(this.contact.contact_point,this.object_a.position),i.subtractVectors(this.contact.contact_point,this.object_b.position),this.contact.contact_normal.findOrthogonal(s,a),this.object_a_is_dynamic()?(e.jacobian[0]=-s.x,e.jacobian[1]=-s.y,e.jacobian[2]=-s.z,o.crossVectors(t,s),e.jacobian[3]=-o.x,e.jacobian[4]=-o.y,e.jacobian[5]=-o.z,n.jacobian[0]=-a.x,n.jacobian[1]=-a.y,n.jacobian[2]=-a.z,o.crossVectors(t,a),n.jacobian[3]=-o.x,n.jacobian[4]=-o.y,n.jacobian[5]=-o.z):(e.jacobian[0]=e.jacobian[1]=e.jacobian[2]=0,e.jacobian[3]=e.jacobian[4]=e.jacobian[5]=0,n.jacobian[0]=n.jacobian[1]=n.jacobian[2]=0,n.jacobian[3]=n.jacobian[4]=n.jacobian[5]=0),this.object_b_is_dynamic()?(e.jacobian[6]=s.x,e.jacobian[7]=s.y,e.jacobian[8]=s.z,o.crossVectors(i,s),e.jacobian[9]=o.x,e.jacobian[10]=o.y,e.jacobian[11]=o.z,n.jacobian[6]=a.x,n.jacobian[7]=a.y,n.jacobian[8]=a.z,o.crossVectors(i,a),n.jacobian[9]=o.x,n.jacobian[10]=o.y,n.jacobian[11]=o.z):(e.jacobian[6]=e.jacobian[7]=e.jacobian[8]=0,e.jacobian[9]=e.jacobian[10]=e.jacobian[11]=0,n.jacobian[6]=n.jacobian[7]=n.jacobian[8]=0,n.jacobian[9]=n.jacobian[10]=n.jacobian[11]=0);var r=this.contact.friction;this.object_a_is_dynamic()&&(r*=this.object_a._mass),this.object_b_is_dynamic()&&(r*=this.object_b._mass),0>r&&(r=0),e.lower_limit=n.lower_limit=-r,e.upper_limit=n.upper_limit=r,e.bias=n.bias=0,this.rows[0]=e,this.rows[1]=n}}(),e.HingeConstraint=function(t,i,o,s,a){e.Constraint.call(this),this.object_a=t,this.hinge_a=i,this.point_a=o,this.initial_quaternion=new e.Quaternion,this.object_b=s||null,this.point_b=new e.Vector3,this.hinge_b=new e.Vector3,null!=this.object_b?(this.object_a.rotation.transformVector3Into(this.hinge_a,this.hinge_b),r.invertQuaternion(this.object_b.rotation),r.transformVector3(this.hinge_b),this.point_b=a,this.initial_quaternion.multiplyQuaternions(r,this.object_a.rotation)):(this.object_a.updateDerived(),this.object_a.rotation.transformVector3Into(this.hinge_a,this.hinge_b),this.object_a.transform.transformVector3Into(this.point_a,this.point_b),this.initial_quaternion.set(this.object_a.rotation.x,this.object_a.rotation.y,this.object_a.rotation.z,this.object_a.rotation.w)),this.erp=.1;for(var n=0;5>n;n++)this.rows[n]=e.ConstraintRow.createConstraintRow()},e.HingeConstraint.prototype=Object.create(e.Constraint.prototype),e.HingeConstraint.prototype.updateLimits=function(i,e){if(this.limit.enabled===!1)return void t(this);var o,s;return null==this.object_b?o=this.initial_quaternion.signedAngleBetween(this.object_a.rotation,i):(r.invertQuaternion(this.object_b.rotation),r.multiply(this.object_a.rotation),o=this.initial_quaternion.signedAngleBetween(r,i)),(null==this.limit.limit_lower||this.limit.limit_lower<o)&&(null==this.limit.limit_upper||this.limit.limit_upper>o)?void t(this):void(null!=this.limit.limit_lower&&o<=this.limit.limit_lower?(null==this.limit.constraint_row&&(this.limit.createConstraintRow(),this.limit.constraint_row.upper_limit=0,this.rows.push(this.limit.constraint_row)),this.limit.constraint_row.jacobian[3]=-i.x,this.limit.constraint_row.jacobian[4]=-i.y,this.limit.constraint_row.jacobian[5]=-i.z,null!=this.object_b&&(this.limit.constraint_row.jacobian[9]=i.x,this.limit.constraint_row.jacobian[10]=i.y,this.limit.constraint_row.jacobian[11]=i.z),s=o-this.limit.limit_lower,this.limit.constraint_row.bias=s*this.limit.erp/e):null!=this.limit.limit_upper&&o>=this.limit.limit_upper&&(null==this.limit.constraint_row&&(this.limit.createConstraintRow(),this.limit.constraint_row.lower_limit=0,this.rows.push(this.limit.constraint_row)),this.limit.constraint_row.jacobian[3]=-i.x,this.limit.constraint_row.jacobian[4]=-i.y,this.limit.constraint_row.jacobian[5]=-i.z,null!=this.object_b&&(this.limit.constraint_row.jacobian[9]=i.x,this.limit.constraint_row.jacobian[10]=i.y,this.limit.constraint_row.jacobian[11]=i.z),s=o-this.limit.limit_upper,this.limit.constraint_row.bias=s*this.limit.erp/e))},e.HingeConstraint.prototype.updateMotor=function(t){return this.motor.enabled===!1?void i(this):(null==this.motor.constraint_row&&(this.motor.createConstraintRow(),this.rows.push(this.motor.constraint_row),this.motor.constraint_row.jacobian[3]=t.x,this.motor.constraint_row.jacobian[4]=t.y,this.motor.constraint_row.jacobian[5]=t.z,null!=this.object_b&&(this.motor.constraint_row.jacobian[9]=-t.x,this.motor.constraint_row.jacobian[10]=-t.y,this.motor.constraint_row.jacobian[11]=-t.z)),this.motor.constraint_row.bias=this.motor.max_speed,void(this.motor.max_speed>=0?(this.motor.constraint_row.lower_limit=0,this.motor.constraint_row.upper_limit=this.motor.torque):(this.motor.constraint_row.lower_limit=-this.motor.torque,this.motor.constraint_row.upper_limit=0)))},e.HingeConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,n=new e.Vector3,r=new e.Vector3,h=new e.Vector3;return function(e){this.object_a.rotation.transformVector3Into(this.hinge_a,h),this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,h.findOrthogonal(n,r),this.rows[3].jacobian[3]=-n.x,this.rows[3].jacobian[4]=-n.y,this.rows[3].jacobian[5]=-n.z,this.rows[4].jacobian[3]=-r.x,this.rows[4].jacobian[4]=-r.y,this.rows[4].jacobian[5]=-r.z,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,s),i.subtractVectors(s,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.z,this.rows[2].jacobian[11]=0,this.rows[3].jacobian[9]=n.x,this.rows[3].jacobian[10]=n.y,this.rows[3].jacobian[11]=n.z,this.rows[4].jacobian[9]=r.x,this.rows[4].jacobian[10]=r.y,this.rows[4].jacobian[11]=r.z):s.copy(this.point_b),a.subtractVectors(o,s),a.scale(this.erp/e),this.rows[0].bias=a.x,this.rows[1].bias=a.y,this.rows[2].bias=a.z,null!=this.object_b?(this.object_a.rotation.transformVector3Into(this.hinge_a,o),this.object_b.rotation.transformVector3Into(this.hinge_b,s),o.cross(s),this.rows[3].bias=-o.dot(n)*this.erp/e,this.rows[4].bias=-o.dot(r)*this.erp/e):this.rows[3].bias=this.rows[4].bias=0,this.updateLimits(h,e),this.updateMotor(h)}}(),e.PointConstraint=function(t,i,o,s){e.Constraint.call(this),this.object_a=t,this.point_a=i,this.object_b=o||null,null!=this.object_b?this.point_b=s:(this.point_b=new e.Vector3,this.object_a.updateDerived(),this.object_a.transform.transformVector3Into(this.point_a,this.point_b)),this.erp=.1;for(var a=0;3>a;a++)this.rows[a]=e.ObjectPool.getObject("ConstraintRow"),this.rows[a].lower_limit=-(1/0),this.rows[a].upper_limit=1/0,this.rows[a].bias=0,this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=0},e.PointConstraint.prototype=Object.create(e.Constraint.prototype),e.PointConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3;return function(e){this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,s),i.subtractVectors(s,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.x,this.rows[2].jacobian[11]=0):s.copy(this.point_b),a.subtractVectors(o,s),a.scale(this.erp/e),this.rows[0].bias=a.x,this.rows[1].bias=a.y,this.rows[2].bias=a.z}}(),e.SliderConstraint=function(t,i,o){e.Constraint.call(this),this.object_a=t,this.axis=i,this.object_b=o,this.position_error=new e.Vector3,this.position_error.subtractVectors(this.object_b.position,this.object_a.position),r.invertQuaternion(this.object_a.rotation),r.transformVector3(this.position_error),this.rotation_difference=new e.Quaternion,null!=this.object_b&&(r.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(r,this.object_a.rotation)),this.erp=.1;for(var s=0;5>s;s++)this.rows[s]=e.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-(1/0),this.rows[s].upper_limit=1/0,this.rows[s].bias=0,this.rows[s].jacobian[0]=this.rows[s].jacobian[1]=this.rows[s].jacobian[2]=this.rows[s].jacobian[3]=this.rows[s].jacobian[4]=this.rows[s].jacobian[5]=this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=0},e.SliderConstraint.prototype=Object.create(e.Constraint.prototype),e.SliderConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e){this.object_a.rotation.transformVector3Into(this.axis,t),t.findOrthogonal(i,o),this._updateLinearConstraints(e,i,o),this._updateAngularConstraints(e,i,o)}}(),e.SliderConstraint.prototype._updateLinearConstraints=function(t,i,a){var n=new e.Vector3;n.subtractVectors(this.object_b.position,this.object_a.position);var r=new e.Vector3;r.crossVectors(n,i),this.rows[0].jacobian[0]=-i.x,this.rows[0].jacobian[1]=-i.y,this.rows[0].jacobian[2]=-i.z,this.rows[0].jacobian[6]=i.x,this.rows[0].jacobian[7]=i.y,this.rows[0].jacobian[8]=i.z,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=0,this.rows[0].jacobian[11]=0,r.crossVectors(n,a),this.rows[1].jacobian[0]=-a.x,this.rows[1].jacobian[1]=-a.y,this.rows[1].jacobian[2]=-a.z,this.rows[1].jacobian[6]=a.x,this.rows[1].jacobian[7]=a.y,this.rows[1].jacobian[8]=a.z,this.rows[1].jacobian[9]=0,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=0,this.object_a.rotation.transformVector3Into(this.position_error,o),
s.subtractVectors(n,o),s.scale(this.erp/t),this.rows[0].bias=-i.dot(s),this.rows[1].bias=-a.dot(s)},e.SliderConstraint.prototype._updateAngularConstraints=function(t,i,o,s){this.rows[2].jacobian[3]=this.rows[3].jacobian[4]=this.rows[4].jacobian[5]=-1,this.rows[2].jacobian[9]=this.rows[3].jacobian[10]=this.rows[4].jacobian[11]=1,r.invertQuaternion(this.object_b.rotation),r.multiply(this.object_a.rotation),h.invertQuaternion(this.rotation_difference),h.multiply(r);var a=new e.Vector3;a.x=h.x,a.y=h.y,a.z=h.z,a.scale(this.erp/t)},e.WeldConstraint=function(t,i,o,s){e.Constraint.call(this),this.object_a=t,this.point_a=i,this.object_b=o||null,this.point_b=s||null,this.rotation_difference=new e.Quaternion,null!=this.object_b&&(r.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(r,this.object_a.rotation)),this.erp=.1;for(var a=0;3>a;a++)this.rows[a]=e.ObjectPool.getObject("ConstraintRow"),this.rows[a].lower_limit=-(1/0),this.rows[a].upper_limit=1/0,this.rows[a].bias=0,null==this.object_b&&(this.rows[a].jacobian[0]=this.rows[a].jacobian[1]=this.rows[a].jacobian[2]=this.rows[a].jacobian[4]=this.rows[a].jacobian[5]=this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=this.rows[a].jacobian[12]=0,this.rows[a].jacobian[a]=1);for(a=3;6>a;a++)this.rows[a]=e.ObjectPool.getObject("ConstraintRow"),this.rows[a].lower_limit=-(1/0),this.rows[a].upper_limit=1/0,this.rows[a].bias=0,null==this.object_b?(this.rows[a].jacobian[0]=this.rows[a].jacobian[1]=this.rows[a].jacobian[2]=this.rows[a].jacobian[4]=this.rows[a].jacobian[5]=this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=this.rows[a].jacobian[12]=0,this.rows[a].jacobian[a]=1):(this.rows[a].jacobian[0]=this.rows[a].jacobian[1]=this.rows[a].jacobian[2]=0,this.rows[a].jacobian[3]=this.rows[a].jacobian[4]=this.rows[a].jacobian[5]=0,this.rows[a].jacobian[a]=-1,this.rows[a].jacobian[6]=this.rows[a].jacobian[7]=this.rows[a].jacobian[8]=0,this.rows[a].jacobian[9]=this.rows[a].jacobian[10]=this.rows[a].jacobian[11]=0,this.rows[a].jacobian[a+6]=1)},e.WeldConstraint.prototype=Object.create(e.Constraint.prototype),e.WeldConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3;return function(a){if(null!=this.object_b){this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,s),i.subtractVectors(s,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.x,this.rows[2].jacobian[11]=0):s.copy(this.point_b);var n=new e.Vector3;n.subtractVectors(o,s),n.scale(this.erp/a),this.rows[0].bias=n.x,this.rows[1].bias=n.y,this.rows[2].bias=n.z,r.invertQuaternion(this.object_b.rotation),r.multiply(this.object_a.rotation),h.invertQuaternion(this.rotation_difference),h.multiply(r),n.x=h.x,n.y=h.y,n.z=h.z,n.scale(this.erp/a),this.rows[3].bias=n.x,this.rows[4].bias=n.y,this.rows[5].bias=n.z}}}(),e.DragForce=function(t,i){this.drag_coefficient=t||0,this.squared_drag_coefficient=i||0,this.enabled=!0,this.affected=[]},e.DragForce.prototype.enable=e.ForceGenerator.prototype.enable,e.DragForce.prototype.disable=e.ForceGenerator.prototype.disable,e.DragForce.prototype.affect=e.ForceGenerator.prototype.affect,e.DragForce.prototype.unaffect=e.ForceGenerator.prototype.unaffect,e.DragForce.prototype.applyForce=function(){if(this.enabled){var t,i,e,s,a=o;for(t=0,i=this.affected.length;i>t;t++)e=this.affected[t],a.copy(e.linear_velocity),s=a.length(),s=this.drag_coefficient*s+this.squared_drag_coefficient*s*s,a.normalize(),a.scale(-s),e.applyForce(a)}},e.RayIntersection=function(){this.object=null,this.shape=null,this.point=new e.Vector3,this.t=null,this.normal=new e.Vector3},e.BoxShape=function(t,i,o,s){this.half_width=t,this.half_height=i,this.half_depth=o,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=s||null},e.BoxShape.prototype.calculateLocalAABB=function(t){t.min.x=-this.half_width,t.min.y=-this.half_height,t.min.z=-this.half_depth,t.max.x=this.half_width,t.max.y=this.half_height,t.max.z=this.half_depth},e.BoxShape.prototype.getInertiaTensor=function(t){var i=this.half_height*this.half_height*4,o=this.half_width*this.half_width*4,s=this.half_depth*this.half_depth*4,a=.0833*t;return new e.Matrix3(a*(i+s),0,0,0,a*(o+s),0,0,0,a*(i+o))},e.BoxShape.prototype.findSupportPoint=function(t,i){i.x=Math.sign(t.x)*this.half_width,i.y=Math.sign(t.y)*this.half_height,i.z=Math.sign(t.z)*this.half_depth},e.BoxShape.prototype.rayIntersect=function(){var t,i,o,s,a,n,r,h=new e.Vector3;return function(c,l){t=0,h.subtractVectors(l,c),i=h.length(),h.scale(1/i);for(var p=0;3>p;p++){if(o=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,Math.abs(h[o])<e.EPSILON&&(c[o]<-r||c[o]>r))return null;if(s=1/h[o],a=(-r-c[o])*s,n=(r-c[o])*s,a>n&&(s=a,a=n,n=s),t=Math.max(t,a),i=Math.min(i,n),t>i)return null}var _=e.ObjectPool.getObject("RayIntersection");_.object=this,_.t=t,_.point.scaleVector(h,t),_.point.add(c);var u=1/0;for(p=0;3>p;p++)o=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,r-Math.abs(_.point[o])<u&&(_.normal.x=_.normal.y=_.normal.z=0,_.normal[o]=_.point[o]<0?-1:1,u=r-Math.abs(_.point[o]));return _}}(),e.CapsuleShape=function(t,i,o){this.radius=t,this.half_height=Math.abs(i),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=o||null},e.CapsuleShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height-this.radius,t.max.x=t.max.z=this.radius,t.max.y=this.half_height+this.radius},e.CapsuleShape.prototype.getInertiaTensor=function(t){if(-e.EPSILON<=this.half_height&&this.half_height<=e.EPSILON){if(-e.EPSILON<=this.radius&&this.radius<=e.EPSILON)return new e.Matrix3;var i=.4*t*this.radius*this.radius;return new e.Matrix3(i,0,0,0,i,0,0,0,i)}var o=1.5*this.half_height/this.radius,s=t/(1+o),a=t/(1+1/o),n=this.radius*this.radius,r=.4*s*n,h=.0833*a*(3*n+4*this.half_height*this.half_height),c=r+h+s*(3*this.radius+4*this.half_height)*this.half_height/4;return new e.Matrix3(c,0,0,0,r+.5*a*n,0,0,0,c)},e.CapsuleShape.prototype.findSupportPoint=function(){var t=new e.Vector3;return function(i,e){t.normalizeVector(i),e.scaleVector(t,this.radius),e.y+=Math.sign(i.y)*this.half_height}}(),e.CapsuleShape.prototype.rayIntersect=function(){function t(t,i,o,s){var a=e.ObjectPool.getObject("RayIntersection");return a.object=this,a.point.set(t,i,o),a.t=s,a}function i(t,i){var o=e.ObjectPool.getObject("RayIntersection");return o.object=this,o.point.scaleVector(y,i),o.point.add(t),o.t=i,o}var o,s,a,n,r,h,c,l,p,_,u,b,f,d,m,y=new e.Vector3;return function(j,w){if(y.subtractVectors(w,j),o=y.length(),y.scale(1/o),a=y.x*y.x+y.z*y.z,n=j.x*j.x+j.z*j.z-this.radius*this.radius,a<=e.EPSILON)if(-e.EPSILON<=n&&n<=e.EPSILON)if(j.y>this.half_height){if(w.y>this.half_height)return null;m=t(j.x,this.half_height,j.z,j.y-this.half_height)}else if(j.y<-this.half_height){if(w.y<-this.half_height)return null;m=t(j.x,-this.half_height,j.z,-j.y-this.half_height)}else if(w.y>=this.half_height)m=t(j.x,this.half_height,j.z,this.half_height-j.y);else{if(!(w.y<=-this.half_height))return null;m=t(j.x,-this.half_height,j.z,j.y+this.half_height)}else{if(n>0)return null;if(r=this.half_height+Math.sqrt(-n),j.y>r){if(w.y>r)return null;m=t(j.x,r,j.z,j.y-r)}else if(j.y<-r){if(w.y<-r)return null;m=t(j.x,-r,j.z,-r-j.y)}else if(w.y>=r)m=t(j.x,r,j.z,r-j.y);else{if(!(w.y<=-r))return null;m=t(j.x,-r,j.z,j.y+r)}}else{if(s=j.x*y.x+j.z*y.z,h=s*s-a*n,-e.EPSILON<=h&&h<=e.EPSILON){if(u=-s/a,l=j.y+u*y.y,!(-this.half_height<=l&&l<=this.half_height))return null;m=i(j,u)}else if(0>h)return null;if(c=Math.sqrt(h),b=(-s+c)/a,0>b)return null;if(u=(-s-c)/a,l=j.y+u*y.y,l>this.half_height){if(a+=y.y*y.y,n+=j.y*j.y+this.half_height*(this.half_height-2*j.y),s+=y.y*(j.y-this.half_height),h=s*s-a*n,0>=h)return null;if(c=Math.sqrt(h),f=(-s-c)/a,f>=0)m=i(j,f);else if(d=(-s+c)/a,_=j.y+d*y.y,_>this.half_height)m=i(j,d);else if(p=j.y+b*y.y,p<-this.half_height){if(n+=4*this.half_height*j.y,s+=2*y.y*this.half_height,h=s*s-a*n,0>h)return null;if(c=Math.sqrt(h),d=(-s+c)/a,0>d)return null;m=i(j,d)}else m=i(j,b)}else if(l<-this.half_height){if(a+=y.y*y.y,n+=j.y*j.y+this.half_height*(this.half_height+2*j.y),s+=y.y*(j.y+this.half_height),h=s*s-a*n,0>h)return null;if(c=Math.sqrt(h),f=(-s-c)/a,f>=0)m=i(j,f);else if(d=(-s+c)/a,_=j.y+d*y.y,_<-this.half_height)m=i(j,d);else if(p=j.y+b*y.y,p>this.half_height){if(n-=4*this.half_height*j.y,s-=2*y.y*this.half_height,h=s*s-a*n,0>=h)return null;if(c=Math.sqrt(h),d=(-s+c)/a,0>d)return null;m=i(j,d)}else m=i(j,b)}else if(u>=0)m=i(j,u);else if(p=j.y+b*y.y,p>this.half_height){if(a+=y.y*y.y,n+=j.y*j.y+this.half_height*(this.half_height-2*j.y),s+=y.y*(j.y-this.half_height),h=s*s-a*n,0>h)return null;if(c=Math.sqrt(h),d=(-s+c)/a,0>d)return null;m=i(j,d)}else if(p<-this.half_height){if(a+=y.y*y.y,n+=j.y*j.y+this.half_height*(this.half_height+2*j.y),s+=y.y*(j.y+this.half_height),h=s*s-a*n,0>h)return null;if(c=Math.sqrt(h),d=(-s+c)/a,0>d)return null;m=i(j,d)}else m=i(j,b)}return m.normal.x=m.point.x,m.normal.z=m.point.z,m.normal.y=m.point.y<-this.half_height?m.point.y+this.half_height:m.point.y>this.half_height?m.point.y-this.half_height:0,m.normal.scale(1/this.radius),m}}(),e.CompoundShape=function(){this.child_shapes=[],this.aabb=new e.AABB,this.center_of_mass=new e.Vector3,this.center_of_mass_override=null,this.updateAABB()},e.CompoundShape.prototype.addChildShape=function(t,i,o){this.child_shapes.push(new e.CompoundShapeChild(t,i,o)),this.updateCenterOfMass(),this.updateAABB()},e.CompoundShape.prototype.removeChildShape=function(t){for(var i=0;i<this.child_shapes.length;i++)if(this.child_shapes[i].shape===t){this.child_shapes[i]=this.child_shapes[0],this.child_shapes.shift();break}this.updateCenterOfMass(),this.updateAABB()},e.CompoundShape.prototype.updateAABB=function(){this.calculateLocalAABB(this.aabb)},e.CompoundShape.prototype.updateCenterOfMass=function(){var t;if(this.center_of_mass_override)this.center_of_mass.copy(this.center_of_mass_override);else{for(this.center_of_mass.set(0,0,0),t=0;t<this.child_shapes.length;t++)this.center_of_mass.add(this.child_shapes[t].local_position);this.child_shapes.length>0&&this.center_of_mass.scale(1/this.child_shapes.length)}for(t=0;t<this.child_shapes.length;t++)this.child_shapes[t].center_of_mass.copy(this.center_of_mass),this.child_shapes[t].updateDerived()},e.CompoundShape.prototype.calculateLocalAABB=function(t){if(0===this.child_shapes.length)return void(t.min.x=t.min.y=t.min.z=t.max.x=t.max.y=t.max.z=0);t.min.x=t.min.y=t.min.z=1/0,t.max.x=t.max.y=t.max.z=-(1/0);var i,e;for(i=0;i<this.child_shapes.length;i++)e=this.child_shapes[i],t.min.x=Math.min(t.min.x,e.aabb.min.x),t.min.y=Math.min(t.min.y,e.aabb.min.y),t.min.z=Math.min(t.min.z,e.aabb.min.z),t.max.x=Math.max(t.max.x,e.aabb.max.x),t.max.y=Math.max(t.max.y,e.aabb.max.y),t.max.z=Math.max(t.max.z,e.aabb.max.z)},e.CompoundShape.prototype.computeSteiner=function(t,i,e){e.e00=i*-(t.y*t.y+t.z*t.z),e.e10=i*t.x*t.y,e.e20=i*t.x*t.z,e.e01=i*t.x*t.y,e.e11=i*-(t.x*t.x+t.z*t.z),e.e21=i*t.y*t.z,e.e02=i*t.x*t.z,e.e12=i*t.y*t.z,e.e22=i*-(t.x*t.x+t.y*t.y)},e.CompoundShape.prototype.getInertiaTensor=function(t){var i,s,a,n=new e.Matrix3,r=new e.Matrix3;if(0===this.child_shapes.length||t===1/0)return n.e00=n.e11=n.e22=t,n;var h=t/this.child_shapes.length;for(o.copy(this.center_of_mass),i=0;i<this.child_shapes.length;i++)s=this.child_shapes[i],o.subtract(s.local_position),this.computeSteiner(o,h,r),c.fromMatrix4(s.transform),a=s.shape.getInertiaTensor(h),c.transposeInto(l),c.multiply(a),c.multiply(l),n.e00+=c.e00-r.e00,n.e10+=c.e10-r.e10,n.e20+=c.e20-r.e20,n.e01+=c.e01-r.e01,n.e11+=c.e11-r.e11,n.e21+=c.e21-r.e21,n.e02+=c.e02-r.e02,n.e12+=c.e12-r.e12,n.e22+=c.e22-r.e22,o.copy(s.local_position);return o.subtract(this.center_of_mass),this.computeSteiner(o,h,r),n.e00+=-r.e00,n.e10+=-r.e10,n.e20+=-r.e20,n.e01+=-r.e01,n.e11+=-r.e11,n.e21+=-r.e21,n.e02+=-r.e02,n.e12+=-r.e12,n.e22+=-r.e22,n},e.CompoundShape.prototype.rayIntersect=function(t,i,o){var s,a,n,r=[],h=new e.Vector3,c=new e.Vector3;for(a=0;a<this.child_shapes.length&&(n=this.child_shapes[a],n.transform_inverse.transformVector3Into(t,h),n.transform_inverse.transformVector3Into(i,c),s=n.shape.rayIntersect(h,c),null!=s&&(s.shape=n.shape,n.transform.transformVector3(s.point),r.push(s)),!(r.length>=o));a++);return r},e.CompoundShapeChild=function(t,i,o){this.shape=t,this.local_position=new e.Vector3(i.x,i.y,i.z),this.center_of_mass=new e.Vector3,this.position=new e.Vector3,this.rotation=new e.Quaternion(o.x,o.y,o.z,o.w),this.transform=new e.Matrix4,this.transform_inverse=new e.Matrix4,this.aabb=new e.AABB,this.updateDerived()},e.CompoundShapeChild.prototype.updateDerived=function(){this.position.copy(this.local_position),this.position.subtract(this.center_of_mass),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform)},e.ConeShape=function(t,i){this.radius=t,this.half_height=i,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this._sinangle=this.radius/Math.sqrt(this.radius*this.radius+Math.pow(2*this.half_height,2)),this._cosangle=Math.cos(Math.asin(this._sinangle))},e.ConeShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height,t.max.x=t.max.z=this.radius,t.max.y=this.half_height},e.ConeShape.prototype.getInertiaTensor=function(t){var i=.1*t*Math.pow(2*this.half_height,2)+.15*t*this.radius*this.radius;return new e.Matrix3(i,0,0,0,.3*t*this.radius*this.radius,0,0,0,i)},e.ConeShape.prototype.findSupportPoint=function(t,i){var e=Math.sqrt(t.x*t.x+t.z*t.z);if(t.y>t.length()*this._sinangle)i.x=i.z=0,i.y=this.half_height;else if(e>0){var o=this.radius/e;i.x=o*t.x,i.y=-this.half_height,i.z=o*t.z}else i.x=i.z=0,i.y=-this.half_height},e.ConeShape.prototype.rayIntersect=function(){var t,i=new e.Vector3,o=new e.Vector3,s=new e.Vector3,a=new e.Vector3,n=new e.Vector3;return function(r,h){i.subtractVectors(h,r),t=i.length(),i.scale(1/t);var c,l;o.x=o.y=o.z=0,c=this._rayIntersectBase(r,h,o,a),s.x=s.y=s.z=0,l=this._rayIntersectCone(r,i,t,s,n);var p;return c||l?!l||c&&l>c?(p=e.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=c,p.point.copy(o),p.normal.copy(a),p):!c||l&&c>l?(p=e.ObjectPool.getObject("RayIntersection"),p.object=this,p.t=l,p.point.copy(s),p.normal.copy(n),p):null:null}}(),e.ConeShape.prototype._rayIntersectBase=function(){var t,i=new e.Vector3(0,-1,0),o=new e.Vector3,s=new e.Vector3,a=new e.Vector3;return function(e,n,r,h){return s.x=e.x,s.y=e.y+this.half_height,s.z=e.z,a.x=n.x,a.y=n.y+this.half_height,a.z=n.z,o.subtractVectors(a,s),t=-i.dot(s)/i.dot(o),0>t||t>1?null:(r.scaleVector(o,t),r.add(e),r.x*r.x+r.z*r.z>this.radius*this.radius?null:(h.x=h.z=0,h.y=-1,t*o.length()))}}(),e.ConeShape.prototype._rayIntersectCone=function(){var t=new e.Vector3;return function(i,s,a,n,r){var h=new e.Vector3(0,-1,0),c=h.dot(s),l=this._cosangle*this._cosangle,p=new e.Vector3;p.x=i.x,p.y=i.y-this.half_height,p.z=i.z;var _,u,b=h.dot(p),f=s.dot(p),d=p.dot(p),m=c*c-l,y=c*b-l*f,j=b*b-l*d,w=null;if(Math.abs(m)>=e.EPSILON){var x=y*y-j*m;if(x<-e.EPSILON)return null;if(x>e.EPSILON){var g=Math.sqrt(x),v=1/m;if(u=(-y-g)*v,u>=0&&a>=u&&(t.scaleVector(s,u),t.add(i),p.y=t.y-this.half_height,_=p.dot(h),_>=0&&(w=u,n.copy(t))),u=(-y+g)*v,u>=0&&a>=u&&(null==w||w>u)&&(t.scaleVector(s,u),t.add(i),p.y=t.y-this.half_height,_=p.dot(h),_>=0&&(w=u,n.copy(t))),null==w)return null;w/=a}else{if(u=-y/m,t.scaleVector(s,u),t.add(i),p.y=t.y-this.half_height,_=p.dot(h),0>_)return null;if(o.subtractVectors(t,i),o.lengthSquared()>a*a)return null;w=u/a,n.copy(t)}}else{if(!(Math.abs(y)>=e.EPSILON))return null;if(u=.5*j/y,t.scaleVector(s,u),t.add(i),p.y=t.y-this.half_height,_=p.dot(h),0>_)return null;w=u,n.copy(t)}return n.y<-this.half_height?null:(r.x=n.x,r.y=0,r.z=n.z,r.normalize(),r.x*=2*this.half_height/this.radius,r.y=this.radius/(2*this.half_height),r.z*=2*this.half_height/this.radius,r.normalize(),w*a)}}(),e.ConvexShape=function(t){this.vertices=[],this.faces=[],this.volume=0,this.center_of_mass=new e.Vector3,this._integral=new Float32Array(10),this.process(t),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb)},e.ConvexShape.prototype.process=function(t){for(var i=t.slice(),a=null,n=null,r=0;r<i.length;r++){var h=i[r];(null==a||a.x>h.x)&&(a=h),(null==n||n.x>h.x)&&(n=h)}a===n&&(n=t[0]===a?t[1]:t[0]);var c=a,l=n;i.splice(i.indexOf(c),1),i.splice(i.indexOf(l),1);var p,_,u=-(1/0),b=null;for(r=0;r<i.length;r++)p=i[r],_=e.GeometryMethods.findSquaredDistanceFromSegment(p,c,l),_>u&&(u=_,b=r);var f=i[b];for(i.splice(b,1),o.subtractVectors(l,c),s.subtractVectors(f,c),o.cross(s),u=-(1/0),b=null,r=0;r<i.length;r++)p=i[r],_=Math.abs(o.dot(p)),_>u&&(u=_,b=r);var d=i[b];if(i.splice(b,1),o.dot(d)>0){var m=c;c=f,f=m}var y=new e.GjkEpa.Polyhedron({points:[{point:f},{point:l},{point:c},{point:d}]});for(r=0;r<i.length;r++){y.closest_face=null;for(var j=0;j<y.faces.length;j++)if(y.faces[j].active===!0&&y.faces[j].classifyVertex({point:i[r]})>0){y.closest_face=j;break}null!=y.closest_face&&y.addVertex({point:i[r]})}this.faces=y.faces.filter(function(t){return t.active});var w=this;this.faces.forEach(function(t){var i=t.a.point,e=t.b.point,o=t.c.point,s=w.vertices.indexOf(i),a=w.vertices.indexOf(e),n=w.vertices.indexOf(o);-1===s&&w.vertices.push(i),-1===a&&w.vertices.push(e),-1===n&&w.vertices.push(o)}),this.computeVolume(this.faces)},e.ConvexShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=0,t.max.x=t.max.y=t.max.z=0;for(var i=0;i<this.vertices.length;i++)t.min.x=Math.min(t.min.x,this.vertices[i].x),t.min.y=Math.min(t.min.y,this.vertices[i].y),t.min.z=Math.min(t.min.z,this.vertices[i].z),t.max.x=Math.max(t.max.x,this.vertices[i].x),t.max.y=Math.max(t.max.y,this.vertices[i].y),t.max.z=Math.max(t.max.z,this.vertices[i].z)},e.ConvexShape.prototype.computeVolume=function(){var t={point:new e.Vector3},i=new Float32Array(6),o=function(t,e,o){var s=t+e,a=t*t,n=a+e*s;i[0]=s+o,i[1]=n+o*i[0],i[2]=t*a+e*n+o*i[1],i[3]=i[1]+t*(i[0]+t),i[4]=i[1]+e*(i[0]+e),i[5]=i[1]+o*(i[0]+o)};return function(e){for(var s=0;s<e.length;s++){var a=e[s],n=a.a.point,r=a.b.point,h=a.c.point,c=r.x-n.x,l=r.y-n.y,p=r.z-n.z,_=h.x-n.x,u=h.y-n.y,b=h.z-n.z,f=l*b-u*p,d=_*p-c*b,m=c*u-_*l;o(n.x,r.x,h.x);var y=i[0],j=i[1],w=i[2],x=i[3],g=i[4],v=i[5];o(n.y,r.y,h.y);var V=(i[0],i[1]),z=i[2],B=i[3],C=i[4],S=i[5];o(n.z,r.z,h.z);var P=(i[0],i[1]),M=i[2],O=i[3],I=i[4],A=i[5],T=a.classifyVertex(t)>0?-1:1;this._integral[0]+=T*f*y,this._integral[1]+=T*f*j,this._integral[2]+=T*d*V,this._integral[3]+=T*m*P,this._integral[4]+=T*f*w,this._integral[5]+=T*d*z,this._integral[6]+=T*m*M,this._integral[7]+=T*f*(n.y*x+r.y*g+h.y*v),this._integral[8]+=T*d*(n.z*B+r.z*C+h.z*S),this._integral[9]+=T*m*(n.x*O+r.x*I+h.x*A)}this._integral[0]*=1/6,this._integral[1]*=1/24,this._integral[2]*=1/24,this._integral[3]*=1/24,this._integral[4]*=1/60,this._integral[5]*=1/60,this._integral[6]*=1/60,this._integral[7]*=1/120,this._integral[8]*=1/120,this._integral[9]*=1/120,this.volume=this._integral[0],this.center_of_mass.x=this._integral[1]/this.volume,this.center_of_mass.y=this._integral[2]/this.volume,this.center_of_mass.z=this._integral[3]/this.volume}}(),e.ConvexShape.prototype.getInertiaTensor=function(){return function(t){var i=new e.Matrix3;return t/=this.volume,i.e00=(this._integral[5]+this._integral[6])*t,i.e11=(this._integral[4]+this._integral[6])*t,i.e22=(this._integral[4]+this._integral[5])*t,i.e10=i.e01=-this._integral[7]*t,i.e21=i.e12=-this._integral[8]*t,i.e20=i.e02=-this._integral[9]*t,i.e00-=t*(this.center_of_mass.y*this.center_of_mass.y+this.center_of_mass.z*this.center_of_mass.z),i.e11-=t*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.z*this.center_of_mass.z),i.e22-=t*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.y*this.center_of_mass.y),i.e10+=t*this.center_of_mass.x*this.center_of_mass.y,i.e01+=t*this.center_of_mass.x*this.center_of_mass.y,i.e21+=t*this.center_of_mass.y*this.center_of_mass.z,i.e12+=t*this.center_of_mass.y*this.center_of_mass.z,i.e20+=t*this.center_of_mass.x*this.center_of_mass.z,i.e02+=t*this.center_of_mass.x*this.center_of_mass.z,i}}(),e.ConvexShape.prototype.findSupportPoint=function(t,i){for(var e,o,s=-(1/0),a=0;a<this.vertices.length;a++)o=this.vertices[a].dot(t),o>s&&(s=o,e=a);i.copy(this.vertices[e])},e.ConvexShape.prototype.rayIntersect=function(){{var t,i,o=new e.Vector3,s=new e.Vector3,a=new e.Vector3,n=new e.Vector3,r=new e.Vector3,h=new e.Vector3;new e.Vector3,new e.Vector3}return function(c,l){t=0,o.subtractVectors(l,c),i=o.length(),o.scale(1/i);for(var p=0;p<this.faces.length;p++){var _=this.faces[p];s.subtractVectors(_.b.point,_.a.point),a.subtractVectors(_.c.point,_.a.point),n.crossVectors(o,a);var u=s.dot(n);if(!(u<e.EPSILON)){var b=1/u;r.subtractVectors(c,_.a.point);var f=b*r.dot(n);if(!(0>f)){h.crossVectors(r,s);var d=b*o.dot(h);if(!(0>d||f+d>1)){var m=b*a.dot(h);if(!(t>m||m>i)){var y=e.ObjectPool.getObject("RayIntersection");return y.object=this,y.t=m,y.point.scaleVector(o,m),y.point.add(c),y.normal.copy(_.normal),y}}}}}return null}}(),e.CylinderShape=function(t,i,o){this.radius=t,this.half_height=i,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=o||null},e.CylinderShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height,t.max.x=t.max.z=this.radius,t.max.y=this.half_height},e.CylinderShape.prototype.getInertiaTensor=function(t){var i=.0833*t*(3*this.radius*this.radius+(this.half_height+this.half_height)*(this.half_height+this.half_height));return new e.Matrix3(i,0,0,0,.5*t*this.radius*this.radius,0,0,0,i)},e.CylinderShape.prototype.findSupportPoint=function(t,i){if(i.y=t.y<0?-this.half_height:this.half_height,0===t.x&&0===t.z)i.x=i.z=0;else{var e=Math.sqrt(t.x*t.x+t.z*t.z),o=this.radius/e;i.x=o*t.x,i.z=o*t.z}},e.CylinderShape.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3;return function(o,s){t.y=this.half_height,i.y=-this.half_height;var a=new e.Vector3;a.subtractVectors(i,t);var n=new e.Vector3;n.subtractVectors(o,t);var r=new e.Vector3;r.subtractVectors(s,o);var h=n.dot(a),c=r.dot(a),l=a.dot(a);if(0>h&&0>h+c)return null;if(h>l&&h+c>l)return null;var p,_,u=r.dot(r),b=n.dot(r),f=l*u-c*c,d=n.dot(n)-this.radius*this.radius,m=l*d-h*h;if(Math.abs(f)<e.EPSILON){if(m>0)return null;p=0>h?-b/u:h>l?(c-b)/u:0}else{var y=l*b-c*h,j=y*y-f*m;if(0>j)return null;if(_=p=(-y-Math.sqrt(j))/f,0>h+p*c){if(0>=c)return null;if(p=-h/c,!(0>=d+p*(2*b+p*u)))return null;_=p}else if(h+p*c>l){if(c>=0)return null;if(p=(l-h)/c,!(0>=d+l-2*h+p*(2*(b-c)+p*u)))return null;_=p}if(p=_,0>p||p>1)return null}var w=e.ObjectPool.getObject("RayIntersection");return w.object=this,w.t=p*r.length(),w.point.scaleVector(r,p),w.point.add(o),Math.abs(w.point.y-this.half_height)<=e.EPSILON?(w.normal.x=w.normal.z=0,w.normal.y=w.point.y<0?-1:1):(w.normal.y=0,w.normal.x=w.point.x,w.normal.z=w.point.z,w.normal.scale(1/this.radius)),w}}(),e.MeshShape=function(t,i,o){this.vertices=t,this.triangles=[];for(var s=0;s<i.length;s+=3)this.triangles.push(new e.TriangleShape(t[i[s]],t[i[s+1]],t[i[s+2]]));this.volume=0,this.center_of_mass=new e.Vector3,this._integral=new Float32Array(10),this.hierarchy=new e.BVH(this.triangles).tree;var a=this.triangles.map(function(t){return new e.GjkEpa.Face(null,{point:t.a},{point:t.b},{point:t.c})});e.ConvexShape.prototype.computeVolume.call(this,a),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=o||null},e.MeshShape.prototype.clone=function(){var t=Object.create(e.MeshShape.prototype);return t.vertices=this.vertices,t.triangles=this.triangles,t.volume=this.volume,t.center_of_mass=this.center_of_mass,t._integral=this._integral,t.hierarchy=this.hierarchy,t.aabb=this.aabb,t.material=this.material,t},e.MeshShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=0,t.max.x=t.max.y=t.max.z=0;for(var i=0;i<this.vertices.length;i++)t.min.x=Math.min(t.min.x,this.vertices[i].x),t.min.y=Math.min(t.min.y,this.vertices[i].y),t.min.z=Math.min(t.min.z,this.vertices[i].z),t.max.x=Math.max(t.max.x,this.vertices[i].x),t.max.y=Math.max(t.max.y,this.vertices[i].y),t.max.z=Math.max(t.max.z,this.vertices[i].z)},e.MeshShape.prototype.getInertiaTensor=function(t){return e.ConvexShape.prototype.getInertiaTensor.call(this,t)},e.MeshShape.prototype.findSupportPoint=function(t,i){},e.MeshShape.prototype.rayIntersect=function(){var t=[],i=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};return function(e,o){var s,a=[this.hierarchy];t.length=0;for(var n=0;a.length>0;)if(n++,s=a.shift(),s.aabb.testRayIntersect(e,o))if(s.isLeaf()){var r=s.object.rayIntersect(e,o);null!=r&&t.push(r)}else a.push(s.left,s.right);return t.sort(i),t[0]||null}}(),e.PlaneShape=function(t,i,o){this.orientation=t,this.half_width=i,this.half_length=o,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},e.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min.x=0,t.min.y=-this.half_width,t.min.z=-this.half_length,t.max.x=0,t.max.y=this.half_width,t.max.z=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min.x=-this.half_width,t.min.y=0,t.min.z=-this.half_length,t.max.x=this.half_width,t.max.y=0,t.max.z=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min.x=-this.half_width,t.min.y=-this.half_length,t.min.z=0,t.max.x=this.half_width,t.max.y=this.half_length,t.max.z=0)},e.PlaneShape.prototype.getInertiaTensor=function(t){var i=this.half_width*this.half_width*4,o=this.half_length*this.half_length*4,s=.0833*t,a=s*o,n=s*(i+o),r=s*i;return 0===this.orientation?new e.Matrix3(n,0,0,0,a,0,0,0,r):1===this.orientation?new e.Matrix3(a,0,0,0,n,0,0,0,r):new e.Matrix3(n,0,0,0,r,0,0,0,a)},e.PlaneShape.prototype.findSupportPoint=function(t,i){i.x=t.x<0?-this._half_width:this._half_width,i.y=t.y<0?-this._half_height:this._half_height,i.z=t.z<0?-this._half_depth:this._half_depth},e.PlaneShape.prototype.rayIntersect=function(){var t,i=new e.Vector3,o=new e.Vector3,s=new e.Vector3;return function(a,n){if(0===this.orientation?(i.x=1,i.y=i.z=0):1===this.orientation?(i.y=1,i.x=i.z=0):(i.z=1,i.x=i.y=0),o.subtractVectors(n,a),t=-i.dot(a)/i.dot(o),0>t||t>1)return null;if(s.scaleVector(o,t),s.add(a),s.x<-this._half_width||s.x>this._half_width)return null;if(s.y<-this._half_height||s.y>this._half_height)return null;if(s.z<-this._half_depth||s.z>this._half_depth)return null;var r=e.ObjectPool.getObject("RayIntersection");return r.object=this,r.t=t*o.length(),r.point.copy(s),r.normal.copy(i),r}}(),e.SphereShape=function(t,i){this.radius=t,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=i||null},e.SphereShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=-this.radius,t.max.x=t.max.y=t.max.z=this.radius},e.SphereShape.prototype.getInertiaTensor=function(t){var i=.4*t*this.radius*this.radius;return new e.Matrix3(i,0,0,0,i,0,0,0,i)},e.SphereShape.prototype.findSupportPoint=function(){var t=new e.Vector3;return function(i,e){t.normalizeVector(i),e.scaleVector(t,this.radius)}}(),e.SphereShape.prototype.rayIntersect=function(){var t,i=new e.Vector3;return function(o,s){i.subtractVectors(s,o),t=i.length(),i.scale(1/t);var a=o.dot(i),n=o.dot(o)-this.radius*this.radius;if(a>=0&&n>=0)return null;var r=a*a-n;if(0>r)return null;var h=Math.sqrt(r),c=-a-h;if(0>c&&(c=-a+h),c>t)return null;var l=e.ObjectPool.getObject("RayIntersection");return l.object=this,l.point.scaleVector(i,c),l.t=c,l.point.add(o),l.normal.normalizeVector(l.point),l}}(),e.TriangleShape=function(t,i,a){this.a=t,this.b=i,this.c=a,this.normal=new e.Vector3,o.subtractVectors(this.b,this.a),s.subtractVectors(this.c,this.a),this.normal.crossVectors(o,s),this.volume=this.normal.length()/2,this.normal.normalize(),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb)},e.TriangleShape.prototype.calculateLocalAABB=function(t){t.min.x=Math.min(this.a.x,this.b.x,this.c.x),t.min.y=Math.min(this.a.y,this.b.y,this.c.y),t.min.z=Math.min(this.a.z,this.b.z,this.c.z),t.max.x=Math.max(this.a.x,this.b.x,this.c.x),t.max.y=Math.max(this.a.y,this.b.y,this.c.y),t.max.z=Math.max(this.a.z,this.b.z,this.c.z)},e.TriangleShape.prototype.getInertiaTensor=function(t){return new e.Matrix3(0,0,0,0,0,0,0,0,0)},e.TriangleShape.prototype.classifyVertex=function(t){var i=this.normal.dot(this.a);return this.normal.dot(t)-i},e.TriangleShape.prototype.findSupportPoint=function(t,i){var e,o=-(1/0);e=t.dot(this.a),e>o&&(i.copy(this.a),o=e),e=t.dot(this.b),e>o&&(i.copy(this.b),o=e),e=t.dot(this.c),e>o&&i.copy(this.c)},e.TriangleShape.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,s=new e.Vector3,a=new e.Vector3,n=new e.Vector3;return function(r,h){t.subtractVectors(this.b,this.a),i.subtractVectors(this.c,this.a),o.crossVectors(t,i),s.subtractVectors(h,r);var c=-s.dot(o);if(0>=c)return null;a.subtractVectors(r,this.a);var l=a.dot(o)/c;if(0>l||l>1)return null;n.crossVectors(a,s);var p=i.dot(n)/c,_=-t.dot(n)/c;if(p+_>1||0>p||0>_)return null;var u=e.ObjectPool.getObject("RayIntersection");return u.object=this,u.t=l*s.length(),u.point.scaleVector(s,l),u.point.add(r),u.normal.copy(this.normal),u}}(),e.CollisionUtils={},e.CollisionUtils.canBodiesCollide=function(t,i){if(null===t.world||null===i.world)return!0;var e=t.world.collision_matrix;return e[t.layer]&&e[t.layer][i.layer]===!1?!1:!0},e.CollisionUtils.combineFrictions=function(t,i,e,o){return null===e.material&&null===o.material?(t.friction+i.friction)/2:null===e.material?this.combineValues(0,o.material.frictionCombine,t.friction||0,o.material.dynamicFriction):null===o.material?this.combineValues(e.material.frictionCombine,0,e.material.dynamicFriction,o.friction||0):this.combineValues(e.material.frictionCombine,o.material.frictionCombine,e.material.dynamicFriction,o.material.dynamicFriction)},e.CollisionUtils.combineRestitutions=function(t,i,e,o){return null===e.material&&null===o.material?(t.restitution+i.restitution)/2:null===e.material?this.combineValues(0,o.material.bounceCombine,t.restitution||0,o.material.bounciness):null===o.material?this.combineValues(e.material.bounceCombine,0,e.material.bounciness,i.restitution||0):this.combineValues(e.material.bounceCombine,o.material.bounceCombine,e.material.bounciness,o.material.bounciness);

},e.CollisionUtils.combineValues=function(t,i,e,o){switch(Math.max(t,i)){case 1:return e*o;case 2:return Math.min(e,o);case 3:return Math.max(e,o);default:return(e+o)/2}},e.GeometryMethods={findClosestPointInTriangle:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e,s,a,n,r){var h;t.subtractVectors(a,s),i.subtractVectors(n,s),o.subtractVectors(e,s);var c=t.dot(o),l=i.dot(o);if(0>=c&&0>=l)return void r.copy(s);o.subtractVectors(e,a);var p=t.dot(o),_=i.dot(o);if(p>=0&&p>=_)return void r.copy(a);var u=c*_-p*l;if(0>=u&&c>=0&&0>=p)return h=c/(c-p),r.scaleVector(t,h),void r.add(s);o.subtractVectors(e,n);var b=t.dot(o),f=i.dot(o);if(f>=0&&f>=b)return void r.copy(n);var d,m=b*l-c*f;if(0>=m&&l>=0&&0>=f)return d=l/(l-f),r.scaleVector(i,d),void r.add(s);var y=p*f-b*_;if(0>=y&&_-p>=0&&b-f>=0)return d=(_-p)/(_-p+(b-f)),r.subtractVectors(n,a),r.scale(d),void r.add(a);var j=1/(y+m+u);h=m*j,d=u*j,t.scale(h),t.add(s),i.scale(d),r.addVectors(t,i)}}(),findBarycentricCoordinates:function(t,i,o,s,a){var n=new e.Vector3,r=new e.Vector3,h=new e.Vector3;n.subtractVectors(o,i),r.subtractVectors(s,i),h.subtractVectors(t,i);var c=n.dot(n),l=n.dot(r),p=r.dot(r),_=h.dot(n),u=h.dot(r),b=c*p-l*l;a.y=(p*_-l*u)/b,a.z=(c*u-l*_)/b,a.x=1-a.y-a.z},findSquaredDistanceFromSegment:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e,s,a){t.subtractVectors(s,a),i.subtractVectors(s,e),o.subtractVectors(a,e);var n=i.dot(t);if(0>=n)return i.dot(i);var r=t.dot(t);return n>=r?o.dot(o):i.dot(i)-n*n/r}}(),findClosestPointsOnSegments:function(){var t=new e.Vector3,i=new e.Vector3,s=new e.Vector3,a=function(t,i,e){return Math.min(Math.max(t,i),e)};return function(n,r,h,c,l,p){t.subtractVectors(r,n),i.subtractVectors(c,h),s.subtractVectors(n,h);var _,u,b=t.dot(t),f=i.dot(i),d=i.dot(s);if(b<=e.EPSILON&&f<=e.EPSILON)return _=u=0,l.copy(n),p.copy(h),o.subtractVectors(l,p),o.dot(o);if(b<=e.EPSILON)_=0,u=d/f,u=a(u,0,1);else{var m=t.dot(s);if(f<=e.EPSILON)u=0,_=a(-m/b,0,1);else{var y=t.dot(i),j=b*f-y*y;_=0!==j?a((y*d-m*f)/j,0,1):0,u=(y*_+d)/f,0>u?(u=0,_=a(-m/b,0,1)):u>1&&(u=1,_=a((y-m)/b,0,1))}}return l.scaleVector(t,_),l.add(n),p.scaleVector(i,u),p.add(h),o.subtractVectors(l,p),o.dot(o)}}()},function(){e.MinHeap=function(t){this.heap=null==t?[]:t.slice(),this.heap.length>0&&this.heapify()},e.MinHeap.prototype={heapify:function(){for(var t=~~((this.heap.length-2)/2);t>=0;)this.siftUp(t,this.heap.length-1),t--},siftUp:function(t,i){for(var e=t;i>=2*e+1;){var o=2*e+1;if(i>=o+1&&this.heap[o+1].valueOf()<this.heap[o].valueOf()&&o++,!(this.heap[o].valueOf()<this.heap[e].valueOf()))return;var s=this.heap[o];this.heap[o]=this.heap[e],this.heap[e]=s,e=o}},push:function(t){this.heap.push(t);for(var i=this.heap.length-1;0!==i;){var e=~~((i-1)/2);if(this.heap[e].valueOf()>this.heap[i].valueOf()){var o=this.heap[e];this.heap[e]=this.heap[i],this.heap[i]=o}i=e}},peek:function(){return this.heap.length>0?this.heap[0]:null},pop:function(){var t=this.heap[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.length=this.heap.length-1,this.siftUp(0,this.heap.length-1),t}}}(),e.Utility={getUid:function(){var t=0;return function(){return t++}}()},e.LineSweptShape=function(t,i,o){this.start=t,this.end=i,this.shape=o,this.direction=new e.Vector3,this.direction.subtractVectors(i,t),this.length=this.direction.length(),this.direction.normalize(),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb)},e.LineSweptShape.prototype.calculateLocalAABB=function(t){this.shape.calculateLocalAABB(t),t.min.x=Math.min(t.min.x+this.start.x,t.min.x+this.end.x),t.min.y=Math.min(t.min.y+this.start.y,t.min.y+this.end.y),t.min.z=Math.min(t.min.z+this.start.z,t.min.z+this.end.z),t.max.x=Math.max(t.max.x+this.start.x,t.max.x+this.end.x),t.max.y=Math.max(t.max.y+this.start.y,t.max.y+this.end.y),t.max.z=Math.max(t.max.z+this.start.z,t.max.z+this.end.z)},e.LineSweptShape.prototype.getInertiaTensor=function(t){return this.shape.getInertiaTensor(t)},e.LineSweptShape.prototype.findSupportPoint=function(t,i){this.shape.findSupportPoint(t,i);var e=this.direction.dot(t);i.add(0>e?this.start:this.end)},e.LineSweptShape.prototype.rayIntersect=function(){return null},e.AABB=function(t,i){this.min=t||new e.Vector3,this.max=i||new e.Vector3},e.AABB.prototype.copy=function(t){this.min.x=t.min.x,this.min.y=t.min.y,this.min.z=t.min.z,this.max.x=t.max.x,this.max.y=t.max.y,this.max.z=t.max.z},e.AABB.prototype.combineAABBs=function(t,i){this.min.x=Math.min(t.min.x,i.min.x),this.min.y=Math.min(t.min.y,i.min.y),this.min.z=Math.min(t.min.z,i.min.z),this.max.x=Math.max(t.max.x,i.max.x),this.max.y=Math.max(t.max.y,i.max.y),this.max.z=Math.max(t.max.z,i.max.z)},e.AABB.prototype.transform=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o){t.set(0,0,0),o.transformVector3Into(t,i);for(var s=[e.min.x,e.min.y,e.min.z],a=[e.max.x,e.max.y,e.max.z],n=[i.x,i.y,i.z],r=[i.x,i.y,i.z],h=[o.e00,o.e01,o.e02,o.e10,o.e11,o.e12,o.e20,o.e21,o.e22],c=0;3>c;c++)for(var l=0;3>l;l++){var p=h[3*c+l]*s[l],_=h[3*c+l]*a[l];_>p?(n[c]+=p,r[c]+=_):(n[c]+=_,r[c]+=p)}this.min.set(n[0],n[1],n[2]),this.max.set(r[0],r[1],r[2])}}(),e.AABB.prototype.intersects=function(t){return this.max.x<t.min.x||this.max.y<t.min.y||this.max.z<t.min.z||this.min.x>t.max.x||this.min.y>t.max.y||this.min.z>t.max.z?!1:!0},e.AABB.prototype.testRayIntersect=function(){var t,i,o,s,a,n=new e.Vector3;return function(r,h){t=0,n.subtractVectors(h,r),i=n.length(),n.scale(1/i);var c,l;if(c=this.min.x,l=this.max.x,Math.abs(n.x)<e.EPSILON){if(r.x<c||r.x>l)return!1}else if(o=1/n.x,s=(c-r.x)*o,a=(l-r.x)*o,s>a&&(o=s,s=a,a=o),t=Math.max(t,s),i=Math.min(i,a),t>i)return!1;if(c=this.min.y,l=this.max.y,Math.abs(n.y)<e.EPSILON){if(r.y<c||r.y>l)return!1}else if(o=1/n.y,s=(c-r.y)*o,a=(l-r.y)*o,s>a&&(o=s,s=a,a=o),t=Math.max(t,s),i=Math.min(i,a),t>i)return!1;if(c=this.min.z,l=this.max.z,Math.abs(n.z)<e.EPSILON){if(r.z<c||r.z>l)return!1}else if(o=1/n.z,s=(c-r.z)*o,a=(l-r.z)*o,s>a&&(o=s,s=a,a=o),t=Math.max(t,s),i=Math.min(i,a),t>i)return!1;return!0}}(),function(){function t(t){var i=t.max.x-t.min.x,e=t.max.y-t.min.y,o=t.max.z-t.min.z;return i*(e+o)+e*o}var i=function(t){this.aabb=new e.AABB,this.area=0,this.parent=null,this.left=null,this.right=null,this.morton=null,this.object=t||null};i.prototype={isLeaf:function(){return null!=this.object},computeBounds:function(i){this.isLeaf()?this.aabb.copy(this.object.aabb):this.aabb.combineAABBs(this.left.aabb,this.right.aabb),this.area=t(this.aabb)},valueOf:function(){return this.area}};var o=function(){function o(t){return t=4278190335&(t^t<<16),t=50393103&(t^t<<8),t=51130563&(t^t<<4),t=153391689&(t^t<<2)}function s(t,i,e){return(o(e)<<2)+(o(i)<<1)+o(t)}var a=new e.AABB,n=function(t,i){for(var e=t.max.x-t.min.x,o=t.max.y-t.min.y,a=t.max.z-t.min.z,r=512,h=r/e,c=r/o,l=r/a,p=0;p<i.length;p++){var _=i[p],u=(_.aabb.max.x-_.aabb.min.x)/2+_.aabb.min.x,b=(_.aabb.max.y-_.aabb.min.y)/2+_.aabb.min.y,f=(_.aabb.max.z-_.aabb.min.z)/2+_.aabb.min.z;_.morton=s((u+t.min.x)*h,(b+t.min.y)*c,(f+t.min.z)*l)}i.sort(n.mortonSort);var d=n.buildTree(i,29);return n.combineCluster(d,1),d};return n.mortonSort=function(t,i){return t.morton<i.morton?-1:t.morton>i.morton?1:0},n.clusterReductionCount=function(t){var i=Math.pow(t,.5)/2,e=.5;return Math.max(i*Math.pow(t,e),1)},n.buildTree=function(t,i){var e=[];if(t.length<n.max_bucket_size)e.push.apply(e,t),n.combineCluster(e,n.clusterReductionCount(n.max_bucket_size));else{var o=[],s=[];if(1>i)o=t.slice(0,t.length/2),s=t.slice(t.length/2);else for(var a=1<<i,r=0;r<t.length;r++){var h=t[r];h.morton&a?s.push(h):o.push(h)}e.push.apply(e,n.buildTree(o,i-1)),e.push.apply(e,n.buildTree(s,i-1)),n.combineCluster(e,n.clusterReductionCount(e.length))}return e},n.combineCluster=function(t,o){if(t.length<=1)return t;for(var s,a=new e.MinHeap,r=0;r<t.length;r++)s=new i,s.left=t[r],s.right=n.findBestMatch(t,t[r]),s.computeBounds(),a.push(s);for(var h;t.length>o;)for(h=a.pop(),t.splice(t.indexOf(h.left),1),t.splice(t.indexOf(h.right),1),t.push(h),a.heap.length=0,r=0;r<t.length;r++)s=new i,s.left=t[r],s.right=n.findBestMatch(t,t[r]),s.computeBounds(),a.push(s)},n.findBestMatch=function(i,e){for(var o,s=1/0,n=0,r=0;r<i.length;r++)i[r]!==e&&(a.combineAABBs(e.aabb,i[r].aabb),o=t(a),s>o&&(s=o,n=r));return i[n]},n.max_bucket_size=20,n}();e.BVH=function(t){for(var s=[],a=new e.AABB,n=0;n<t.length;n++){a.combineAABBs(a,t[n].aabb);var r=new i(t[n]);r.computeBounds(),s.push(r)}this.tree=o(a,s)[0]},e.BVH.AAC=o}(),e.ContactDetails=function(){this.uid=e.Utility.getUid(),this.object_a=null,this.object_b=null,this.shape_a=null,this.shape_b=null,this.contact_point=new e.Vector3,this.contact_point_in_a=new e.Vector3,this.contact_point_in_b=new e.Vector3,this.contact_normal=new e.Vector3,this.penetration_depth=0,this.restitution=0,this.friction=0,this.listeners={}},e.EventEmitter.apply(e.ContactDetails),e.ContactDetails.prototype.destroy=function(){this.emit("destroy"),e.ObjectPool.freeObject("ContactDetails",this)},e.ContactManifold=function(){this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},e.ContactManifold.prototype.findWeakestContact=function(t){var i,e,a=-1,n=t.penetration_depth;for(i=0;4>i;i++)e=this.points[i],e.penetration_depth>n&&(n=e.penetration_depth,a=i);var r=0,h=0,c=0,l=0;0!==a&&(o.subtractVectors(t.contact_point_in_a,this.points[1].contact_point_in_a),s.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),o.cross(s),r=o.lengthSquared()),1!==a&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),s.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),o.cross(s),h=o.lengthSquared()),2!==a&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),s.subtractVectors(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a),o.cross(s),c=o.lengthSquared()),3!==a&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),s.subtractVectors(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a),o.cross(s),l=o.lengthSquared());var p=0,_=r;return h>_&&(p=1,_=h),c>_&&(p=2,_=c),l>_&&(p=3),p},e.ContactManifold.prototype.addContact=function(t){var i;for(i=0;i<this.points.length;i++)if(this.points[i].contact_point.distanceTo(t.contact_point)<=.02)return void t.destroy();var e=!1;if(null!=t){if(e=t.object_a.emit("speculativeContact",t.object_b,t),e!==!1&&(e=t.object_b.emit("speculativeContact",t.object_a,t)),e===!1)return void t.destroy();t.object_a.emit("contact",t.object_b,t),t.object_b.emit("contact",t.object_a,t)}if(this.points.length<4)this.points.push(t);else{var o=this.findWeakestContact(t);this.points[o].destroy(),this.points[o]=t}},e.ContactManifold.prototype.update=function(){var t,i,s,a=new e.Vector3,n=new e.Vector3,r=new e.Vector3,h=this.points.length;for(t=0;t<this.points.length;t++)if(s=this.points[t],s.object_a.transform.transformVector3Into(s.contact_point_in_a,a),s.object_b.transform.transformVector3Into(s.contact_point_in_b,n),s.contact_point.addVectors(a,n),s.contact_point.scale(.5),r.subtractVectors(a,n),s.penetration_depth=r.dot(s.contact_normal),s.penetration_depth<-.02){for(s.destroy(),i=t;i<this.points.length;i++)this.points[i]=this.points[i+1];this.points.length=this.points.length-1,this.object_a.emit("endContact",this.object_b),this.object_b.emit("endContact",this.object_a)}else{o.scaleVector(s.contact_normal,s.penetration_depth),o.subtractVectors(a,o),o.subtractVectors(n,o);var c=o.lengthSquared();if(c>.2*.2){for(s.destroy(),i=t;i<this.points.length;i++)this.points[i]=this.points[i+1];this.points.length=this.points.length-1,this.object_a.emit("endContact",this.object_b),this.object_b.emit("endContact",this.object_a)}}h>0&&0===this.points.length&&(this.object_a.emit("endAllContact",this.object_b),this.object_b.emit("endAllContact",this.object_a))},e.ContactManifoldList=function(){this.first=null},e.ContactManifoldList.prototype.insert=function(t){t.next_manifold=this.first,this.first=t},e.ContactManifoldList.prototype.getManifoldForObjects=function(t,i){var o=null;if(null!==this.first)for(var s=this.first;null!==s;){if(s.object_a===t&&s.object_b===i||s.object_a===i&&s.object_b===t){o=s;break}s=s.next_manifold}return null===o&&(o=e.ObjectPool.getObject("ContactManifold"),o.object_a=t,o.object_b=i,this.insert(o)),o},e.GhostBody=function(t){e.RigidBody.call(this,t,1/0),this.contacts=[],this.tick_contacts=[],this.addListener("speculativeContact",e.GhostBody.prototype.onSpeculativeContact)},e.GhostBody.prototype=Object.create(e.RigidBody.prototype),e.GhostBody.prototype.onSpeculativeContact=function(t,i){return this.tick_contacts.push(t),-1===this.contacts.indexOf(t)?(this.contacts.push(t),this.emit("contactStart",t,i),t.emit("contactStart",this,i)):(this.emit("contactContinue",t,i),t.emit("contactContinue",this,i)),!1},e.GhostBody.prototype.checkForEndedContacts=function(){for(var t=0;t<this.contacts.length;t++)-1===this.tick_contacts.indexOf(this.contacts[t])&&(this.emit("contactEnd",this.contacts[t]),this.contacts.splice(t,1),t-=1);this.tick_contacts.length=0},e.IterativeSolver=function(){this.existing_contact_ids={},this.contact_constraints=[],this.friction_constraints=[],this.all_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.9,this.sor_weight=.85,this.warmstarting_factor=.95,this.min_row_response=1e-5;var t=this;this.onContactDeactivate=function(){this.removeListener("deactivate",t.onContactDeactivate);var i=t.contact_constraints.indexOf(this);t.contact_constraints.splice(i,1),delete t.existing_contact_ids[this.contact.uid]},this.onFrictionDeactivate=function(){this.removeListener("deactivate",t.onFrictionDeactivate);var i=t.friction_constraints.indexOf(this);t.friction_constraints.splice(i,1)}},e.IterativeSolver.prototype.addConstraint=function(t){-1===this.constraints.indexOf(t)&&this.constraints.push(t)},e.IterativeSolver.prototype.removeConstraint=function(t){var i=this.constraints.indexOf(t);-1!==i&&this.constraints.splice(i,1)},e.IterativeSolver.prototype.processContactManifolds=function(t){var i,o,s,a,n;for(o=t.first;o;){for(s=o.points.length,i=0;s>i;i++){a=o.points[i];var r=this.existing_contact_ids.hasOwnProperty(a.uid);r||(this.existing_contact_ids[a.uid]=!0,n=e.ObjectPool.getObject("ContactConstraint"),n.buildFromContact(a),this.contact_constraints.push(n),n.addListener("deactivate",this.onContactDeactivate),n=e.ObjectPool.getObject("FrictionConstraint"),n.buildFromContact(a),this.friction_constraints.push(n),n.addListener("deactivate",this.onFrictionDeactivate))}o=o.next_manifold}this.all_constraints.length=0,Array.prototype.push.apply(this.all_constraints,this.friction_constraints),Array.prototype.push.apply(this.all_constraints,this.constraints),Array.prototype.push.apply(this.all_constraints,this.contact_constraints)},e.IterativeSolver.prototype.prepareConstraints=function(t){var i,e,o,s,a=this.all_constraints.length;for(o=0;a>o;o++)if(i=this.all_constraints[o],i.active!==!1)for(i.update(t),s=0;s<i.rows.length;s++)e=i.rows[s],e.multiplier=0,e.computeB(i),e.computeD(),e.computeEta(i,t)},e.IterativeSolver.prototype.resolveContacts=function(){var t,i,s,a,n,r,h,c=0;for(t=0;t<this.penetrations_max_iterations;t++){for(c=0,n=0;n<this.contact_constraints.length;n++){i=this.contact_constraints[n],a=i.rows[0],s=0,i.object_a_is_dynamic()&&(s+=a.jacobian[0]*i.object_a.linear_factor.x*i.object_a.push_velocity.x+a.jacobian[1]*i.object_a.linear_factor.y*i.object_a.push_velocity.y+a.jacobian[2]*i.object_a.linear_factor.z*i.object_a.push_velocity.z+a.jacobian[3]*i.object_a.angular_factor.x*i.object_a.turn_velocity.x+a.jacobian[4]*i.object_a.angular_factor.y*i.object_a.turn_velocity.y+a.jacobian[5]*i.object_a.angular_factor.z*i.object_a.turn_velocity.z),i.object_b_is_dynamic()&&(s+=a.jacobian[6]*i.object_b.linear_factor.x*i.object_b.push_velocity.x+a.jacobian[7]*i.object_b.linear_factor.y*i.object_b.push_velocity.y+a.jacobian[8]*i.object_b.linear_factor.z*i.object_b.push_velocity.z+a.jacobian[9]*i.object_b.angular_factor.x*i.object_b.turn_velocity.x+a.jacobian[10]*i.object_b.angular_factor.y*i.object_b.turn_velocity.y+a.jacobian[11]*i.object_b.angular_factor.z*i.object_b.turn_velocity.z),r=(i.contact.penetration_depth-s)/a.D||0;var l=a.multiplier;a.multiplier=Math.max(a.lower_limit,Math.min(l+r,a.upper_limit)),r=a.multiplier-l,c=Math.max(c,r),i.object_a_is_dynamic()&&(i.object_a.push_velocity.x+=r*a.B[0],i.object_a.push_velocity.y+=r*a.B[1],i.object_a.push_velocity.z+=r*a.B[2],i.object_a.turn_velocity.x+=r*a.B[3],i.object_a.turn_velocity.y+=r*a.B[4],i.object_a.turn_velocity.z+=r*a.B[5]),i.object_b_is_dynamic()&&(i.object_b.push_velocity.x+=r*a.B[6],i.object_b.push_velocity.y+=r*a.B[7],i.object_b.push_velocity.z+=r*a.B[8],i.object_b.turn_velocity.x+=r*a.B[9],i.object_b.turn_velocity.y+=r*a.B[10],i.object_b.turn_velocity.z+=r*a.B[11])}if(c>=-e.EPSILON&&c<=e.EPSILON)break}for(n=0;n<this.contact_constraints.length;n++)i=this.contact_constraints[n],a=i.rows[0],i.object_a_is_dynamic()&&(h=i.object_a._mass_inverted,i.object_a.position.x+=h*a.jacobian[0]*i.object_a.linear_factor.x*a.multiplier*this.relaxation,i.object_a.position.y+=h*a.jacobian[1]*i.object_a.linear_factor.y*a.multiplier*this.relaxation,i.object_a.position.z+=h*a.jacobian[2]*i.object_a.linear_factor.z*a.multiplier*this.relaxation,o.x=a.jacobian[3]*i.object_a.angular_factor.x*a.multiplier*this.relaxation,o.y=a.jacobian[4]*i.object_a.angular_factor.y*a.multiplier*this.relaxation,o.z=a.jacobian[5]*i.object_a.angular_factor.z*a.multiplier*this.relaxation,i.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_a.integrateRotation(1,o)),i.object_b_is_dynamic()&&(h=i.object_b._mass_inverted,i.object_b.position.x+=h*a.jacobian[6]*i.object_b.linear_factor.x*a.multiplier*this.relaxation,i.object_b.position.y+=h*a.jacobian[7]*i.object_b.linear_factor.y*a.multiplier*this.relaxation,i.object_b.position.z+=h*a.jacobian[8]*i.object_b.linear_factor.z*a.multiplier*this.relaxation,o.x=a.jacobian[9]*i.object_b.angular_factor.x*a.multiplier*this.relaxation,o.y=a.jacobian[10]*i.object_b.angular_factor.y*a.multiplier*this.relaxation,o.z=a.jacobian[11]*i.object_b.angular_factor.z*a.multiplier*this.relaxation,i.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_b.integrateRotation(1,o)),a.multiplier=0},e.IterativeSolver.prototype.solveConstraints=function(){var t,i,e,o,s,a,n,r,h,c=this.all_constraints.length,l=0;for(s=0;c>s;s++)if(t=this.all_constraints[s],t.active!==!1)for(a=0;a<t.rows.length;a++)e=t.rows[a],o=e.multiplier_cached*this.warmstarting_factor,e.multiplier=o,Math.abs(e.D)<this.min_row_response||(t.object_a_is_dynamic()&&(t.object_a.solver_impulse[0]+=o*e.B[0],t.object_a.solver_impulse[1]+=o*e.B[1],t.object_a.solver_impulse[2]+=o*e.B[2],t.object_a.solver_impulse[3]+=o*e.B[3],t.object_a.solver_impulse[4]+=o*e.B[4],t.object_a.solver_impulse[5]+=o*e.B[5]),t.object_b_is_dynamic()&&(t.object_b.solver_impulse[0]+=o*e.B[6],t.object_b.solver_impulse[1]+=o*e.B[7],t.object_b.solver_impulse[2]+=o*e.B[8],t.object_b.solver_impulse[3]+=o*e.B[9],t.object_b.solver_impulse[4]+=o*e.B[10],t.object_b.solver_impulse[5]+=o*e.B[11]));for(n=0;n<this.max_iterations;n++){for(l=0,s=0;c>s;s++)if(t=this.all_constraints[s],t.active!==!1)for(i=t.rows.length,a=0;i>a;a++)if(e=t.rows[a],!(Math.abs(e.D)<this.min_row_response)){h=0,t.object_a_is_dynamic()&&(h+=e.jacobian[0]*t.object_a.linear_factor.x*t.object_a.solver_impulse[0]+e.jacobian[1]*t.object_a.linear_factor.y*t.object_a.solver_impulse[1]+e.jacobian[2]*t.object_a.linear_factor.z*t.object_a.solver_impulse[2]+e.jacobian[3]*t.object_a.angular_factor.x*t.object_a.solver_impulse[3]+e.jacobian[4]*t.object_a.angular_factor.y*t.object_a.solver_impulse[4]+e.jacobian[5]*t.object_a.angular_factor.z*t.object_a.solver_impulse[5]),t.object_b_is_dynamic()&&(h+=e.jacobian[6]*t.object_b.linear_factor.x*t.object_b.solver_impulse[0]+e.jacobian[7]*t.object_b.linear_factor.y*t.object_b.solver_impulse[1]+e.jacobian[8]*t.object_b.linear_factor.z*t.object_b.solver_impulse[2]+e.jacobian[9]*t.object_b.angular_factor.x*t.object_b.solver_impulse[3]+e.jacobian[10]*t.object_b.angular_factor.y*t.object_b.solver_impulse[4]+e.jacobian[11]*t.object_b.angular_factor.z*t.object_b.solver_impulse[5]),r=((e.eta-h)/e.D||0)*t.factor;var p=e.multiplier,_=p+r;_=this.sor_weight*_+(1-this.sor_weight)*p,e.multiplier=Math.max(e.lower_limit,Math.min(_,e.upper_limit)),r=e.multiplier-p;var u=(t.object_a_is_dynamic()?t.object_a._mass:0)+(t.object_b_is_dynamic()?t.object_b._mass:0);l=Math.max(l,Math.abs(r)/u),t.object_a_is_dynamic()&&(t.object_a.solver_impulse[0]+=r*e.B[0],t.object_a.solver_impulse[1]+=r*e.B[1],t.object_a.solver_impulse[2]+=r*e.B[2],t.object_a.solver_impulse[3]+=r*e.B[3],t.object_a.solver_impulse[4]+=r*e.B[4],t.object_a.solver_impulse[5]+=r*e.B[5]),t.object_b_is_dynamic()&&(t.object_b.solver_impulse[0]+=r*e.B[6],t.object_b.solver_impulse[1]+=r*e.B[7],t.object_b.solver_impulse[2]+=r*e.B[8],t.object_b.solver_impulse[3]+=r*e.B[9],t.object_b.solver_impulse[4]+=r*e.B[10],t.object_b.solver_impulse[5]+=r*e.B[11])}if(.1>=l)break}},e.IterativeSolver.prototype.applyConstraints=function(t){var i,e,a,n,r,h,c=this.all_constraints.length;for(n=0;c>n;n++)if(i=this.all_constraints[n],i.active!==!1){for(e=i.rows.length,i.last_impulse.x=i.last_impulse.y=i.last_impulse.z=0,r=0;e>r;r++)a=i.rows[r],a.multiplier_cached=a.multiplier,Math.abs(a.D)<this.min_row_response||(i.object_a_is_dynamic()&&(h=i.object_a._mass_inverted,s.x=h*t*a.jacobian[0]*i.object_a.linear_factor.x*a.multiplier,s.y=h*t*a.jacobian[1]*i.object_a.linear_factor.y*a.multiplier,s.z=h*t*a.jacobian[2]*i.object_a.linear_factor.z*a.multiplier,i.object_a.linear_velocity.add(s),i.last_impulse.add(s),o.x=t*a.jacobian[3]*i.object_a.angular_factor.x*a.multiplier,o.y=t*a.jacobian[4]*i.object_a.angular_factor.y*a.multiplier,o.z=t*a.jacobian[5]*i.object_a.angular_factor.z*a.multiplier,i.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_a.angular_velocity.add(o),i.last_impulse.add(o)),i.object_b_is_dynamic()&&(h=i.object_b._mass_inverted,s.x=h*t*a.jacobian[6]*i.object_b.linear_factor.x*a.multiplier,s.y=h*t*a.jacobian[7]*i.object_b.linear_factor.y*a.multiplier,s.z=h*t*a.jacobian[8]*i.object_b.linear_factor.z*a.multiplier,i.object_b.linear_velocity.add(s),i.last_impulse.add(s),o.x=t*a.jacobian[9]*i.object_b.angular_factor.x*a.multiplier,o.y=t*a.jacobian[10]*i.object_b.angular_factor.y*a.multiplier,o.z=t*a.jacobian[11]*i.object_b.angular_factor.z*a.multiplier,i.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_b.angular_velocity.add(o),i.last_impulse.add(o)));i.breaking_threshold>0&&i.last_impulse.lengthSquared()>=i.breaking_threshold*i.breaking_threshold&&(i.active=!1)}},e.NarrowPhase=function(){this.contact_manifolds=new e.ContactManifoldList},e.NarrowPhase.prototype.updateContactManifolds=function(){for(var t=this.contact_manifolds.first,i=null;null!==t;)t.update(),0===t.points.length?(e.ObjectPool.freeObject("ContactManifold",t),null==i?this.contact_manifolds.first=t.next_manifold:i.next_manifold=t.next_manifold,t=t.next_manifold):(i=t,t=t.next_manifold)},e.NarrowPhase.prototype.midPhase=function(t,i){var o,s,a;t.shape instanceof e.CompoundShape?(o=t,s=i,a=!1):(o=i,s=t,a=!0);for(var n,r,h=e.ObjectPool.getObject("RigidBodyProxy"),c=0;c<o.shape.child_shapes.length;c++){if(n=o.shape.child_shapes[c],h.setFrom(o,n),h.shape instanceof e.CompoundShape||s.shape instanceof e.CompoundShape)return this.midPhase(h,s);if(r=this.getContact(h,s),null!=r){var l,p;if(r.object_a===h?(r.object_a=o,l=h,p=s):(r.object_b=o,l=s,p=h),l instanceof e.RigidBodyProxy)for(;l.parent;)l instanceof e.RigidBodyProxy&&l.shape_data.transform.transformVector3(r.contact_point_in_a),l=l.parent;if(p instanceof e.RigidBodyProxy)for(;p.parent;)p instanceof e.RigidBodyProxy&&p.shape_data.transform.transformVector3(r.contact_point_in_b),p=p.parent;r.object_a=l,r.object_b=p,r.shape_a=a?s.shape:h.shape,r.shape_b=a?h.shape:s.shape,r.restitution=e.CollisionUtils.combineRestitutions(r.object_a,r.object_b,r.shape_a,r.shape_b),r.friction=e.CollisionUtils.combineFrictions(r.object_a,r.object_b,r.shape_a,r.shape_b),this.addContact(l,p,r)}}return e.ObjectPool.freeObject("RigidBodyProxy",h),r},e.NarrowPhase.prototype.meshCollision=function(){function t(t,i,l){a.copy(t.transform_inverse),a.multiply(i.transform);for(var p,_=[t.shape.hierarchy,i.shape.hierarchy];_.length;){var u=_.shift(),b=_.shift();u.isLeaf()&&b.isLeaf()?(a.transformVector3Into(b.object.a,n.a),a.transformVector3Into(b.object.b,n.b),a.transformVector3Into(b.object.c,n.c),o.subtractVectors(n.b,n.a),s.subtractVectors(n.c,n.a),n.normal.crossVectors(o,s),n.normal.normalize(),p=e.TriangleTriangle(u.object,n),null!=p&&(t.transform.rotateVector3(p.contact_normal),t.transform.transformVector3(p.contact_point),t.transform.transformVector3(p.contact_point_in_b),i.transform_inverse.transformVector3(p.contact_point_in_b),p.object_a=t,p.object_b=i,p.shape_a=t.shape,p.shape_b=i.shape,p.restitution=e.CollisionUtils.combineRestitutions(t,i,t.shape,i.shape),p.friction=e.CollisionUtils.combineFrictions(t,i,t.shape,i.shape),l(t,i,p))):u.isLeaf()?(c.transform(b.left.aabb,a),u.aabb.intersects(c)&&_.push(u,b.left),h.transform(b.right.aabb,a),u.aabb.intersects(h)&&_.push(u,b.right)):b.isLeaf()?(r.transform(b.aabb,a),r.intersects(u.left.aabb)&&_.push(u.left,b),r.intersects(u.right.aabb)&&_.push(u.right,b)):(c.transform(b.left.aabb,a),h.transform(b.right.aabb,a),u.left.aabb.intersects(c)&&_.push(u.left,b.left),u.left.aabb.intersects(h)&&_.push(u.left,b.right),u.right.aabb.intersects(c)&&_.push(u.right,b.left),u.right.aabb.intersects(h)&&_.push(u.right,b.right))}return p}function i(t,i,o){var s=e.ObjectPool.getObject("RigidBodyProxy"),a=new e.CompoundShapeChild(t,new e.Vector3,new e.Quaternion);s.setFrom(i,a);var n,r=e.GjkEpa.GJK(s,o);return null!=e.GjkEpa.result?n=e.GjkEpa.result:null!=r&&(n=e.GjkEpa.EPA(r)),e.ObjectPool.freeObject("RigidBodyProxy",s),n}var a=new e.Matrix4,n=new e.TriangleShape(new e.Vector3,new e.Vector3,new e.Vector3),r=new e.AABB,h=new e.AABB,c=new e.AABB,l=function(){var t=new e.Matrix4,o=new e.AABB;return function(s,a,n){t.copy(a.transform),t.multiply(s.transform_inverse),o.transform(a.aabb,s.transform_inverse);for(var r,h,c=[s.shape.hierarchy];h=c.shift();)if(h.aabb.intersects(o))if(h.isLeaf()){if(r=i(h.object,s,a),null!=r){for(var l=s;null!=l.parent;)l=l.parent;for(var p=a;null!=p.parent;)p=p.parent;r.object_a=l,r.object_b=p,r.shape_a=s.shape,r.shape_b=a.shape,r.restitution=e.CollisionUtils.combineRestitutions(l,p,s.shape,a.shape),r.friction=e.CollisionUtils.combineFrictions(l,p,s.shape,a.shape),n(l,p,r)}}else c.push(h.left,h.right);return r}}();return function(i,o){var s=i.shape instanceof e.MeshShape,a=o.shape instanceof e.MeshShape;return s&&a?t(i,o,this.addContact.bind(this)):s?l(i,o,this.addContact.bind(this)):l(o,i,this.addContact.bind(this))}}(),e.NarrowPhase.prototype.getContact=function(t,i){if(t.shape instanceof e.CompoundShape||i.shape instanceof e.CompoundShape)return this.midPhase(t,i);if(t.shape instanceof e.MeshShape||i.shape instanceof e.MeshShape)return this.meshCollision(t,i);var o;if(t.shape instanceof e.SphereShape&&i.shape instanceof e.SphereShape)o=e.SphereSphere(t,i);else if(t.shape instanceof e.SphereShape&&i.shape instanceof e.BoxShape||t.shape instanceof e.BoxShape&&i.shape instanceof e.SphereShape)o=e.BoxSphere(t,i);else{var s=e.GjkEpa.GJK(t,i);null!=e.GjkEpa.result?o=e.GjkEpa.result:null!=s&&(o=e.GjkEpa.EPA(s))}return o&&(o.shape_a=t.shape,o.shape_b=i.shape),o},e.NarrowPhase.prototype.addContact=function(t,i,e){null!==t.world&&null!==i.world&&this.contact_manifolds.getManifoldForObjects(t,i).addContact(e)},e.NarrowPhase.prototype.generateContacts=function(t){var i,e,o=t.length;for(this.updateContactManifolds(),i=0;o>i;i++)e=this.getContact(t[i][0],t[i][1]),null!=e&&this.addContact(t[i][0],t[i][1],e)},e.NarrowPhase.prototype.removeBody=function(t){for(var i=this.contact_manifolds.first;null!=i;){if(i.object_a===t||i.object_b===t){for(var e=0;e<i.points.length;e++)i.points[e].destroy();i.points.length=0}i=i.next}},e.ObjectPool={types:{},pools:{},registerType:function(t,i){this.types[t]=i,this.pools[t]=[]},getObject:function(t){var i=this.pools[t];return 0!==i.length?i.pop():this.types[t]()},freeObject:function(t,i){null!=i.removeAllListeners&&i.removeAllListeners(),this.pools[t].push(i)}},e.ObjectPool.registerType("ContactDetails",function(){return new e.ContactDetails}),e.ObjectPool.registerType("ContactManifold",function(){return new e.ContactManifold}),e.ObjectPool.registerType("GJK2SupportPoint",function(){return new e.GjkEpa.SupportPoint(new e.Vector3,new e.Vector3,new e.Vector3)}),e.ObjectPool.registerType("ConstraintRow",function(){return new e.ConstraintRow}),e.ObjectPool.registerType("ContactConstraint",function(){return new e.ContactConstraint}),e.ObjectPool.registerType("FrictionConstraint",function(){return new e.FrictionConstraint}),e.ObjectPool.registerType("RayIntersection",function(){return new e.RayIntersection}),e.ObjectPool.registerType("RigidBodyProxy",function(){return new e.RigidBodyProxy}),e.PhysicMaterial=function(t){this.bounciness=t.bounciness,this.dynamicFriction=t.dynamicFriction,this.staticFriction=t.staticFriction,this.frictionCombine=t.frictionCombine,this.bounceCombine=t.bounceCombine},e.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new e.AABB,this._mass=null,this._mass_inverted=null,this.position=new e.Vector3,this.rotation=new e.Quaternion,this.transform=new e.Matrix4,this.transform_inverse=new e.Matrix4,this.restitution=null,this.friction=null,this.is_kinematic=!1},Object.defineProperty(e.RigidBodyProxy.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t,this._mass_inverted=1/t,this.inertiaTensor=this.shape.getInertiaTensor(this.is_kinematic?1/0:t)}}),e.RigidBodyProxy.prototype.setFrom=function(t,i){this.parent=t,this.id=t.id,this.shape=i.shape,this.shape_data=i,this._mass=t._mass,this.is_kinematic=t.is_kinematic,t.transform.transformVector3Into(i.position,this.position),this.rotation.multiplyQuaternions(t.rotation,i.rotation),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=t.restitution,this.friction=t.friction},e.RigidBodyProxy.prototype.findSupportPoint=e.RigidBody.prototype.findSupportPoint,e.RigidBodyProxy.prototype.getRigidBody=function(){for(var t=this.parent;t.parent;)t=this.parent;return t},e.World=function(t,i,o){this.ticks=0,this.broadphase=t,this.narrowphase=i,this.solver=o,o.world=this,this.rigid_bodies=[],this.ghost_bodies=[],this.gravity=new e.Vector3(0,-9.8,0),this.force_generators=[],this.collision_matrix={},this.listeners={}},e.EventEmitter.apply(e.World),e.World.prototype.step=function(t,i){i=i||t;var e,s,a,n,r,h;for(a=t/i,e=0;a>e;e++){this.ticks++,s=Math.min(i,t),t-=i,this.emit("stepStart",this.ticks,s);var c=this.rigid_bodies;for(n=0,r=c.length;r>n;n++)h=c[n],h._is_kinematic||(h._mass!==1/0&&h.use_gravity&&(o.scaleVector(h.gravity||this.gravity,h._mass*s),h.accumulated_force.add(o)),h._mass!==1/0&&(o.scaleVector(h.linear_acceleration,h._mass*s),h.accumulated_force.add(o),o.scaleVector(h.angular_acceleration,h._mass*s),h.accumulated_torque.add(o)));for(n=0,r=this.force_generators.length;r>n;n++)this.force_generators[n].applyForce();for(n=0,r=c.length;r>n;n++)c[n].updateDerived();for(this.broadphase.update(),this.narrowphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.narrowphase.contact_manifolds),this.solver.prepareConstraints(s),this.solver.resolveContacts(),this.solver.solveConstraints(),this.solver.applyConstraints(s),n=0;n<this.ghost_bodies.length;n++)h=this.ghost_bodies[n],h.checkForEndedContacts();for(n=0,r=c.length;r>n;n++)h=c[n],h.integrate(s);this.emit("stepEnd",this.ticks,s);

}},e.World.prototype.addRigidBody=function(t){t.world=this,t.updateDerived(),this.rigid_bodies.push(t),this.broadphase.addBody(t)},e.World.prototype.removeRigidBody=function(t){var i;for(i=0;i<this.rigid_bodies.length;i++)if(this.rigid_bodies[i]===t){this.rigid_bodies.splice(i,1),this.broadphase.removeBody(t);break}this.narrowphase.removeBody(t)},e.World.prototype.updateObjectLayer=function(t,i){this.broadphase.updateObjectLayer(t,i)},e.World.prototype.updateObjectStaticFlag=function(t,i){this.broadphase.updateObjectStaticFlag(t,i)},e.World.prototype.updateObjectKinematicFlag=function(t,i){this.broadphase.updateObjectKinematicFlag(t,i)},e.World.prototype.addGhostBody=function(t){t.world=this,t.updateDerived(),this.ghost_bodies.push(t),this.broadphase.addBody(t)},e.World.prototype.removeGhostBody=function(t){for(var i=0;i<this.ghost_bodies.length;i++)if(this.ghost_bodies[i]===t){this.ghost_bodies.splice(i,1),this.broadphase.removeBody(t);break}},e.World.prototype.addForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return;this.force_generators.push(t)},e.World.prototype.removeForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return void this.force_generators.splice(i,1)},e.World.prototype.addConstraint=function(t){this.solver.addConstraint(t)},e.World.prototype.removeConstraint=function(t){this.solver.removeConstraint(t)},function(){var t=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};e.World.prototype.rayIntersect=function(i,e,o,s){var a=this.broadphase.rayIntersect(i,e,0,s);return a.sort(t),a.slice(0,o)},e.World.prototype.shapeIntersect=function(t,i){var o=new e.RigidBody(i,0);o.position.copy(t),o.updateDerived();for(var s=this.broadphase.intersectsWith(o),a=[],n=0;n<s.length;n++){var r=this.narrowphase.getContact(o,s[n]);if(null!=r){var h=e.ObjectPool.getObject("RayIntersection");h.object=r.object_b,h.shape=r.shape_b,a.push(h)}}return a},e.World.prototype.sweptShapeIntersect=function(i,o,s){var a=new e.LineSweptShape(o,s,i),n=new e.RigidBody(a,0);n.updateDerived();for(var r=this.broadphase.intersectsWith(n),h=[],c=0;c<r.length;c++){var l=this.narrowphase.getContact(n,r[c]);if(null!=l){var p=e.ObjectPool.getObject("RayIntersection");p.object=l.object_b,p.normal.copy(l.contact_normal),p.point.scaleVector(l.contact_normal,-l.penetration_depth),p.point.add(l.contact_point),p.t=p.point.distanceTo(o),h.push(p)}}return h.sort(t),h}}(),"undefined"!=typeof window&&(window.Goblin=e),"undefined"!=typeof self&&(self.Goblin=e),"undefined"!=typeof module&&(module.exports=e)}();