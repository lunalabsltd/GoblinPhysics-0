!function(){function t(t){if(null!=t.limit.constraint_row){var i=t.rows.indexOf(t.limit.constraint_row);t.rows.splice(i,1),t.limit.constraint_row=null}}function i(t){if(null!=t.motor.constraint_row){var i=t.rows.indexOf(t.motor.constraint_row);t.rows.splice(i,1),t.motor.constraint_row=null}}var e={};e.Matrix3=function(t,i,e,o,n,s,a,r,c){this.e00=t||0,this.e01=i||0,this.e02=e||0,this.e10=o||0,this.e11=n||0,this.e12=s||0,this.e20=a||0,this.e21=r||0,this.e22=c||0},e.Matrix3.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e10=0,this.e11=1,this.e12=0,this.e20=0,this.e21=0,this.e22=1},fromMatrix4:function(t){this.e00=t.e00,this.e01=t.e01,this.e02=t.e02,this.e10=t.e10,this.e11=t.e11,this.e12=t.e12,this.e20=t.e20,this.e21=t.e21,this.e22=t.e22},fromQuaternion:function(t){var i=t.x+t.x,e=t.y+t.y,o=t.z+t.z,n=t.x*i,s=t.x*e,a=t.x*o,r=t.y*e,c=t.y*o,h=t.z*o,l=t.w*i,p=t.w*e,u=t.w*o;this.e00=1-(r+h),this.e10=s+u,this.e20=a-p,this.e01=s-u,this.e11=1-(n+h),this.e21=c+l,this.e02=a+p,this.e12=c-l,this.e22=1-(n+r)},transformVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o,t.y=this.e10*i+this.e11*e+this.e12*o,t.z=this.e20*i+this.e21*e+this.e22*o},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},transposeInto:function(t){t.e00=this.e00,t.e10=this.e01,t.e20=this.e02,t.e01=this.e10,t.e11=this.e11,t.e21=this.e12,t.e02=this.e20,t.e12=this.e21,t.e22=this.e22},invert:function(){var t,i=this.e00,e=this.e01,o=this.e02,n=this.e10,s=this.e11,a=this.e12,r=this.e20,c=this.e21,h=this.e22,l=h*s-a*c,p=-h*n+a*r,u=c*n-s*r,_=i*l+e*p+o*u;return _?(t=1/_,this.e00=l*t,this.e01=(-h*e+o*c)*t,this.e02=(a*e-o*s)*t,this.e10=p*t,this.e11=(h*i-o*r)*t,this.e12=(-a*i+o*n)*t,this.e20=u*t,this.e21=(-c*i+e*r)*t,this.e22=(s*i-e*n)*t,!0):!0},invertInto:function(t){var i,e=this.e00,o=this.e01,n=this.e02,s=this.e10,a=this.e11,r=this.e12,c=this.e20,h=this.e21,l=this.e22,p=l*a-r*h,u=-l*s+r*c,_=h*s-a*c,f=e*p+o*u+n*_;return f?(i=1/f,t.e00=p*i,t.e01=(-l*o+n*h)*i,t.e02=(r*o-n*a)*i,t.e10=u*i,t.e11=(l*e-n*c)*i,t.e12=(-r*e+n*s)*i,t.e20=_*i,t.e21=(-h*e+o*c)*i,t.e22=(a*e-o*s)*i,!0):!1},multiply:function(t){var i=this.e00,e=this.e01,o=this.e02,n=this.e10,s=this.e11,a=this.e12,r=this.e20,c=this.e21,h=this.e22,l=t.e00,p=t.e01,u=t.e02,_=t.e10,f=t.e11,b=t.e12,d=t.e20,m=t.e21,y=t.e22;this.e00=l*i+_*e+d*o,this.e10=l*n+_*s+d*a,this.e20=l*r+_*c+d*h,this.e01=p*i+f*e+m*o,this.e11=p*n+f*s+m*a,this.e21=p*r+f*c+m*h,this.e02=u*i+b*e+y*o,this.e12=u*n+b*s+y*a,this.e22=u*r+b*c+y*h},multiplyFrom:function(t,i){var e=t.e00,o=t.e01,n=t.e02,s=t.e10,a=t.e11,r=t.e12,c=t.e20,h=t.e21,l=t.e22,p=i.e00,u=i.e01,_=i.e02,f=i.e10,b=i.e11,d=i.e12,m=i.e20,y=i.e21,v=i.e22;this.e00=p*e+f*o+m*n,this.e10=p*s+f*a+m*r,this.e20=p*c+f*h+m*l,this.e01=u*e+b*o+y*n,this.e11=u*s+b*a+y*r,this.e21=u*c+b*h+y*l,this.e02=_*e+d*o+v*n,this.e12=_*s+d*a+v*r,this.e22=_*c+d*h+v*l}},e.Matrix4=function(){this.e00=0,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=0,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=0,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=0},e.Matrix4.prototype={identity:function(){this.e00=1,this.e01=0,this.e02=0,this.e03=0,this.e10=0,this.e11=1,this.e12=0,this.e13=0,this.e20=0,this.e21=0,this.e22=1,this.e23=0,this.e30=0,this.e31=0,this.e32=0,this.e33=1},copy:function(t){this.e00=t.e00,this.e01=t.e01,this.e02=t.e02,this.e03=t.e03,this.e10=t.e10,this.e11=t.e11,this.e12=t.e12,this.e13=t.e13,this.e20=t.e20,this.e21=t.e21,this.e22=t.e22,this.e23=t.e23,this.e30=t.e30,this.e31=t.e31,this.e32=t.e32,this.e33=t.e33},getTranslation:function(t){return t=t||new e.Vector3,t.set(this.e03,this.e13,this.e23),t},getRotation:function(t){return t=t||new e.Quaternion,t.setFromMat4(this),t},makeTransform:function(t,i){var e=t.x+t.x,o=t.y+t.y,n=t.z+t.z,s=t.x*e,a=t.x*o,r=t.x*n,c=t.y*o,h=t.y*n,l=t.z*n,p=t.w*e,u=t.w*o,_=t.w*n;this.e00=1-(c+l),this.e10=a+_,this.e20=r-u,this.e30=0,this.e01=a-_,this.e11=1-(s+l),this.e21=h+p,this.e31=0,this.e02=r+u,this.e12=h-p,this.e22=1-(s+c),this.e32=0,this.e03=i.x,this.e13=i.y,this.e23=i.z,this.e33=1},transformVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o+this.e03,t.y=this.e10*i+this.e11*e+this.e12*o+this.e13,t.z=this.e20*i+this.e21*e+this.e22*o+this.e23},transformVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z+this.e03,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z+this.e13,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z+this.e23},rotateVector3:function(t){var i=t.x,e=t.y,o=t.z;t.x=this.e00*i+this.e01*e+this.e02*o,t.y=this.e10*i+this.e11*e+this.e12*o,t.z=this.e20*i+this.e21*e+this.e22*o},rotateVector3Into:function(t,i){i.x=this.e00*t.x+this.e01*t.y+this.e02*t.z,i.y=this.e10*t.x+this.e11*t.y+this.e12*t.z,i.z=this.e20*t.x+this.e21*t.y+this.e22*t.z},invert:function(){var t,i=this.e00,e=this.e01,o=this.e02,n=this.e03,s=this.e10,a=this.e11,r=this.e12,c=this.e13,h=this.e20,l=this.e21,p=this.e22,u=this.e23,_=this.e30,f=this.e31,b=this.e32,d=this.e33,m=i*a-e*s,y=i*r-o*s,v=i*c-n*s,x=e*r-o*a,w=e*c-n*a,g=o*c-n*r,j=h*f-l*_,V=h*b-p*_,C=h*d-u*_,S=l*b-p*f,z=l*d-u*f,P=p*d-u*b,O=m*P-y*z+v*S+x*C-w*V+g*j;return O?(t=1/O,this.e00=(a*P-r*z+c*S)*t,this.e01=(-e*P+o*z-n*S)*t,this.e02=(f*g-b*w+d*x)*t,this.e03=(-l*g+p*w-u*x)*t,this.e10=(-s*P+r*C-c*V)*t,this.e11=(i*P-o*C+n*V)*t,this.e12=(-_*g+b*v-d*y)*t,this.e13=(h*g-p*v+u*y)*t,this.e20=(s*z-a*C+c*j)*t,this.e21=(-i*z+e*C-n*j)*t,this.e22=(_*w-f*v+d*m)*t,this.e23=(-h*w+l*v-u*m)*t,this.e30=(-s*S+a*V-r*j)*t,this.e31=(i*S-e*V+o*j)*t,this.e32=(-_*x+f*y-b*m)*t,this.e33=(h*x-l*y+p*m)*t,!0):!1},invertInto:function(t){var i,e=this.e00,o=this.e10,n=this.e20,s=this.e30,a=this.e01,r=this.e11,c=this.e21,h=this.e31,l=this.e02,p=this.e12,u=this.e22,_=this.e32,f=this.e03,b=this.e13,d=this.e23,m=this.e33,y=e*r-o*a,v=e*c-n*a,x=e*h-s*a,w=o*c-n*r,g=o*h-s*r,j=n*h-s*c,V=l*b-p*f,C=l*d-u*f,S=l*m-_*f,z=p*d-u*b,P=p*m-_*b,O=u*m-_*d,B=y*O-v*P+x*z+w*S-g*C+j*V;return B?(i=1/B,t.e00=(r*O-c*P+h*z)*i,t.e10=(-o*O+n*P-s*z)*i,t.e20=(b*j-d*g+m*w)*i,t.e30=(-p*j+u*g-_*w)*i,t.e01=(-a*O+c*S-h*C)*i,t.e11=(e*O-n*S+s*C)*i,t.e21=(-f*j+d*x-m*v)*i,t.e31=(l*j-u*x+_*v)*i,t.e02=(a*P-r*S+h*V)*i,t.e12=(-e*P+o*S-s*V)*i,t.e22=(f*g-b*x+m*y)*i,t.e32=(-l*g+p*x-_*y)*i,t.e03=(-a*z+r*C-c*V)*i,t.e13=(e*z-o*C+n*V)*i,t.e23=(-f*w+b*v-d*y)*i,void(t.e33=(l*w-p*v+u*y)*i)):!1},multiply:function(t){var i=this.e00,e=this.e10,o=this.e20,n=this.e30,s=this.e01,a=this.e11,r=this.e21,c=this.e31,h=this.e02,l=this.e12,p=this.e22,u=this.e32,_=this.e03,f=this.e13,b=this.e23,d=this.e33,m=t.e00,y=t.e10,v=t.e20,x=t.e30;this.e00=m*i+y*s+v*h+x*_,this.e10=m*e+y*a+v*l+x*f,this.e20=m*o+y*r+v*p+x*b,this.e30=m*n+y*c+v*u+x*d,m=t.e01,y=t.e11,v=t.e21,x=t.e31,this.e01=m*i+y*s+v*h+x*_,this.e11=m*e+y*a+v*l+x*f,this.e21=m*o+y*r+v*p+x*b,this.e31=m*n+y*c+v*u+x*d,m=t.e02,y=t.e12,v=t.e22,x=t.e32,this.e02=m*i+y*s+v*h+x*_,this.e12=m*e+y*a+v*l+x*f,this.e22=m*o+y*r+v*p+x*b,this.e32=m*n+y*c+v*u+x*d,m=t.e03,y=t.e13,v=t.e23,x=t.e33,this.e03=m*i+y*s+v*h+x*_,this.e13=m*e+y*a+v*l+x*f,this.e23=m*o+y*r+v*p+x*b,this.e33=m*n+y*c+v*u+x*d}},Object.defineProperty(e.Matrix4.prototype,"data",{get:function(){return[this.e00,this.e10,this.e20,this.e30,this.e01,this.e11,this.e21,this.e31,this.e02,this.e12,this.e22,this.e32,this.e03,this.e13,this.e23,this.e33]}}),e.Quaternion=function(t,i,e,o){this.x=null!=t?t:0,this.y=null!=i?i:0,this.z=null!=e?e:0,this.w=null!=o?o:1,this.normalize()},e.Quaternion.prototype={set:function(t,i,e,o){this.x=t,this.y=i,this.z=e,this.w=o},copy:function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},toString:function(){return"("+this.x+", "+this.y+", "+this.z+", "+this.w+")"},multiply:function(t){var i=this.x,e=this.y,o=this.z,n=this.w,s=t.x,a=t.y,r=t.z,c=t.w;this.x=i*c+n*s+e*r-o*a,this.y=e*c+n*a+o*s-i*r,this.z=o*c+n*r+i*a-e*s,this.w=n*c-i*s-e*a-o*r},multiplyQuaternions:function(t,i){this.x=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,this.y=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,this.z=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,this.w=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z},normalize:function(){var t=this.x,i=this.y,e=this.z,o=this.w,n=Math.sqrt(t*t+i*i+e*e+o*o);0===n?this.x=this.y=this.z=this.w=0:(n=1/n,this.x*=n,this.y*=n,this.z*=n,this.w*=n)},invertQuaternion:function(t){var i=t.x,e=t.y,o=t.z,n=t.w,s=i*i+e*e+o*o+n*n;if(0===s)this.x=this.y=this.z=this.w=0;else{var a=-1/s;this.x=t.x*a,this.y=t.y*a,this.z=t.z*a,this.w=t.w*-a}},transformVector3:function(t){var i=t.x,e=t.y,o=t.z,n=this.x,s=this.y,a=this.z,r=this.w,c=r*i+s*o-a*e,h=r*e+a*i-n*o,l=r*o+n*e-s*i,p=-n*i-s*e-a*o;t.x=c*r+p*-n+h*-a-l*-s,t.y=h*r+p*-s+l*-n-c*-a,t.z=l*r+p*-a+c*-s-h*-n},transformVector3Into:function(t,i){var e=t.x,o=t.y,n=t.z,s=this.x,a=this.y,r=this.z,c=this.w,h=c*e+a*n-r*o,l=c*o+r*e-s*n,p=c*n+s*o-a*e,u=-s*e-a*o-r*n;i.x=h*c+u*-s+l*-r-p*-a,i.y=l*c+u*-a+p*-s-h*-r,i.z=p*c+u*-r+h*-a-l*-s},setFromMat4:function(t){var i,e,o,n,s,a,r,c,h,l,p,u,_,f,b;return i=t.e00,e=t.e10,o=t.e20,n=t.e01,s=t.e11,a=t.e21,r=t.e02,c=t.e12,h=t.e22,_=1/Math.sqrt(i*i+e*e+o*o),f=1/Math.sqrt(n*n+s*s+a*a),b=1/Math.sqrt(r*r+c*c+h*h),i*=_,e*=_,o*=_,n*=f,s*=f,a*=f,r*=b,c*=b,h*=b,l=i+s+h,l>=0?(p=Math.sqrt(l+1),this.w=.5*p,p=.5/p,this.x=(a-c)*p,this.y=(r-o)*p,this.z=(e-n)*p):i>s?i>h?(u=i-(s+h)+1,u=Math.sqrt(u),this.x=.5*u,u=.5/u,this.w=(a-c)*u,this.y=(e+n)*u,this.z=(o+r)*u):(u=h-(i+s)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(e-n)*u,this.x=(r+o)*u,this.y=(c+a)*u):s>h?(u=s-(h+i)+1,u=Math.sqrt(u),this.y=.5*u,u=.5/u,this.w=(r-o)*u,this.z=(a+c)*u,this.x=(n+e)*u):(u=h-(i+s)+1,u=Math.sqrt(u),this.z=.5*u,u=.5/u,this.w=(e-n)*u,this.x=(r+o)*u,this.y=(c+a)*u),this},angleBetween:function(t){return 2*Math.acos(this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w)},signedAngleBetween:function(t,i){return Math.abs(a.dot(i))<.5?o.set(1,0,0):o.set(0,0,1),this.transformVector3Into(o,n),t.transformVector3Into(o,s),o.crossVectors(n,s),Math.atan2(i.dot(o),n.dot(s))},isZero:function(){return(0===this.x||Math.abs(this.x)<e.EPSILON)&&(0===this.y||Math.abs(this.y)<e.EPSILON)&&(0===this.z||Math.abs(this.z)<e.EPSILON)}},e.Quaternion.IDENTITY=new e.Quaternion,e.Math.Utils={clamp:function(t,i,e){return i>t?i:t>e?e:t}},e.Vector3=function(t,i,e){this.x=t||0,this.y=i||0,this.z=e||0},e.Vector3.prototype={set:function(t,i,e){this.x=t,this.y=i,this.z=e},copy:function(t){this.x=t.x,this.y=t.y,this.z=t.z},add:function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},addVectors:function(t,i){this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z},subtract:function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},subtractVectors:function(t,i){this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z},multiply:function(t){this.x*=t.x,this.y*=t.y,this.z*=t.z},multiplyVectors:function(t,i){this.x=t.x*i.x,this.y=t.y*i.y,this.z=t.z*i.z},scale:function(t){this.x*=t,this.y*=t,this.z*=t},scaleVector:function(t,i){this.x=t.x*i,this.y=t.y*i,this.z=t.z*i},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){var t=this.length();return 0===t?this.x=this.y=this.z=0:this.scale(1/t),t},normalizeVector:function(t){return this.copy(t),this.normalize()},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){var i=this.x,e=this.y,o=this.z;this.x=e*t.z-o*t.y,this.y=o*t.x-i*t.z,this.z=i*t.y-e*t.x},crossVectors:function(t,i){this.x=t.y*i.z-t.z*i.y,this.y=t.z*i.x-t.x*i.z,this.z=t.x*i.y-t.y*i.x},distanceTo:function(t){var i=t.x-this.x,e=t.y-this.y,o=t.z-this.z;return Math.sqrt(i*i+e*e+o*o)},findOrthogonal:function(t,i){var e,o;Math.abs(this.z)>.7071067811865476?(e=-this.y*this.y+this.z*this.z,o=1/Math.sqrt(e),t.set(0,-this.z*o,this.y*o),i.set(e*o,-this.x*t.z,this.x*t.y)):(e=this.x*this.x+this.y*this.y,o=1/Math.sqrt(e),t.set(-this.y*o,this.x*o,0),i.set(-this.z*t.y,this.z*t.x,e*o))},equals:function(t,i){return i=i||e.EPSILON,this.x!==t.x&&Math.abs(this.x-t.x)>i?!1:this.y!==t.y&&Math.abs(this.y-t.y)>i?!1:this.z!==t.z&&Math.abs(this.z-t.z)>i?!1:!0},isZero:function(){return(0===this.x||Math.abs(this.x)<e.EPSILON)&&(0===this.y||Math.abs(this.y)<e.EPSILON)&&(0===this.z||Math.abs(this.z)<e.EPSILON)},isParallelTo:function(){var t=new e.Vector3;return function(i){return t.crossVectors(this,i),t.isZero()}}(),isParallelToNormalized:function(t){var i=Math.abs(this.dot(t));return i>1-e.EPSILON&&i<1+e.EPSILON}},e.Math={},e.EPSILON=1e-5;{var o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3(1,0,0),r=new e.Vector3(0,1,0),c=new e.Vector3(0,0,1),h=new e.Quaternion,l=new e.Quaternion,p=new e.Matrix3,u=new e.Matrix3;new e.Matrix4}e.EventEmitter=function(){},e.EventEmitter.prototype={addListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]),-1===this.listeners[t].indexOf(i)&&this.listeners[t].push(i)},removeListener:function(t,i){null==this.listeners[t]&&(this.listeners[t]=[]);var e=this.listeners[t].indexOf(i);-1!==e&&this.listeners[t].splice(e,1)},removeAllListeners:function(){for(var t=Object.keys(this.listeners),i=0;i<t.length;i++)this.listeners[t[i]].length=0},emit:function(t){var i,e=Array.prototype.slice.call(arguments,1);if(this.listeners[t]instanceof Array)for(var o=this.listeners[t].slice(),n=0;n<o.length;n++)if(i=o[n].apply(this,e),i===!1)return!1}},e.EventEmitter.apply=function(t){t.prototype.addListener=e.EventEmitter.prototype.addListener,t.prototype.removeListener=e.EventEmitter.prototype.removeListener,t.prototype.removeAllListeners=e.EventEmitter.prototype.removeAllListeners,t.prototype.emit=e.EventEmitter.prototype.emit},e.RigidBody=function(t,i){this.id=e.RigidBody._uid++,this.version=0,this.shape=t,this.aabb=new e.AABB,this.faceNormals=[],this._mass=i||1/0,this._mass_inverted=1/i,this._is_static=!1,this._is_kinematic=!1,this.use_gravity=!0,this.position=new e.Vector3,this.rotation=new e.Quaternion(0,0,0,1),this.linear_velocity=new e.Vector3,this.angular_velocity=new e.Vector3,this.transform=new e.Matrix4,this.transform.identity(),this.transform_inverse=new e.Matrix4,this.transform_inverse.identity(),this._computeInertiaTensor(),this.inverseInertiaTensor=new e.Matrix3,this.inertiaTensor.invertInto(this.inverseInertiaTensor),this.inertiaTensorWorldFrame=new e.Matrix3,this.inverseInertiaTensorWorldFrame=new e.Matrix3,this.acceleration=new e.Vector3,this.restitution=0,this.friction=.6,this.gravity=null,this.linear_acceleration=new e.Vector3,this.angular_acceleration=new e.Vector3,this.linear_damping=0,this.angular_damping=0,this.linear_factor=new e.Vector3(1,1,1),this.angular_factor=new e.Vector3(1,1,1),this.center_of_mass=new e.Vector3(0,0,0),this.world=null,this._layer=null,this.accumulated_force=new e.Vector3,this.accumulated_torque=new e.Vector3,this._world_transform=new e.Matrix4,this.push_velocity=new e.Vector3,this.turn_velocity=new e.Vector3,this.solver_impulse=new Float64Array(6),this.onSpeculativeContact=null,this.is_trigger=!1,this.listeners={},this.onTriggerContactEnter=null,this.onCollisionContactEnter=null,this.onCollisionContactStay=null,this.onCollisionContactExit=null},e.RigidBody._uid=0,e.EventEmitter.apply(e.RigidBody),Object.defineProperty(e.RigidBody.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t,this._mass_inverted=1/t,this.updateShapeDerivedValues()}}),Object.defineProperty(e.RigidBody.prototype,"is_kinematic",{get:function(){return this._is_kinematic},set:function(t){t!==this._is_kinematic&&(this.world&&this.world.updateObjectKinematicFlag(this,t),this._is_kinematic=t),this.updateShapeDerivedValues()}}),Object.defineProperty(e.RigidBody.prototype,"layer",{get:function(){return this._layer},set:function(t){t!==this._layer&&(this.world&&this.world.updateObjectLayer(this,t),this.version++,this._layer=t)}}),Object.defineProperty(e.RigidBody.prototype,"is_static",{get:function(){return this._is_static},set:function(t){t!==this._is_static&&(this.world&&this.world.updateObjectStaticFlag(this,t),this._is_static=t)}}),e.RigidBody.prototype.markDynamic=function(){this.world.broadphase.markDynamic(this)},e.RigidBody.prototype.setTransform=function(t,i){this.rotation.copy(i),this.rotation.transformVector3Into(this.center_of_mass,o),this.position.copy(t),this.position.add(o)},e.RigidBody.prototype.getTransform=function(t,i){this.updateDerived(),i.copy(this.rotation),this.rotation.transformVector3Into(this.center_of_mass,o),t.copy(this.position),t.sub(o)},e.RigidBody.prototype.updateShapeDerivedValues=function(){return this.version++,this.shape.center_of_mass?(this.shape.updateCenterOfMass(),this.shape.updateAABB(),this.aabb.transform(this.shape.aabb,this.transform),this._computeInertiaTensor(),o.copy(this.shape.center_of_mass),o.subtract(this.center_of_mass),this.rotation.transformVector3Into(o,n),this.position.add(n),this.center_of_mass.copy(this.shape.center_of_mass),void this.updateFaceNormals()):void this._computeInertiaTensor()},e.RigidBody.prototype._computeInertiaTensor=function(){this.inertiaTensor=this.shape.getInertiaTensor(this._is_kinematic?1/0:this._mass)},e.RigidBody.prototype.findSupportPoint=function(){var t=new e.Vector3;return function(i,e){this.transform_inverse.rotateVector3Into(i,t),this.shape.findSupportPoint(t,e),this.transform.transformVector3(e)}}(),e.RigidBody.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o,n,s){this.transform_inverse.transformVector3Into(e,t),this.transform_inverse.transformVector3Into(o,i);var a=this.shape.rayIntersect(t,i,n-s.length);null===a||Array.isArray(a)||(a=[a]);for(var r=0;r<a.length;r++){var c=a[r];c.object=this,this.transform.transformVector3(c.point),this.transform.rotateVector3(c.normal),s.push(c)}}}(),e.RigidBody.prototype.integrate=function(t){this._mass!==1/0&&(o.scaleVector(this.accumulated_force,this._mass_inverted),o.multiply(this.linear_factor),this.linear_velocity.add(o),this.inverseInertiaTensorWorldFrame.transformVector3Into(this.accumulated_torque,o),o.multiply(this.angular_factor),this.angular_velocity.add(o),this.linear_velocity.scale(Math.max(0,1-this.linear_damping*t)),this.angular_velocity.scale(Math.max(0,1-this.angular_damping*t)),this.integratePosition(t,this.linear_velocity),this.integrateRotation(t,this.angular_velocity),this.accumulated_force.x=this.accumulated_force.y=this.accumulated_force.z=0,this.accumulated_torque.x=this.accumulated_torque.y=this.accumulated_torque.z=0,this.solver_impulse[0]=this.solver_impulse[1]=this.solver_impulse[2]=this.solver_impulse[3]=this.solver_impulse[4]=this.solver_impulse[5]=0,this.push_velocity.x=this.push_velocity.y=this.push_velocity.z=0,this.turn_velocity.x=this.turn_velocity.y=this.turn_velocity.z=0)},e.RigidBody.prototype.integratePosition=function(t,i){o.scaleVector(i,t),this.position.add(o)},e.RigidBody.prototype.integrateRotation=function(t,i){o.copy(i);var e=o.length();e*t>Math.PI/4&&(e=Math.PI/4/t),o.scale(.001>e?.5*t-t*t*t*.020833333333*e*e:Math.sin(.5*e*t)/e),h.x=o.x,h.y=o.y,h.z=o.z,h.w=Math.cos(e*t*.5),h.multiply(this.rotation),this.rotation.copy(h)},e.RigidBody.prototype.setGravity=function(t,i,o){this.gravity?(this.gravity.x=t,this.gravity.y=i,this.gravity.z=o):this.gravity=new e.Vector3(t,i,o)},e.RigidBody.prototype.applyImpulse=function(t){o.multiplyVectors(t,this.linear_factor),this.linear_velocity.add(o)},e.RigidBody.prototype.addLinearAcceleration=function(t){this.linear_acceleration.add(t)},e.RigidBody.prototype.addAngularAcceleration=function(t){this.angular_acceleration.add(t)},e.RigidBody.prototype.applyForce=function(t){this.accumulated_force.add(t)},e.RigidBody.prototype.applyTorque=function(t){this.accumulated_torque.add(t)},e.RigidBody.prototype.applyForceAtWorldPoint=function(t,i){o.copy(i),o.subtract(this.position),o.cross(t),this.accumulated_force.add(t),this.accumulated_torque.add(o)},e.RigidBody.prototype.applyForceAtLocalPoint=function(t,i){this.transform.transformVector3Into(i,n),this.applyForceAtWorldPoint(t,n)},e.RigidBody.prototype.getVelocityInLocalPoint=function(t,i){this._mass===1/0?i.set(0,0,0):(i.copy(this.angular_velocity),i.cross(t),i.add(this.linear_velocity))},e.RigidBody.prototype.updateDerived=function(){this.rotation.normalize(),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this._mass!==1/0&&(p.fromMatrix4(this.transform_inverse),p.transposeInto(u),u.multiply(this.inertiaTensor),this.inertiaTensorWorldFrame.multiplyFrom(u,p),this.inertiaTensorWorldFrame.invertInto(this.inverseInertiaTensorWorldFrame)),this.aabb.transform(this.shape.aabb,this.transform),this.updateFaceNormals()},e.RigidBody.prototype.updateFaceNormals=function(){if(this.rotation.isZero())return void(this.faceNormals=this.shape.faceNormals);this.faceNormals.length=0;for(var t=0;t<this.shape.faceNormals.length;t++){var i=new e.Vector3;this.rotation.transformVector3Into(this.shape.faceNormals[t],i),this.faceNormals.push(i)}},e.ForceGenerator=function(t){this.force=t||new e.Vector3,this.enabled=!0,this.affected=[]},e.ForceGenerator.prototype.applyForce=function(){if(this.enabled){var t,i;for(t=0,i=this.affected.length;i>t;t++)this.affected[t].applyForce(this.force)}},e.ForceGenerator.prototype.enable=function(){this.enabled=!0},e.ForceGenerator.prototype.disable=function(){this.enabled=!1},e.ForceGenerator.prototype.affect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return;this.affected.push(t)},e.ForceGenerator.prototype.unaffect=function(t){var i,e;for(i=0,e=this.affected.length;e>i;i++)if(this.affected[i]===t)return void this.affected.splice(i,1)},e.BasicBroadphase=function(){this.bodies=[],this.collision_pairs=[]},e.BasicBroadphase.prototype.getDynamicBodies=function(){return this.bodies},e.BasicBroadphase.prototype.addBody=function(t){this.bodies.push(t)},e.BasicBroadphase.prototype.removeBody=function(t){this._removeBodyFrom(t,this.bodies)},e.BasicBroadphase.prototype._removeBodyFrom=function(t,i){var e,o=i.length;for(e=0;o>e;e++)if(i[e]===t){i[e]=i[i.length-1],i.pop();break}},e.BasicBroadphase.prototype.update=function(){var t,i,o,n,s=this.bodies.length;for(this.collision_pairs.length=0,t=0;s>t;t++)for(o=this.bodies[t],i=0;s>i;i++)i>=t||(n=this.bodies[i],e.CollisionUtils.canBodiesCollide(o,n)&&o.aabb.intersects(n.aabb)&&this.collision_pairs.push([n,o]))},e.BasicBroadphase.prototype.intersectsWith=function(t){var i,e,o=this.bodies.length,n=[];for(i=0;o>i;i++)e=this.bodies[i],t!==e&&t.aabb.intersects(e.aabb)&&n.push(e);return n},e.BasicBroadphase.prototype.rayIntersect=function(t,i){var e,o,n=this.bodies.length,s=[];for(e=0;n>e;e++)o=this.bodies[e],o.aabb.testRayIntersect(t,i)&&o.rayIntersect(t,i,s);return s},e.BasicPooledBroadphase=function(){e.BasicBroadphase.call(this),this.static_bodies=[],this.dynamic_bodies=[],this.kinematic_bodies=[],this._layers=new Array(32);for(var t=0;32>t;t++)this._layers[t]=[]},e.BasicPooledBroadphase.prototype=Object.create(e.BasicBroadphase.prototype),e.BasicPooledBroadphase.prototype.getDynamicBodies=function(){return this.dynamic_bodies},e.BasicBroadphase.prototype.updateObjectLayer=function(t,i){null!==t._layer&&this._layers[t._layer]&&this._removeBodyFrom(t,this._layers[t._layer]),null!==i&&this._layers[i].push(t)},e.BasicBroadphase.prototype._getBodyPool=function(t){return t._is_static?this.static_bodies:t._is_kinematic?this.kinematic_bodies:this.dynamic_bodies},e.BasicBroadphase.prototype.markDynamic=function(t){this._removeBodyFrom(t,this._getBodyPool(t)),this.dynamic_bodies.push(t)},e.BasicBroadphase.prototype.updateObjectStaticFlag=function(t,i){this._removeBodyFrom(t,this._getBodyPool(t)),t._is_static=i,this._getBodyPool(t).push(t)},e.BasicBroadphase.prototype.updateObjectKinematicFlag=function(t,i){this._removeBodyFrom(t,this._getBodyPool(t)),t._is_kinematic=i,this._getBodyPool(t).push(t)},e.BasicPooledBroadphase.prototype.addBody=function(t){e.BasicBroadphase.prototype.addBody.call(this,t),this._getBodyPool(t).push(t),null!==t._layer&&this._layers[t._layer].push(t)},e.BasicPooledBroadphase.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o,n,s){t.copy(e),i.copy(o);for(var a=[],r=0;r<this._layers.length;r++){var c=this._layers[r];if(!s||0!==(s&1<<r))for(var h=0;h<c.length;h++){var l=c[h];if(l.aabb.testRayIntersect(t,i)&&l.rayIntersect(t,i,n,a),n&&a.length>=n)return a.slice(0,n)}}return a.sort(function(t,i){return t.t-i.t}),a}}(),e.BasicBroadphase.prototype.intersectsWith=function(t,i){for(var e=[],o=0;o<this._layers.length;o++){var n=this._layers[o];if(!i||0!==(i&1<<o))for(var s=0;s<n.length;s++){var a=n[s];t!==a&&t.aabb.intersects(a.aabb)&&e.push(a)}}return e},e.BasicPooledBroadphase.prototype.removeBody=function(t){e.BasicBroadphase.prototype.removeBody.call(this,t),this._removeBodyFrom(t,this._getBodyPool(t))},e.BasicPooledBroadphase.prototype.update=function(){var t,i,o,n;for(this.collision_pairs.length=0,t=0;t<this.dynamic_bodies.length;t++){for(o=this.dynamic_bodies[t],i=t+1;i<this.dynamic_bodies.length;i++)n=this.dynamic_bodies[i],e.CollisionUtils.canBodiesCollide(o,n)&&o.aabb.intersects(n.aabb)&&this.collision_pairs.push([n,o]);for(i=0;i<this.static_bodies.length;i++)n=this.static_bodies[i],e.CollisionUtils.canBodiesCollide(o,n)&&o.aabb.intersects(n.aabb)&&this.collision_pairs.push([n,o]);for(i=0;i<this.kinematic_bodies.length;i++)n=this.kinematic_bodies[i],e.CollisionUtils.canBodiesCollide(o,n)&&o.aabb.intersects(n.aabb)&&this.collision_pairs.push([n,o])}},function(){var t=function(t,i,e){this.type=t,this.body=i,this.position=e,this.prev=null,this.next=null};t.TYPES={START:0,END:1};var i=function(){this.first=null,this.last=null};e.SAPBroadphase=function(){this.markers_x=new i,this.markers_y=new i,this.markers_z=new i,this.overlap_counter={},this.collision_pairs=[],this.pending_bodies=[]},e.SAPBroadphase.prototype={incrementOverlaps:function(t,i){if(e.CollisionUtils.canBodiesCollide(t,i)){var o=t.id<i.id?t.id+"-"+i.id:i.id+"-"+t.id;this.overlap_counter.hasOwnProperty(o)||(this.overlap_counter[o]=0),this.overlap_counter[o]++,3===this.overlap_counter[o]&&this.collision_pairs.push([t.id<i.id?t:i,t.id<i.id?i:t])}},decrementOverlaps:function(t,i){var e=t.id<i.id?t.id+"-"+i.id:i.id+"-"+t.id;this.overlap_counter.hasOwnProperty(e)||(this.overlap_counter[e]=0),this.overlap_counter[e]--,0===this.overlap_counter[e]?delete this.overlap_counter[e]:2===this.overlap_counter[e]&&(this.collision_pairs=this.collision_pairs.filter(function(e){return e[0]===t&&e[1]===i?!1:e[0]===i&&e[1]===t?!1:!0}))},updateObjectStaticFlag:function(t,i){},updateObjectKinematicFlag:function(t,i){},updateObjectLayer:function(t,i){},addBody:function(t){this.pending_bodies.push(t)},removeBody:function(t){var i=this.pending_bodies.indexOf(t);if(-1!==i)return void this.pending_bodies.splice(i,1);for(var e,o,n=this.markers_x.first;n;)n.body===t&&(e=n.next,o=n.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_x.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_x.first=e),n=n.next;for(n=this.markers_y.first;n;)n.body===t&&(e=n.next,o=n.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_y.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_y.first=e),n=n.next;for(n=this.markers_z.first;n;)n.body===t&&(e=n.next,o=n.prev,null!=e?(e.prev=o,null!=o&&(o.next=e)):this.markers_z.last=o,null!=o?(o.next=e,null!=e&&(e.prev=o)):this.markers_z.first=e),n=n.next;this.collision_pairs=this.collision_pairs.filter(function(i){return i[0]===t||i[1]===t?!1:!0})},insertPending:function(){for(var i;i=this.pending_bodies.pop();){i.updateDerived();var e=new t(t.TYPES.START,i,i.aabb.min.x),o=new t(t.TYPES.START,i,i.aabb.min.y),n=new t(t.TYPES.START,i,i.aabb.min.z),s=new t(t.TYPES.END,i,i.aabb.max.x),a=new t(t.TYPES.END,i,i.aabb.max.y),r=new t(t.TYPES.END,i,i.aabb.max.z);this.insert(this.markers_x,e),this.insert(this.markers_x,s),this.insert(this.markers_y,o),this.insert(this.markers_y,a),this.insert(this.markers_z,n),this.insert(this.markers_z,r)}},insert:function(t,i){null==t.first?t.first=t.last=i:(i.prev=t.last,t.last.next=i,t.last=i,this.sort(t,i))},sort:function(i,e){for(var o;null!=e.prev&&(e.position<e.prev.position||e.position===e.prev.position&&e.type===t.TYPES.START&&e.prev.type===t.TYPES.END);)o=e.prev,e.type!==o.type&&(e.type===t.TYPES.START?this.incrementOverlaps(e.body,o.body):this.decrementOverlaps(e.body,o.body)),e.prev=o.prev,o.next=e.next,e.next=o,o.prev=e,null==e.prev?i.first=e:e.prev.next=e,null==o.next?i.last=o:o.next.prev=o},update:function(){this.insertPending();for(var i=this.markers_x.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.x:i.body.aabb.max.x,this.sort(this.markers_x,i),i=i.next;for(i=this.markers_y.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.y:i.body.aabb.max.y,this.sort(this.markers_y,i),i=i.next;for(i=this.markers_z.first;i;)i.position=i.type===t.TYPES.START?i.body.aabb.min.z:i.body.aabb.max.z,this.sort(this.markers_z,i),i=i.next},intersectsWith:function(t){this.addBody(t),this.update();var i=this.collision_pairs.filter(function(i){return i[0]===t||i[1]===t?!0:!1}).map(function(i){return i[0]===t?i[1]:i[0]});return this.removeBody(t),i},rayIntersect:function(i,e,o,n){this.pending_bodies.length>0&&this.update();var s,a,r,c,h,l,p,u,_={},f=[],b={},d={};for(r=this.markers_x.first,c=!1,_={},s=i.x<e.x?i.x:e.x,a=i.x<e.x?e.x:i.x;r;){if(r.type===t.TYPES.START&&(_[r.body.id]=r.body),r.position>=s)if(c===!1)for(c=!0,u=Object.keys(_),h=0;h<u.length;h++)p=u[h],l=_[p],null!=l&&(b[l.id]=l,d[l.id]=d[l.id]?d[l.id]+1:1);else r.type===t.TYPES.START&&(b[r.body.id]=r.body,d[r.body.id]=d[r.body.id]?d[r.body.id]+1:1);if(r.type===t.TYPES.END&&(_[r.body.id]=null),r.position>a)break;r=r.next}for(u=Object.keys(d),h=0;h<u.length;h++){var m=u[h];1===d[m]&&b[m].aabb.testRayIntersect(i,e)&&b[m].rayIntersect(i,e,o,f)}return f}}}(),e.Collision.boxSphere=function(t,i,a){var r=null,c=null;t.shape.shapeType===e.Shapes.Type.SphereShape?(r=t,c=i):(r=i,c=t);var h=null,l=0;return c.transform_inverse.transformVector3Into(r.position,o),Math.abs(o.x)-r.shape.radius>c.shape.half_width||Math.abs(o.y)-r.shape.radius>c.shape.half_height||Math.abs(o.z)-r.shape.radius>c.shape.half_depth?null:(n.x=n.y=n.z=0,l=o.x,l>c.shape.half_width?l=c.shape.half_width:l<-c.shape.half_width&&(l=-c.shape.half_width),n.x=l,l=o.y,l>c.shape.half_height?l=c.shape.half_height:l<-c.shape.half_height&&(l=-c.shape.half_height),n.y=l,l=o.z,l>c.shape.half_depth?l=c.shape.half_depth:l<-c.shape.half_depth&&(l=-c.shape.half_depth),n.z=l,s.subtractVectors(n,o),l=s.lengthSquared(),l>r.shape.radius*r.shape.radius?null:(h=e.ObjectPool.getObject("ContactDetails"),h.object_a=r,h.object_b=c,a?(h.is_lightweight=!0,[h]):(0===l?e.Collision.boxSphere.spherePenetration(c.shape,o,n,h):(h.contact_normal.subtractVectors(n,o),h.penetration_depth=-h.contact_normal.length(),h.contact_normal.scale(-1/h.penetration_depth),h.contact_point_in_b.copy(n)),h.penetration_depth+=r.shape.radius,c.transform.rotateVector3(h.contact_normal),r.transform_inverse.rotateVector3Into(h.contact_normal,h.contact_point_in_a),h.contact_point_in_a.scale(r.shape.radius),h.contact_point.scaleVector(h.contact_normal,r.shape.radius-h.penetration_depth/2),h.contact_point.add(r.position),[h])))},e.Collision.boxSphere.spherePenetration=function(t,i,e,o){var s,a;i.x<0?(s=t.half_width+i.x,e.x=-t.half_width,e.y=e.z=0,o.penetration_depth=s):(s=t.half_width-i.x,e.x=t.half_width,e.y=e.z=0,o.penetration_depth=s),i.y<0?(a=t.half_height+i.y,s>a&&(s=a,e.y=-t.half_height,e.x=e.z=0,o.penetration_depth=s)):(a=t.half_height-i.y,s>a&&(s=a,e.y=t.half_height,e.x=e.z=0,o.penetration_depth=s)),i.z<0?(a=t.half_depth+i.z,s>a&&(e.z=-t.half_depth,e.x=e.y=0,o.penetration_depth=s)):(a=t.half_depth-i.z,s>a&&(e.z=t.half_depth,e.x=e.y=0,o.penetration_depth=s)),o.contact_point_in_b.copy(n),o.contact_normal.scaleVector(o.contact_point_in_b,-1),o.contact_normal.normalize()},e.Collision.capsuleCapsule=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=new e.Vector3,c=new e.Vector3,h=new e.Vector3,l=new e.Vector3;return function(p,u,_){t.set(0,p.shape.half_height,0),i.set(0,-p.shape.half_height,0),
p.transform.transformVector3(t),p.transform.transformVector3(i),o.set(0,u.shape.half_height,0),n.set(0,-u.shape.half_height,0),u.transform.transformVector3(o),u.transform.transformVector3(n);var f=Math.sqrt(e.GeometryMethods.findClosestPointsOnSegments(t,i,o,n,s,a)),b=p.shape.radius+u.shape.radius;if(f>b)return null;var d=e.ObjectPool.getObject("ContactDetails");if(d.object_a=p,d.object_b=u,_)return d.is_lightweight=!0,[d];f<e.EPSILON?d.contact_normal.set(0,1,0):(d.contact_normal.subtractVectors(a,s),d.contact_normal.normalize()),d.penetration_depth=b-f,r.subtractVectors(i,t),r.normalize(),c.subtractVectors(n,o),c.normalize();var m=r.isParallelToNormalized(c);if(!m)return e.Collision.capsuleCapsule._fillContactWithDetails(d,s,a),[d];var y=e.GeometryMethods.findClosestPointToPlaneOnLineSegment(t,r,o,n,h),v=-e.GeometryMethods.findClosestPointToPlaneOnLineSegment(i,r,o,n,l);if(0>y||0>v)return e.Collision.capsuleCapsule._fillContactWithDetails(d,s,a),[d];var x=d,w=e.ObjectPool.getObject("ContactDetails");return w.object_a=p,w.object_b=u,w.contact_normal.copy(x.contact_normal),w.penetration_depth=x.penetration_depth,0===y?e.Collision.capsuleCapsule._fillContactWithDetails(x,t,h):(s.scaleVector(r,y),s.add(t),e.Collision.capsuleCapsule._fillContactWithDetails(x,s,h)),0===v?e.Collision.capsuleCapsule._fillContactWithDetails(w,i,l):(s.scaleVector(r,-v),s.add(i),e.Collision.capsuleCapsule._fillContactWithDetails(w,s,l)),[x,w]}}(),e.Collision.capsuleCapsule._fillContactWithDetails=function(t,i,e){t.contact_point_in_a.scaleVector(t.contact_normal,t.object_a.shape.radius),t.contact_point_in_a.add(i),t.contact_point_in_b.scaleVector(t.contact_normal,-t.object_b.shape.radius),t.contact_point_in_b.add(e),t.contact_point.addVectors(t.contact_point_in_a,t.contact_point_in_b),t.contact_point.scale(.5),t.object_a.transform_inverse.transformVector3(t.contact_point_in_a),t.object_b.transform_inverse.transformVector3(t.contact_point_in_b)},e.Collision.capsuleConvexHull=function(){var t=new e.Vector3,i=new e.Vector3;return function(o,n,s){var a,r;o.shape.shapeType===e.Shapes.Type.CapsuleShape?(a=o,r=n):(a=n,r=o),t.set(0,a.shape.half_height,0),i.set(0,-a.shape.half_height,0),a.transform.transformVector3(t),a.transform.transformVector3(i);var c=e.GjkEpa.findClosestPointOnObjectToLineSegment(r,t,i);return null!==c?e.Collision.capsuleConvexHull._shallowCapsuleConvexHull(a,r,c,t,i,s):e.Collision.capsuleConvexHull._deepCapsuleConvexHull(a,r,t,i,s)}}(),e.Collision.capsuleConvexHull._shallowCapsuleConvexHull=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Quaternion,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=new e.Vector3;return function(c,h,l,p,u,_){e.GeometryMethods.findClosestPointOnASegment(p,u,l,t),i.subtractVectors(l,t);var f=i.normalize(),b=c.shape.radius-f;if(0>b)return null;var d=e.ObjectPool.getObject("ContactDetails");if(d.object_a=c,d.object_b=h,_)return d.is_lightweight=!0,[d];d.penetration_depth=b,d.contact_normal.copy(i),r.subtractVectors(u,p),r.normalize();var m=r.dot(i);if(Math.abs(m)>e.Collision.capsuleConvexHull._epsilon)return e.Collision.capsuleConvexHull._fillContactWithDetails(d,t,l),[d];o.invertQuaternion(h.rotation),o.transformVector3Into(i,n),n.scale(-1);for(var y=null,v=0;v<h.shape.faces.length;v++){var x=h.shape.faces[v];if(x.normal.equals(n,e.Collision.capsuleConvexHull._epsilon)){y=x;break}}if(null===y)return e.Collision.capsuleConvexHull._fillContactWithDetails(d,t,l),[d];var w=e.Collision.capsuleConvexHull._clipLineSegmentWithFace(p,u,y,s,a);if(!w)return e.Collision.capsuleConvexHull._fillContactWithDetails(d,t,l),[d];var g=d,j=e.ObjectPool.getObject("ContactDetails");return j.object_a=c,j.object_b=h,j.contact_normal.copy(g.contact_normal),j.penetration_depth=g.penetration_depth,g.contact_point_in_b.scaleVector(i,c.shape.radius-b),g.contact_point_in_b.add(s),j.contact_point_in_b.scaleVector(i,c.shape.radius-b),j.contact_point_in_b.add(a),e.Collision.capsuleConvexHull._fillContactWithDetails(g,s,g.contact_point_in_b),e.Collision.capsuleConvexHull._fillContactWithDetails(j,a,j.contact_point_in_b),[g,j]}}(),e.Collision.capsuleConvexHull._deepCapsuleConvexHull=function(){var t=new e.Vector3;return function(i,o,n,s,a){var r=e.ObjectPool.getObject("ContactDetails");if(r.object_a=i,r.object_b=o,a)return r.is_lightweight=!0,[r];t.subtractVectors(n,s),t.normalize();for(var c=[],h=0;h<o.shape.faceNormals.length;h++){var l=o.shape.faceNormals[h],p=new e.Vector3;o.rotation.transformVector3Into(l,p),c.push(p)}for(h=0;h<o.shape.edgeDirections;h++){var u=o.shape.edgeDirections[h],_=new e.Vector3;o.rotation.transformVector3Into(u,_),_.cross(t),_.scale(-1),c.push(_)}var f=e.Collision.SAT.performSat(i,o,c);if(null===f)throw new Error("Inner segment of the capsule overlaps convex hull, but SAT does not think so.");return f.axisId<o.shape.faceNormals.length?e.Collision.capsuleConvexHull._deepCapsuleConvexHullOnFace(i,o,n,s,f,o.shape.faces[f.axisId]):null}}(),e.Collision.capsuleConvexHull._deepCapsuleConvexHullOnFace=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(n,s,a,r,c,h){t.subtractVectors(a,r),t.normalize();var l=a.dot(c.normal)<r.dot(c.normal)?a:r,p=e.ObjectPool.getObject("ContactDetails"),u=e.ObjectPool.getObject("ContactDetails");p.object_a=u.object_a=n,p.object_b=u.object_b=s,p.penetration_depth=u.penetration_depth=c.overlap,p.contact_normal.scaleVector(c.normal,-1),u.contact_normal.scaleVector(c.normal,-1),p.contact_point_in_b.scaleVector(p.contact_normal,-(c.overlap-n.shape.radius)),u.contact_point_in_b.copy(p.contact_point_in_b);var _=t.dot(p.contact_normal);if(Math.abs(_)>e.Collision.capsuleConvexHull._epsilon)return p.contact_point_in_b.add(l),e.Collision.capsuleConvexHull._fillContactWithDetails(p,l,p.contact_point_in_b),[p];var f=e.Collision.capsuleConvexHull._clipLineSegmentWithFace(a,r,h,i,o);return f?(p.contact_point_in_b.add(i),u.contact_point_in_b.add(o),e.Collision.capsuleConvexHull._fillContactWithDetails(p,i,p.contact_point_in_b),e.Collision.capsuleConvexHull._fillContactWithDetails(u,o,u.contact_point_in_b),[p,u]):(p.contact_point_in_b.add(l),e.Collision.capsuleConvexHull._fillContactWithDetails(p,l,p.contact_point_in_b),[p])}}(),e.Collision.capsuleConvexHull._fillContactWithDetails=function(t,i,e){t.contact_point_in_a.scaleVector(t.contact_normal,t.object_a.shape.radius),t.contact_point_in_a.add(i),t.contact_point_in_b.copy(e),t.contact_point.addVectors(t.contact_point_in_a,t.contact_point_in_b),t.contact_point.scale(.5),t.object_a.transform_inverse.transformVector3(t.contact_point_in_a),t.object_b.transform_inverse.transformVector3(t.contact_point_in_b)},e.Collision.capsuleConvexHull._clipLineSegmentWithFace=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=0,r=0,c=0,h=0;return function(l,p,u,_,f){_.copy(l),f.copy(p),h=e.GeometryMethods.projectPointOnPlane(u.edge.getTail().position,u.normal,l,t),e.GeometryMethods.projectPointOnPlane(u.edge.getTail().position,u.normal,p,i);var b=u.edge,d=!0,m=!0,y=0;do{var v=b.getHead().position,x=b.getTail().position;if(o.subtractVectors(x,v),n.crossVectors(u.normal,o),n.normalize(),a=v.dot(n),r=t.dot(n)-a,c=i.dot(n)-a,r>e.EPSILON&&(d=!1),c>e.EPSILON&&(m=!1),Math.sign(r)!==Math.sign(c)){var w=e.GeometryMethods.getLineSegmentsIntersection(v,x,t,i,s);if(w){y++;var g=r>0?_:f;if(g.scaleVector(u.normal,h),g.add(s),2===y)return!0;b=b.next}else b=b.next}else b=b.next}while(b!==u.edge);return 0!==y||d&&m}}(),e.Collision.capsuleConvexHull._epsilon=.01,e.Collision.Factory={_collisionTable:null,_populateCollisionTable:function(){var t={};t[e.Shapes.Type.SphereShape]=e.Collision.sphereSphere,t[e.Shapes.Type.SphereShape|e.Shapes.Type.BoxShape]=e.Collision.boxSphere,t[e.Shapes.Type.SphereShape|e.Shapes.Type.CapsuleShape]=e.Collision.sphereCapsule,t[e.Shapes.Type.SphereShape|e.Shapes.Type.ConvexHullShape]=e.Collision.sphereConvexHull,t[e.Shapes.Type.CapsuleShape]=e.Collision.capsuleCapsule,t[e.Shapes.Type.CapsuleShape|e.Shapes.Type.ConvexHullShape]=e.Collision.capsuleConvexHull,e.Collision.Factory._collisionTable=t},getCollisionMethod:function(t,i){return this._collisionTable||this._populateCollisionTable(),this._collisionTable[t.shapeType|i.shapeType]||e.GjkEpa.findContacts}},e.GjkEpa={margins:.01,result:null,max_iterations:20,epa_condition:.001,SupportPoint:function(t,i,e){this.witness_a=t,this.witness_b=i,this.point=e},findSupportPoint:function(){var t=new e.Vector3;return function(i,e,o,n){i.findSupportPoint(o,n.witness_a),t.scaleVector(o,-1),e.findSupportPoint(t,n.witness_b),n.point.subtractVectors(n.witness_a,n.witness_b)}}(),findContacts:function(t,i,o){var n=e.GjkEpa.GJK(t,i,o);if(n&&o){var s=e.ObjectPool.getObject("ContactDetails");return s.object_a=t,s.object_b=i,s.is_lightweight=!0,[s]}return null!=e.GjkEpa.result?[e.GjkEpa.result]:null!=n?[e.GjkEpa.EPA(n)]:null},findClosestPointOnObject:function(){var t=(new e.Vector3,new e.Vector3),i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3;return function(r,c){for(var h=new e.GjkEpa.Simplex(r,c,!0),l=h.addPoint();l;)l=h.addPoint();if(null===l)return e.GjkEpa.freeSimplex(h),null;for(h.updateDirection(),h.findPointClosestToOrigin(t);;){if(h.addPoint(),h.updateDirection(),h.findPointClosestToOrigin(i),i.lengthSquared()+e.EPSILON>=t.lengthSquared())break;t.copy(i)}h.findBarycentricCoordinatesOf(t,o);var p=new e.Vector3;return n.scaleVector(h.points[0].witness_a,o.x),s.scaleVector(h.points[1].witness_a,o.y),p.addVectors(n,s),h.points.length>2&&(a.scaleVector(h.points[2].witness_a,o.z),p.add(a)),e.GjkEpa.freeSimplex(h),p}}(),findClosestPointOnObjectToPoint:function(t,i){return e.GjkEpa.findClosestPointOnObject(t,new e.GjkEpa.PointProxy(i))},findClosestPointOnObjectToLineSegment:function(t,i,o){return e.GjkEpa.findClosestPointOnObject(t,new e.GjkEpa.LineSegmentProxy(i,o))},GJK:function(){return function(t,i,o){var n,s=new e.GjkEpa.Simplex(t,i,o);for(e.GjkEpa.result=null;n=s.addPoint(););return n===!1?(e.GjkEpa.freeSimplex(s),null):s}}(),freeSimplex:function(t){for(var i=0,o=t.points.length;o>i;i++)e.ObjectPool.freeObject("GJK2SupportPoint",t.points[i])},freePolyhedron:function(t){for(var i=e.ObjectPool.pools.GJK2SupportPoint,o=0,n=t.faces.length;i.length>0&&n>o;o++)-1===i.indexOf(t.faces[o].a)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].a),-1===i.indexOf(t.faces[o].b)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].b),-1===i.indexOf(t.faces[o].c)&&e.ObjectPool.freeObject("GJK2SupportPoint",t.faces[o].c)},EPA:function(){var t=new e.Vector3,i={a:new e.Vector3,b:new e.Vector3,c:new e.Vector3};return function(n){for(var s=new e.GjkEpa.Polyhedron(n),a=0;++a;){s.findFaceClosestToOrigin(),o.copy(s.closest_face_distance<e.EPSILON?s.faces[s.closest_face].normal:s.closest_point);var r=e.ObjectPool.getObject("GJK2SupportPoint");e.GjkEpa.findSupportPoint(n.object_a,n.object_b,o,r),o.subtractVectors(r.point,s.closest_point);var c=o.lengthSquared();if(a===e.GjkEpa.max_iterations||c<e.GjkEpa.epa_condition&&s.closest_face_distance>e.EPSILON){var h=e.ObjectPool.getObject("ContactDetails");return h.object_a=n.object_a,h.object_b=n.object_b,h.contact_normal.normalizeVector(s.closest_point),0===h.contact_normal.lengthSquared()&&h.contact_normal.subtractVectors(h.object_b.position,h.object_a.position),h.contact_normal.normalize(),e.GeometryMethods.findBarycentricCoordinates(s.closest_point,s.faces[s.closest_face].a.point,s.faces[s.closest_face].b.point,s.faces[s.closest_face].c.point,t),i.a.scaleVector(s.faces[s.closest_face].a.witness_a,t.x),i.b.scaleVector(s.faces[s.closest_face].b.witness_a,t.y),i.c.scaleVector(s.faces[s.closest_face].c.witness_a,t.z),h.contact_point_in_a.addVectors(i.a,i.b),h.contact_point_in_a.add(i.c),i.a.scaleVector(s.faces[s.closest_face].a.witness_b,t.x),i.b.scaleVector(s.faces[s.closest_face].b.witness_b,t.y),i.c.scaleVector(s.faces[s.closest_face].c.witness_b,t.z),h.contact_point_in_b.addVectors(i.a,i.b),h.contact_point_in_b.add(i.c),h.contact_point.addVectors(h.contact_point_in_a,h.contact_point_in_b),h.contact_point.scale(.5),h.object_a.transform_inverse.transformVector3(h.contact_point_in_a),h.object_b.transform_inverse.transformVector3(h.contact_point_in_b),h.penetration_depth=s.closest_point.length()+e.GjkEpa.margins,e.GjkEpa.freePolyhedron(s),h}s.addVertex(r)}}}(),Face:function(t,i,s,a){this.active=!0,this.a=i,this.b=s,this.c=a,this.normal=new e.Vector3,this.neighbors=[],o.subtractVectors(s.point,i.point),n.subtractVectors(a.point,i.point),this.normal.crossVectors(o,n),this.normal.normalize()}},e.GjkEpa.Polyhedron=function(t){this.closest_face=null,this.closest_face_distance=null,this.closest_point=new e.Vector3,this.faces=[new e.GjkEpa.Face(this,t.points[2],t.points[1],t.points[0]),new e.GjkEpa.Face(this,t.points[3],t.points[1],t.points[2]),new e.GjkEpa.Face(this,t.points[1],t.points[3],t.points[0]),new e.GjkEpa.Face(this,t.points[0],t.points[3],t.points[2])],this.faces[0].neighbors.push(this.faces[1],this.faces[2],this.faces[3]),this.faces[1].neighbors.push(this.faces[2],this.faces[0],this.faces[3]),this.faces[2].neighbors.push(this.faces[1],this.faces[3],this.faces[0]),this.faces[3].neighbors.push(this.faces[2],this.faces[1],this.faces[0])},e.GjkEpa.Polyhedron.prototype={addVertex:function(t){var i,o,n,s,a,r,c,h,l,p,u=[],_=[];for(this.faces[this.closest_face].silhouette(t,u),i=0;i<u.length-5;i+=5){if(n=u[i+3],s=u[i+4],0!==i&&a!==n)for(o=i+5;o<u.length;o+=5)if(u[o+3]===a){r=u[i+0],c=u[i+1],h=u[i+2],l=u[i+3],p=u[i+4],u[i]=u[o],u[i+1]=u[o+1],u[i+2]=u[o+2],u[i+3]=u[o+3],u[i+4]=u[o+4],u[o]=r,u[o+1]=c,u[o+2]=h,u[o+3]=l,u[o+4]=p,n=u[i+3],s=u[i+4];break}a=s}for(i=0;i<u.length;i+=5){var f=u[i];n=u[i+3],s=u[i+4];var b=new e.GjkEpa.Face(this,s,t,n);b.neighbors[2]=u[i],_.push(b),f.neighbors[f.neighbors.indexOf(u[i+2])]=b}for(i=0;i<_.length;i++)_[i].neighbors[0]=_[i+1===_.length?0:i+1],_[i].neighbors[1]=_[0>i-1?_.length-1:i-1];return Array.prototype.push.apply(this.faces,_),u},findFaceClosestToOrigin:function(){var t=new e.Vector3,i=new e.Vector3;return function(){this.closest_face_distance=1/0;var o,n,s;for(n=0;n<this.faces.length;n++)s=this.faces[n],s.active!==!1&&(e.GeometryMethods.findClosestPointInTriangle(t,s.a.point,s.b.point,s.c.point,i),o=i.lengthSquared(),o<this.closest_face_distance&&(this.closest_face_distance=o,this.closest_face=n,this.closest_point.copy(i)))}}()},e.GjkEpa.Face.prototype={classifyVertex:function(t){var i=this.normal.dot(this.a.point);return this.normal.dot(t.point)-i},silhouette:function(t,i,e){if(this.active!==!1)if(this.classifyVertex(t)>0)this.active=!1,this.neighbors[0].silhouette(t,i,this),this.neighbors[1].silhouette(t,i,this),this.neighbors[2].silhouette(t,i,this);else if(e){var o,n,s=this.neighbors.indexOf(e);0===s?(o=this.a,n=this.b):1===s?(o=this.b,n=this.c):(o=this.c,n=this.a),i.push(this,s,e,n,o)}}},function(){var t=(new e.Vector3,new e.Vector3),i=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=new e.Vector3,c={a:new e.Vector3,b:new e.Vector3,c:new e.Vector3};e.GjkEpa.Simplex=function(t,i,o){this.object_a=t,this.object_b=i,this.do_lightweight_collision=o,this.points=[],this.iterations=0,this.next_direction=new e.Vector3,this.updateDirection()},e.GjkEpa.Simplex.prototype={addPoint:function(){if(++this.iterations===e.GjkEpa.max_iterations)return!1;var t=e.ObjectPool.getObject("GJK2SupportPoint");if(e.GjkEpa.findSupportPoint(this.object_a,this.object_b,this.next_direction,t),this.points.push(t),t.point.dot(this.next_direction)<0&&this.points.length>1){if(this.points.length>=3){this.findPointClosestToOrigin(o);var i=o.lengthSquared();if(i<=e.GjkEpa.margins*e.GjkEpa.margins){var n=e.ObjectPool.getObject("ContactDetails");return n.object_a=this.object_a,n.object_b=this.object_b,n.contact_normal.normalizeVector(o),0===n.contact_normal.lengthSquared()&&n.contact_normal.subtractVectors(n.object_b.position,n.object_a.position),n.contact_normal.normalize(),n.contact_normal.scale(-1),n.penetration_depth=e.GjkEpa.margins-Math.sqrt(i),this.findBarycentricCoordinatesOf(o,r),this.do_lightweight_collision?(n.is_lightweight=!0,e.GjkEpa.result=n,null):(c.a.scaleVector(this.points[0].witness_a,r.x),c.b.scaleVector(this.points[1].witness_a,r.y),c.c.scaleVector(this.points[2].witness_a,r.z),n.contact_point_in_a.addVectors(c.a,c.b),n.contact_point_in_a.add(c.c),n.contact_point_in_b.scaleVector(n.contact_normal,-n.penetration_depth),n.contact_point_in_b.add(n.contact_point_in_a),n.contact_point.addVectors(n.contact_point_in_a,n.contact_point_in_b),n.contact_point.scale(.5),n.object_a.transform_inverse.transformVector3(n.contact_point_in_a),n.object_b.transform_inverse.transformVector3(n.contact_point_in_b),e.GjkEpa.result=n,null)}}return!1}return this.updateDirection()===!0?null:t},findDirectionFromLine:function(){t.scaleVector(this.points[1].point,-1),i.subtractVectors(this.points[0].point,this.points[1].point),i.dot(t)<0?(this.next_direction.copy(t),e.ObjectPool.freeObject("GJK2SupportPoint",this.points[1]),this.points.length=1):(this.next_direction.crossVectors(i,t),this.next_direction.cross(i),0===this.next_direction.x&&0===this.next_direction.y&&0===this.next_direction.z&&(i.normalize(),this.next_direction.x=1-Math.abs(i.x),this.next_direction.y=1-Math.abs(i.y),this.next_direction.z=1-Math.abs(i.z)))},findDirectionFromTriangle:function(){var o=new e.Vector3,n=new e.Vector3,r=new e.Vector3,c=new e.Vector3;return function(){var h=this.points[2],l=this.points[1],p=this.points[0];t.scaleVector(h.point,-1),i.subtractVectors(l.point,h.point),s.subtractVectors(p.point,h.point),a.subtractVectors(p.point,l.point),o.crossVectors(i,s),n.crossVectors(i,o),r.crossVectors(o,s),c.crossVectors(a,o);var u=r.dot(t),_=n.dot(t),f=c.dot(t);return Math.abs(u)<e.EPSILON?void this.next_direction.copy(r):Math.abs(_)<e.EPSILON?void this.next_direction.copy(n):Math.abs(f)<e.EPSILON?void this.next_direction.copy(c):void(u>=0?s.dot(t)>=0?(this.points.length=0,this.points.push(p,h),e.ObjectPool.freeObject("GJK2SupportPoint",l),this.next_direction.crossVectors(s,t),this.next_direction.cross(s)):i.dot(t)>=0?(this.points.length=0,this.points.push(l,h),e.ObjectPool.freeObject("GJK2SupportPoint",p),this.next_direction.crossVectors(i,t),this.next_direction.cross(i)):(this.points.length=0,this.points.push(h),e.ObjectPool.freeObject("GJK2SupportPoint",l),e.ObjectPool.freeObject("GJK2SupportPoint",p)):_>=0?i.dot(t)>=0?(this.points.length=0,this.points.push(l,h),e.ObjectPool.freeObject("GJK2SupportPoint",p),this.next_direction.crossVectors(i,t),this.next_direction.cross(i)):(this.points.length=0,this.points.push(h),e.ObjectPool.freeObject("GJK2SupportPoint",l),e.ObjectPool.freeObject("GJK2SupportPoint",p)):o.dot(t)>=0?(this.next_direction.copy(o),this.points.length=0,this.points.push(h,l,p)):(this.next_direction.copy(o),this.next_direction.scale(-1)))}}(),getFaceNormal:function(t,e,o,n){i.subtractVectors(e.point,t.point),s.subtractVectors(o.point,t.point),n.crossVectors(i,s),n.normalize()},faceNormalDotOrigin:function(t,i,e){return this.getFaceNormal(t,i,e,o),n.addVectors(t.point,i.point),n.add(e.point),n.scale(-3),n.normalize(),o.dot(n)},findDirectionFromTetrahedron:function(){var t,i=this.points[3],n=this.points[2],s=this.points[1],a=this.points[0],r=null,c=e.EPSILON;return t=this.faceNormalDotOrigin(n,s,a),t>c&&(r=1,c=t),t=this.faceNormalDotOrigin(i,s,n),t>c&&(r=2,c=t),t=this.faceNormalDotOrigin(s,i,a),t>c&&(r=3,c=t),t=this.faceNormalDotOrigin(a,i,n),t>c&&(r=4,c=t),null===r?!0:(1===r?(this.points.length=0,this.points.push(n,s,a),this.getFaceNormal(n,s,a,o),this.next_direction.copy(o)):2===r?(this.points.length=0,this.points.push(i,s,n),this.getFaceNormal(i,s,n,o),this.next_direction.copy(o)):3===r?(this.points.length=0,this.points.push(s,i,a),this.getFaceNormal(s,i,a,o),this.next_direction.copy(o)):4===r&&(this.points.length=0,this.points.push(a,i,n),this.getFaceNormal(a,i,n,o),this.next_direction.copy(o)),!1)},updateDirection:function(){return 0===this.points.length?(this.next_direction.subtractVectors(this.object_b.position,this.object_a.position),!1):1===this.points.length?(this.next_direction.scale(-1),!1):2===this.points.length?(this.findDirectionFromLine(),!1):3===this.points.length?(this.findDirectionFromTriangle(),!1):this.findDirectionFromTetrahedron()},findPointClosestToOrigin:function(){var t=new e.Vector3;return function(i){var o=this.points;1===o.length?i.copy(o[0].point):2===o.length?e.GeometryMethods.findClosestPointOnASegment(o[0].point,o[1].point,t,i):e.GeometryMethods.findClosestPointInTriangle(t,o[0].point,o[1].point,o[2].point,i)}}(),findBarycentricCoordinatesOf:function(){var t=new e.Vector3,i=new e.Vector3;return function(o,n){var s=this.points;if(1===s.length)n.set(1,0,0);else if(2===s.length){t.subtractVectors(s[1].point,s[0].point),i.subtractVectors(o,s[0].point);var a=Math.sqrt(i.lengthSquared()/t.lengthSquared());n.set(1-a,a)}else e.GeometryMethods.findBarycentricCoordinates(o,s[0].point,s[1].point,s[2].point,n)}}()}}(),e.GjkEpa.PointProxy=function(t){this.position=t},e.GjkEpa.PointProxy.prototype.findSupportPoint=function(t,i){i.copy(this.position)},e.GjkEpa.LineSegmentProxy=function(t,i){this.position=new e.Vector3,this.position.addVectors(t,i),this.position.scale(.5),this.lineSegmentStart=t,this.lineSegmentEnd=i},e.GjkEpa.LineSegmentProxy.prototype.findSupportPoint=function(t,i){var e=this.lineSegmentStart.dot(t),o=this.lineSegmentEnd.dot(t);i.copy(e>o?this.lineSegmentStart:this.lineSegmentEnd)},e.Collision.SAT={performSat:function(){var t=new e.Vector3;return function(i,o,n){for(var s=[],a=null,r=1/0,c=0;c<n.length;c++){var h=n[c],l=this._findProjectionWithNormal(s,h);if(null===l){t.scaleVector(h,-1);var p=this._findProjectionWithNormal(s,t),u=null;if(p&&(u=p.cloneAndNegate(c)),!u){var _=this._findMaxDotInDirection(i,h),f=-this._findMaxDotInDirection(i,t),b=this._findMaxDotInDirection(o,h),d=-this._findMaxDotInDirection(o,t);u=new e.Collision.SAT.Projection(h,_,f,b,d,c)}if(u.overlap<e.EPSILON)return null;s.push(u),u.overlap<r&&(r=u.overlap,a=u)}}return a}}(),removeDuplicatedVectors:function(t){for(var i=0;i<t.length;i++){for(var e=t[i],o=!1,n=i+1;n<t.length&&!(o=e.equals(t[n]));n++);o&&(t[i]=t[t.length-1],t.pop(),i--)}},_findProjectionWithNormal:function(t,i){for(var e=0;e<t.length;e++){var o=t[e];if(o.normal.equals(i))return o}return null},_findMaxDotInDirection:function(){var t=new e.Vector3;return function(i,e){return i.findSupportPoint(e,t),t.dot(e)}}()},e.Collision.SAT.Projection=function(t,i,e,o,n,s){this.normal=t,this.axisId=s,e>i?(this.startA=i,this.endA=e):(this.startA=e,this.endA=i),n>o?(this.startB=o,this.endB=n):(this.startB=n,this.endB=o);var a=this.startA<this.endB&&this.endA>this.startB;this.overlap=a?this.endB-this.startA:0},e.Collision.SAT.Projection.prototype.cloneAndNegate=function(t){var i=new e.Vector3;return i.scaleVector(this.normal,-1),new e.Collision.SAT.Projection(i,-this.startA,-this.endA,-this.startB,-this.endB,t)},e.Collision.sphereCapsule=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(n,s,a){var r,c;n.shape.shapeType===e.Shapes.Type.SphereShape?(r=n,c=s):(r=s,c=n),t.set(0,c.shape.half_height,0),i.set(0,-c.shape.half_height,0),c.transform.transformVector3(t),c.transform.transformVector3(i),e.GeometryMethods.findClosestPointOnASegment(t,i,r.position,o);var h=o.distanceTo(r.position),l=r.shape.radius+c.shape.radius-h;if(0>l)return null;var p=e.ObjectPool.getObject("ContactDetails");if(p.object_a=r,p.object_b=c,a)return p.is_lightweight=!0,[p];p.penetration_depth=l,p.contact_normal.subtractVectors(o,r.position);var u=p.contact_normal.length();return Math.abs(u)<e.EPSILON?p.contact_normal.set(0,1,0):p.contact_normal.scale(1/u),p.contact_point_in_a.copy(p.contact_normal),p.contact_point_in_a.scale(r.shape.radius),p.contact_point_in_a.add(r.position),p.contact_point_in_b.copy(p.contact_normal),p.contact_point_in_b.scale(-c.shape.radius),p.contact_point_in_b.add(o),p.contact_point.addVectors(p.contact_point_in_a,p.contact_point_in_b),p.contact_point.scale(.5),r.transform_inverse.transformVector3(p.contact_point_in_a),c.transform_inverse.transformVector3(p.contact_point_in_b),[p]}}(),e.Collision.sphereConvexHull=function(t,i,o){var n,s;t.shape.shapeType===e.Shapes.Type.SphereShape?(n=t,s=i):(n=i,s=t);var a=e.GjkEpa.findClosestPointOnObjectToPoint(s,n.position);return null!==a?e.Collision.sphereConvexHull._shallowSphereConvexHull(n,s,a,o):e.Collision.sphereConvexHull._deepSphereConvexHull(n,s,o)},e.Collision.sphereConvexHull._shallowSphereConvexHull=function(){var t=new e.Vector3,i=new e.Vector3;return function(o,n,s,a){t.subtractVectors(s,o.position);var r=i.normalizeVector(t);if(r>o.shape.radius)return null;var c=e.ObjectPool.getObject("ContactDetails");return c.object_a=o,c.object_b=n,a?(c.is_lightweight=!0,[c]):(c.penetration_depth=o.shape.radius-r,c.contact_normal.copy(i),c.contact_point_in_a.scaleVector(i,o.shape.radius),c.contact_point_in_a.add(o.position),c.contact_point_in_b.copy(s),c.contact_point.addVectors(c.contact_point_in_a,c.contact_point_in_b),c.contact_point.scale(.5),o.transform_inverse.transformVector3(c.contact_point_in_a),n.transform_inverse.transformVector3(c.contact_point_in_b),[c])}}(),e.Collision.sphereConvexHull._deepSphereConvexHull=function(){return function(t,i,o){var n=e.ObjectPool.getObject("ContactDetails");if(n.object_a=t,n.object_b=i,o)return n.is_lightweight=!0,[n];var s=e.Collision.SAT.performSat(t,i,i.faceNormals);if(null===s)throw new Error("Center of the sphere is inside the complex hull, but SAT thinks that they do not overlap.");return n.penetration_depth=s.overlap,n.contact_normal.scaleVector(s.normal,-1),n.contact_point_in_a.scaleVector(n.contact_normal,t.shape.radius),n.contact_point_in_a.add(t.position),n.contact_point_in_b.scaleVector(s.normal,s.overlap-t.shape.radius),n.contact_point_in_b.add(t.position),n.contact_point.addVectors(n.contact_point_in_a,n.contact_point_in_b),n.contact_point.scale(.5),t.transform_inverse.transformVector3(n.contact_point_in_a),i.transform_inverse.transformVector3(n.contact_point_in_b),[n]}}(),e.Collision.sphereSphere=function(t,i,n){var s=t.position,a=i.position;o.subtractVectors(a,s);var r=o.length(),c=t.shape.radius+i.shape.radius;if(r>c)return null;var h=e.ObjectPool.getObject("ContactDetails");return h.object_a=t,h.object_b=i,n?(h.is_lightweight=!0,h):(r<e.EPSILON?h.contact_normal.set(0,1,0):h.contact_normal.scaleVector(o,1/r),h.penetration_depth=c-r,h.contact_point_in_a.scaleVector(h.contact_normal,h.object_a.shape.radius),h.contact_point_in_b.scaleVector(h.contact_normal,-h.object_b.shape.radius),h.contact_point.addVectors(h.contact_point_in_a,h.contact_point_in_b),h.contact_point.add(s),h.contact_point.add(a),h.contact_point.scale(.5),[h])},e.Collision.triangleTriangle=function(t,i,s){var a=i.classifyVertex(t.a),r=i.classifyVertex(t.b),c=i.classifyVertex(t.c);if(a>0&&r>0&&c>0||0>a&&0>r&&0>c)return null;var h=t.classifyVertex(i.a),l=t.classifyVertex(i.b),p=t.classifyVertex(i.c);if(h>0&&l>0&&p>0||0>h&&0>l&&0>p)return null;var u=new e.Vector3;u.crossVectors(t.normal,i.normal),u.normalize();var _,f=u.dot(t.a),b=u.dot(t.b),d=u.dot(t.c),m=u.dot(i.a),y=u.dot(i.b),v=u.dot(i.c),x=t.a,w=t.b,g=t.c,j=i.a,V=i.b,C=i.c;Math.sign(a)===Math.sign(r)?(_=a,a=c,c=_,_=f,f=d,d=_,_=x,x=g,g=_):Math.sign(a)===Math.sign(c)&&(_=a,a=r,r=_,_=f,f=b,b=_,_=x,x=w,w=_),Math.sign(h)===Math.sign(l)?(_=h,h=p,p=_,_=m,m=v,v=_,_=j,j=C,C=_):Math.sign(h)===Math.sign(p)&&(_=h,h=l,l=_,_=m,m=y,y=_,_=j,j=V,V=_);var S=f+(b-f)*(a/(a-r)),z=f+(d-f)*(a/(a-c)),P=m+(y-m)*(h/(h-l)),O=m+(v-m)*(h/(h-p));if(S>z&&(_=S,S=z,z=_,_=b,b=d,d=_,_=w,w=g,g=_),P>O&&(_=P,P=O,O=_,_=y,y=v,v=_,_=V,V=C,C=_),S>=P&&O>=S||z>=P&&O>=z||P>=S&&z>=P||O>=S&&z>=O){var B=e.ObjectPool.getObject("ContactDetails");if(B.object_a=t,B.object_b=i,s)return B.is_lightweight=!0,[B];var M=new e.Vector3,T=new e.Vector3,I=new e.Vector3,A=new e.Vector3,E=new e.Vector3,F=new e.Vector3,L=!1,N=!1;return i.classifyVertex(x)<=0?(L=!0,e.GeometryMethods.findClosestPointInTriangle(x,j,V,C,T),M.copy(x),I.copy(i.normal),I.scale(-1)):S>=P&&O>=S?(L=!0,e.GeometryMethods.findClosestPointInTriangle(w,j,V,C,T),M.copy(w),I.copy(i.normal),I.scale(-1)):z>=P&&O>=z&&(L=!0,e.GeometryMethods.findClosestPointInTriangle(g,j,V,C,T),M.copy(g),I.copy(i.normal),I.scale(-1)),t.classifyVertex(j)<=0?(N=!0,e.GeometryMethods.findClosestPointInTriangle(j,x,w,g,A),E.copy(j),F.copy(t.normal)):P>=S&&z>=P?(N=!0,e.GeometryMethods.findClosestPointInTriangle(V,x,w,g,A),E.copy(V),F.copy(t.normal)):O>=S&&z>=O&&(N=!0,e.GeometryMethods.findClosestPointInTriangle(C,x,w,g,A),E.copy(C),F.copy(t.normal)),o.subtractVectors(M,T),n.subtractVectors(A,E),!N||L&&o.lengthSquared()<n.lengthSquared()?(B.contact_point_in_a.copy(M),B.contact_point_in_b.copy(T),B.contact_normal.copy(I)):(B.contact_point_in_a.copy(A),B.contact_point_in_b.copy(E),B.contact_normal.copy(F)),o.subtractVectors(B.contact_point_in_a,B.contact_point_in_b),B.penetration_depth=o.length(),B.contact_point.addVectors(B.contact_point_in_a,B.contact_point_in_b),B.contact_point.scale(.5),[B]}return null},e.Collision={},e.Constraint=function(){var t=0;return function(){this.id=t++,this.active=!0,this.object_a=null,this.object_b=null,this.limit=new e.ConstraintLimit,this.motor=new e.ConstraintMotor,this.rows=[],this.factor=1,this.last_impulse=new e.Vector3,this.breaking_threshold=0,this.listeners={},this.solver=null}}(),e.EventEmitter.apply(e.Constraint),e.Constraint.prototype.deactivate=function(){this.active=!1},e.Constraint.prototype.update=function(){},e.Constraint.prototype.object_a_is_dynamic=function(){return null!==this.object_a&&!this.object_a._is_kinematic&&this.object_a._mass!==1/0},e.Constraint.prototype.object_b_is_dynamic=function(){return null!==this.object_b&&!this.object_b._is_kinematic&&this.object_b._mass!==1/0},e.ConstraintLimit=function(t,i){this.erp=.3,this.constraint_row=null,this.set(t,i)},e.ConstraintLimit.prototype.set=function(t,i){this.limit_lower=t,this.limit_upper=i,this.enabled=null!=this.limit_lower||null!=this.limit_upper},e.ConstraintLimit.prototype.createConstraintRow=function(){this.constraint_row=e.ConstraintRow.createConstraintRow()},e.ConstraintMotor=function(t,i){this.constraint_row=null,this.set(t,i)},e.ConstraintMotor.prototype.set=function(t,i){this.enabled=null!=t&&null!=i,this.torque=t,this.max_speed=i},e.ConstraintMotor.prototype.createConstraintRow=function(){this.constraint_row=e.ConstraintRow.createConstraintRow()},e.ConstraintRow=function(){this.jacobian=new Float64Array(12),this.B=new Float64Array(12),this.D=0,this.lower_limit=-(1/0),this.upper_limit=1/0,this.bias=0,this.multiplier=0,this.multiplier_cached=0,this.cfm=0,this.eta=0,this.eta_row=new Float64Array(12)},e.ConstraintRow.createConstraintRow=function(){var t=e.ObjectPool.getObject("ConstraintRow");return t.lower_limit=-(1/0),t.upper_limit=1/0,t.bias=0,t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0,t},e.ConstraintRow.prototype.nullify=function(t,i){var e=0;for(e=0;t&&6>e;e++)this.jacobian[e]=0;for(e=6;i&&12>e;e++)this.jacobian[e]=0},e.ConstraintRow.prototype.reset=function(){this.nullify(!0,!0),this.lower_limit=-(1/0),this.upper_limit=1/0,this.bias=0},e.ConstraintRow.prototype.computeB=function(t){var i,e=this.jacobian,n=this.B;t.object_a_is_dynamic()?(i=t.object_a._mass_inverted,n[0]=i*e[0],n[1]=i*e[1],n[2]=i*e[2],o.x=e[3],o.y=e[4],o.z=e[5],t.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),n[3]=o.x,n[4]=o.y,n[5]=o.z):(n[0]=n[1]=n[2]=0,n[3]=n[4]=n[5]=0),t.object_b_is_dynamic()?(i=t.object_b._mass_inverted,n[6]=i*e[6],n[7]=i*e[7],n[8]=i*e[8],o.x=e[9],o.y=e[10],o.z=e[11],t.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),n[9]=o.x,n[10]=o.y,n[11]=o.z):(n[6]=n[7]=n[8]=0,n[9]=n[10]=n[11]=0)},e.ConstraintRow.prototype.computeD=function(){var t=this.jacobian,i=this.B;this.D=t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3]+t[4]*i[4]+t[5]*i[5]+t[6]*i[6]+t[7]*i[7]+t[8]*i[8]+t[9]*i[9]+t[10]*i[10]+t[11]*i[11];

},e.ConstraintRow.prototype.computeEta=function(t,i){var e,n,s,a,r,c,h=1/i,l=this.eta_row,p=this.jacobian;t.object_a_is_dynamic()?(e=t.object_a._mass_inverted,n=t.object_a.linear_factor,s=t.object_a.linear_velocity,a=t.object_a.angular_factor,r=t.object_a.angular_velocity,c=t.object_a.accumulated_force,l[0]=n.x*(s.x+e*c.x)*h,l[1]=n.y*(s.y+e*c.y)*h,l[2]=n.z*(s.z+e*c.z)*h,o.copy(t.object_a.accumulated_torque),t.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),l[3]=a.x*(r.x+o.x)*h,l[4]=a.y*(r.y+o.y)*h,l[5]=a.z*(r.z+o.z)*h):l[0]=l[1]=l[2]=l[3]=l[4]=l[5]=0,t.object_b_is_dynamic()?(e=t.object_b._mass_inverted,n=t.object_b.linear_factor,s=t.object_b.linear_velocity,a=t.object_b.angular_factor,r=t.object_b.angular_velocity,c=t.object_b.accumulated_force,l[6]=n.x*(s.x+e*c.x)*h,l[7]=n.y*(s.y+e*c.y)*h,l[8]=n.z*(s.z+e*c.z)*h,o.copy(t.object_b.accumulated_torque),t.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),l[9]=a.x*(r.x+o.x)*h,l[10]=a.y*(r.y+o.y)*h,l[11]=a.z*(r.z+o.z)*h):l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=0;var u=p[0]*l[0]+p[1]*l[1]+p[2]*l[2]+p[3]*l[3]+p[4]*l[4]+p[5]*l[5]+p[6]*l[6]+p[7]*l[7]+p[8]*l[8]+p[9]*l[9]+p[10]*l[10]+p[11]*l[11];this.eta=this.bias*h-u;var _=(t.object_a_is_dynamic()?t.object_a._mass:0)+(t.object_b_is_dynamic()?t.object_b._mass:0);this.eta=this.eta/(1+this.cfm*_)},e.ContactConstraint=function(){e.Constraint.call(this),this.contact=null},e.ContactConstraint.prototype=Object.create(e.Constraint.prototype),e.ContactConstraint.prototype.buildFromContact=function(t){this.object_a=t.object_a,this.object_b=t.object_b,this.contact=t,this.contact.contactConstraint=this;var i=this.rows[0]||e.ObjectPool.getObject("ConstraintRow");i.lower_limit=0,i.upper_limit=1/0,this.rows[0]=i,this.update()},e.ContactConstraint.prototype.deactivate=function(){e.Constraint.prototype.deactivate.call(this),null!==this.solver&&this.solver.onContactDeactivate(this)},e.ContactConstraint.prototype.update=function(){var t=this.rows[0];this.object_a_is_dynamic()?(t.jacobian[0]=-this.contact.contact_normal.x,t.jacobian[1]=-this.contact.contact_normal.y,t.jacobian[2]=-this.contact.contact_normal.z,o.subtractVectors(this.contact.contact_point,this.contact.object_a.position),o.cross(this.contact.contact_normal),t.jacobian[3]=-o.x,t.jacobian[4]=-o.y,t.jacobian[5]=-o.z):(t.jacobian[0]=t.jacobian[1]=t.jacobian[2]=0,t.jacobian[3]=t.jacobian[4]=t.jacobian[5]=0),this.object_b_is_dynamic()?(t.jacobian[6]=this.contact.contact_normal.x,t.jacobian[7]=this.contact.contact_normal.y,t.jacobian[8]=this.contact.contact_normal.z,o.subtractVectors(this.contact.contact_point,this.contact.object_b.position),o.cross(this.contact.contact_normal),t.jacobian[9]=o.x,t.jacobian[10]=o.y,t.jacobian[11]=o.z):(t.jacobian[6]=t.jacobian[7]=t.jacobian[8]=0,t.jacobian[9]=t.jacobian[10]=t.jacobian[11]=0),t.bias=0;var i=0;this.object_a_is_dynamic()&&(this.object_a.getVelocityInLocalPoint(this.contact.contact_point_in_a,o),i+=o.dot(this.contact.contact_normal)),this.object_b_is_dynamic()&&(this.object_b.getVelocityInLocalPoint(this.contact.contact_point_in_b,o),i-=o.dot(this.contact.contact_normal)),t.bias+=i*this.contact.restitution},e.FrictionConstraint=function(){e.Constraint.call(this),this.contact=null},e.FrictionConstraint.prototype=Object.create(e.Constraint.prototype),e.FrictionConstraint.prototype.buildFromContact=function(t){this.rows[0]=this.rows[0]||e.ObjectPool.getObject("ConstraintRow"),this.rows[1]=this.rows[1]||e.ObjectPool.getObject("ConstraintRow"),this.object_a=t.object_a,this.object_b=t.object_b,this.contact=t,this.contact.frictionConstraint=this,this.update()},e.FrictionConstraint.prototype.deactivate=function(){e.Constraint.prototype.deactivate.call(this),null!==this.solver&&this.solver.onFrictionDeactivate(this)},e.FrictionConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,n=new e.Vector3,s=new e.Vector3;return function(){var e=this.rows[0],a=this.rows[1];t.subtractVectors(this.contact.contact_point,this.object_a.position),i.subtractVectors(this.contact.contact_point,this.object_b.position),this.contact.contact_normal.findOrthogonal(n,s),this.object_a_is_dynamic()?(e.jacobian[0]=-n.x,e.jacobian[1]=-n.y,e.jacobian[2]=-n.z,o.crossVectors(t,n),e.jacobian[3]=-o.x,e.jacobian[4]=-o.y,e.jacobian[5]=-o.z,a.jacobian[0]=-s.x,a.jacobian[1]=-s.y,a.jacobian[2]=-s.z,o.crossVectors(t,s),a.jacobian[3]=-o.x,a.jacobian[4]=-o.y,a.jacobian[5]=-o.z):(e.jacobian[0]=e.jacobian[1]=e.jacobian[2]=0,e.jacobian[3]=e.jacobian[4]=e.jacobian[5]=0,a.jacobian[0]=a.jacobian[1]=a.jacobian[2]=0,a.jacobian[3]=a.jacobian[4]=a.jacobian[5]=0),this.object_b_is_dynamic()?(e.jacobian[6]=n.x,e.jacobian[7]=n.y,e.jacobian[8]=n.z,o.crossVectors(i,n),e.jacobian[9]=o.x,e.jacobian[10]=o.y,e.jacobian[11]=o.z,a.jacobian[6]=s.x,a.jacobian[7]=s.y,a.jacobian[8]=s.z,o.crossVectors(i,s),a.jacobian[9]=o.x,a.jacobian[10]=o.y,a.jacobian[11]=o.z):(e.jacobian[6]=e.jacobian[7]=e.jacobian[8]=0,e.jacobian[9]=e.jacobian[10]=e.jacobian[11]=0,a.jacobian[6]=a.jacobian[7]=a.jacobian[8]=0,a.jacobian[9]=a.jacobian[10]=a.jacobian[11]=0);var r=this.contact.friction;this.object_a_is_dynamic()&&(r*=this.object_a._mass),this.object_b_is_dynamic()&&(r*=this.object_b._mass),0>r&&(r=0),e.lower_limit=a.lower_limit=-r,e.upper_limit=a.upper_limit=r,e.bias=a.bias=0,this.rows[0]=e,this.rows[1]=a}}(),e.HingeConstraint=function(t,i,o,n,s){e.Constraint.call(this),this.object_a=t,this.hinge_a=i,this.point_a=o,this.initial_quaternion=new e.Quaternion,this.object_b=n||null,this.point_b=new e.Vector3,this.hinge_b=new e.Vector3,null!=this.object_b?(this.object_a.rotation.transformVector3Into(this.hinge_a,this.hinge_b),h.invertQuaternion(this.object_b.rotation),h.transformVector3(this.hinge_b),this.point_b=s,this.initial_quaternion.multiplyQuaternions(h,this.object_a.rotation)):(this.object_a.updateDerived(),this.object_a.rotation.transformVector3Into(this.hinge_a,this.hinge_b),this.object_a.transform.transformVector3Into(this.point_a,this.point_b),this.initial_quaternion.set(this.object_a.rotation.x,this.object_a.rotation.y,this.object_a.rotation.z,this.object_a.rotation.w)),this.erp=.1;for(var a=0;5>a;a++)this.rows[a]=e.ConstraintRow.createConstraintRow()},e.HingeConstraint.prototype=Object.create(e.Constraint.prototype),e.HingeConstraint.prototype.updateLimits=function(i,e){if(this.limit.enabled===!1)return void t(this);var o,n;return null==this.object_b?o=this.initial_quaternion.signedAngleBetween(this.object_a.rotation,i):(h.invertQuaternion(this.object_b.rotation),h.multiply(this.object_a.rotation),o=this.initial_quaternion.signedAngleBetween(h,i)),(null==this.limit.limit_lower||this.limit.limit_lower<o)&&(null==this.limit.limit_upper||this.limit.limit_upper>o)?void t(this):void(null!=this.limit.limit_lower&&o<=this.limit.limit_lower?(null==this.limit.constraint_row&&(this.limit.createConstraintRow(),this.limit.constraint_row.upper_limit=0,this.rows.push(this.limit.constraint_row)),this.limit.constraint_row.jacobian[3]=-i.x,this.limit.constraint_row.jacobian[4]=-i.y,this.limit.constraint_row.jacobian[5]=-i.z,null!=this.object_b&&(this.limit.constraint_row.jacobian[9]=i.x,this.limit.constraint_row.jacobian[10]=i.y,this.limit.constraint_row.jacobian[11]=i.z),n=o-this.limit.limit_lower,this.limit.constraint_row.bias=n*this.limit.erp/e):null!=this.limit.limit_upper&&o>=this.limit.limit_upper&&(null==this.limit.constraint_row&&(this.limit.createConstraintRow(),this.limit.constraint_row.lower_limit=0,this.rows.push(this.limit.constraint_row)),this.limit.constraint_row.jacobian[3]=-i.x,this.limit.constraint_row.jacobian[4]=-i.y,this.limit.constraint_row.jacobian[5]=-i.z,null!=this.object_b&&(this.limit.constraint_row.jacobian[9]=i.x,this.limit.constraint_row.jacobian[10]=i.y,this.limit.constraint_row.jacobian[11]=i.z),n=o-this.limit.limit_upper,this.limit.constraint_row.bias=n*this.limit.erp/e))},e.HingeConstraint.prototype.updateMotor=function(t){return this.motor.enabled===!1?void i(this):(null==this.motor.constraint_row&&(this.motor.createConstraintRow(),this.rows.push(this.motor.constraint_row),this.motor.constraint_row.jacobian[3]=t.x,this.motor.constraint_row.jacobian[4]=t.y,this.motor.constraint_row.jacobian[5]=t.z,null!=this.object_b&&(this.motor.constraint_row.jacobian[9]=-t.x,this.motor.constraint_row.jacobian[10]=-t.y,this.motor.constraint_row.jacobian[11]=-t.z)),this.motor.constraint_row.bias=this.motor.max_speed,void(this.motor.max_speed>=0?(this.motor.constraint_row.lower_limit=0,this.motor.constraint_row.upper_limit=this.motor.torque):(this.motor.constraint_row.lower_limit=-this.motor.torque,this.motor.constraint_row.upper_limit=0)))},e.HingeConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,a=new e.Vector3,r=new e.Vector3,c=new e.Vector3;return function(e){this.object_a.rotation.transformVector3Into(this.hinge_a,c),this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,c.findOrthogonal(a,r),this.rows[3].jacobian[3]=-a.x,this.rows[3].jacobian[4]=-a.y,this.rows[3].jacobian[5]=-a.z,this.rows[4].jacobian[3]=-r.x,this.rows[4].jacobian[4]=-r.y,this.rows[4].jacobian[5]=-r.z,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,n),i.subtractVectors(n,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.z,this.rows[2].jacobian[11]=0,this.rows[3].jacobian[9]=a.x,this.rows[3].jacobian[10]=a.y,this.rows[3].jacobian[11]=a.z,this.rows[4].jacobian[9]=r.x,this.rows[4].jacobian[10]=r.y,this.rows[4].jacobian[11]=r.z):n.copy(this.point_b),s.subtractVectors(o,n),s.scale(this.erp/e),this.rows[0].bias=s.x,this.rows[1].bias=s.y,this.rows[2].bias=s.z,null!=this.object_b?(this.object_a.rotation.transformVector3Into(this.hinge_a,o),this.object_b.rotation.transformVector3Into(this.hinge_b,n),o.cross(n),this.rows[3].bias=-o.dot(a)*this.erp/e,this.rows[4].bias=-o.dot(r)*this.erp/e):this.rows[3].bias=this.rows[4].bias=0,this.updateLimits(c,e),this.updateMotor(c)}}(),e.PointConstraint=function(t,i,o,n){e.Constraint.call(this),this.object_a=t,this.point_a=i,this.object_b=o||null,null!=this.object_b?this.point_b=n:(this.point_b=new e.Vector3,this.object_a.updateDerived(),this.object_a.transform.transformVector3Into(this.point_a,this.point_b)),this.erp=.1;for(var s=0;3>s;s++)this.rows[s]=e.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-(1/0),this.rows[s].upper_limit=1/0,this.rows[s].bias=0,this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=0},e.PointConstraint.prototype=Object.create(e.Constraint.prototype),e.PointConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3;return function(e){this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,n),i.subtractVectors(n,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.x,this.rows[2].jacobian[11]=0):n.copy(this.point_b),s.subtractVectors(o,n),s.scale(this.erp/e),this.rows[0].bias=s.x,this.rows[1].bias=s.y,this.rows[2].bias=s.z}}(),e.SliderConstraint=function(t,i,o){e.Constraint.call(this),this.object_a=t,this.axis=i,this.object_b=o,this.position_error=new e.Vector3,this.position_error.subtractVectors(this.object_b.position,this.object_a.position),h.invertQuaternion(this.object_a.rotation),h.transformVector3(this.position_error),this.rotation_difference=new e.Quaternion,null!=this.object_b&&(h.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(h,this.object_a.rotation)),this.erp=.1;for(var n=0;5>n;n++)this.rows[n]=e.ObjectPool.getObject("ConstraintRow"),this.rows[n].lower_limit=-(1/0),this.rows[n].upper_limit=1/0,this.rows[n].bias=0,this.rows[n].jacobian[0]=this.rows[n].jacobian[1]=this.rows[n].jacobian[2]=this.rows[n].jacobian[3]=this.rows[n].jacobian[4]=this.rows[n].jacobian[5]=this.rows[n].jacobian[6]=this.rows[n].jacobian[7]=this.rows[n].jacobian[8]=this.rows[n].jacobian[9]=this.rows[n].jacobian[10]=this.rows[n].jacobian[11]=0},e.SliderConstraint.prototype=Object.create(e.Constraint.prototype),e.SliderConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e){this.object_a.rotation.transformVector3Into(this.axis,t),t.findOrthogonal(i,o),this._updateLinearConstraints(e,i,o),this._updateAngularConstraints(e,i,o)}}(),e.SliderConstraint.prototype._updateLinearConstraints=function(t,i,s){var a=new e.Vector3;a.subtractVectors(this.object_b.position,this.object_a.position);var r=new e.Vector3;r.crossVectors(a,i),this.rows[0].jacobian[0]=-i.x,this.rows[0].jacobian[1]=-i.y,this.rows[0].jacobian[2]=-i.z,this.rows[0].jacobian[6]=i.x,this.rows[0].jacobian[7]=i.y,this.rows[0].jacobian[8]=i.z,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=0,this.rows[0].jacobian[11]=0,r.crossVectors(a,s),this.rows[1].jacobian[0]=-s.x,this.rows[1].jacobian[1]=-s.y,this.rows[1].jacobian[2]=-s.z,this.rows[1].jacobian[6]=s.x,this.rows[1].jacobian[7]=s.y,this.rows[1].jacobian[8]=s.z,this.rows[1].jacobian[9]=0,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=0,this.object_a.rotation.transformVector3Into(this.position_error,o),n.subtractVectors(a,o),n.scale(this.erp/t),this.rows[0].bias=-i.dot(n),this.rows[1].bias=-s.dot(n)},e.SliderConstraint.prototype._updateAngularConstraints=function(t,i,o,n){this.rows[2].jacobian[3]=this.rows[3].jacobian[4]=this.rows[4].jacobian[5]=-1,this.rows[2].jacobian[9]=this.rows[3].jacobian[10]=this.rows[4].jacobian[11]=1,h.invertQuaternion(this.object_b.rotation),h.multiply(this.object_a.rotation),l.invertQuaternion(this.rotation_difference),l.multiply(h);var s=new e.Vector3;s.x=l.x,s.y=l.y,s.z=l.z,s.scale(this.erp/t)},e.WeldConstraint=function(t,i,o,n){e.Constraint.call(this),this.object_a=t,this.point_a=i,this.object_b=o||null,this.point_b=n||null,this.rotation_difference=new e.Quaternion,null!=this.object_b&&(h.invertQuaternion(this.object_b.rotation),this.rotation_difference.multiplyQuaternions(h,this.object_a.rotation)),this.erp=.1;for(var s=0;3>s;s++)this.rows[s]=e.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-(1/0),this.rows[s].upper_limit=1/0,this.rows[s].bias=0,null==this.object_b&&(this.rows[s].jacobian[0]=this.rows[s].jacobian[1]=this.rows[s].jacobian[2]=this.rows[s].jacobian[4]=this.rows[s].jacobian[5]=this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=this.rows[s].jacobian[12]=0,this.rows[s].jacobian[s]=1);for(s=3;6>s;s++)this.rows[s]=e.ObjectPool.getObject("ConstraintRow"),this.rows[s].lower_limit=-(1/0),this.rows[s].upper_limit=1/0,this.rows[s].bias=0,null==this.object_b?(this.rows[s].jacobian[0]=this.rows[s].jacobian[1]=this.rows[s].jacobian[2]=this.rows[s].jacobian[4]=this.rows[s].jacobian[5]=this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=this.rows[s].jacobian[12]=0,this.rows[s].jacobian[s]=1):(this.rows[s].jacobian[0]=this.rows[s].jacobian[1]=this.rows[s].jacobian[2]=0,this.rows[s].jacobian[3]=this.rows[s].jacobian[4]=this.rows[s].jacobian[5]=0,this.rows[s].jacobian[s]=-1,this.rows[s].jacobian[6]=this.rows[s].jacobian[7]=this.rows[s].jacobian[8]=0,this.rows[s].jacobian[9]=this.rows[s].jacobian[10]=this.rows[s].jacobian[11]=0,this.rows[s].jacobian[s+6]=1)},e.WeldConstraint.prototype=Object.create(e.Constraint.prototype),e.WeldConstraint.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3;return function(s){if(null!=this.object_b){this.object_a.transform.transformVector3Into(this.point_a,o),t.subtractVectors(o,this.object_a.position),this.rows[0].jacobian[0]=-1,this.rows[0].jacobian[1]=0,this.rows[0].jacobian[2]=0,this.rows[0].jacobian[3]=0,this.rows[0].jacobian[4]=-t.z,this.rows[0].jacobian[5]=t.y,this.rows[1].jacobian[0]=0,this.rows[1].jacobian[1]=-1,this.rows[1].jacobian[2]=0,this.rows[1].jacobian[3]=t.z,this.rows[1].jacobian[4]=0,this.rows[1].jacobian[5]=-t.x,this.rows[2].jacobian[0]=0,this.rows[2].jacobian[1]=0,this.rows[2].jacobian[2]=-1,this.rows[2].jacobian[3]=-t.y,this.rows[2].jacobian[4]=t.x,this.rows[2].jacobian[5]=0,null!=this.object_b?(this.object_b.transform.transformVector3Into(this.point_b,n),i.subtractVectors(n,this.object_b.position),this.rows[0].jacobian[6]=1,this.rows[0].jacobian[7]=0,this.rows[0].jacobian[8]=0,this.rows[0].jacobian[9]=0,this.rows[0].jacobian[10]=i.z,this.rows[0].jacobian[11]=-i.y,this.rows[1].jacobian[6]=0,this.rows[1].jacobian[7]=1,this.rows[1].jacobian[8]=0,this.rows[1].jacobian[9]=-i.z,this.rows[1].jacobian[10]=0,this.rows[1].jacobian[11]=i.x,this.rows[2].jacobian[6]=0,this.rows[2].jacobian[7]=0,this.rows[2].jacobian[8]=1,this.rows[2].jacobian[9]=i.y,this.rows[2].jacobian[10]=-i.x,this.rows[2].jacobian[11]=0):n.copy(this.point_b);var a=new e.Vector3;a.subtractVectors(o,n),a.scale(this.erp/s),this.rows[0].bias=a.x,this.rows[1].bias=a.y,this.rows[2].bias=a.z,h.invertQuaternion(this.object_b.rotation),h.multiply(this.object_a.rotation),l.invertQuaternion(this.rotation_difference),l.multiply(h),a.x=l.x,a.y=l.y,a.z=l.z,a.scale(this.erp/s),this.rows[3].bias=a.x,this.rows[4].bias=a.y,this.rows[5].bias=a.z}}}(),e.RayIntersection=function(){this.object=null,this.shape=null,this.point=new e.Vector3,this.t=null,this.normal=new e.Vector3},e.BoxShape=function(t,i,o,n){this.shapeType=e.Shapes.Type.BoxShape,this.half_width=t,this.half_height=i,this.half_depth=o,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.faceNormals=[new e.Vector3(1,0,0),new e.Vector3(-1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,-1,0),new e.Vector3(0,0,1),new e.Vector3(0,0,-1)],this.material=n||null},e.BoxShape.prototype.calculateLocalAABB=function(t){t.min.x=-this.half_width,t.min.y=-this.half_height,t.min.z=-this.half_depth,t.max.x=this.half_width,t.max.y=this.half_height,t.max.z=this.half_depth},e.BoxShape.prototype.getInertiaTensor=function(t){var i=this.half_height*this.half_height*4,o=this.half_width*this.half_width*4,n=this.half_depth*this.half_depth*4,s=.0833*t;return new e.Matrix3(s*(i+n),0,0,0,s*(o+n),0,0,0,s*(i+o))},e.BoxShape.prototype.findSupportPoint=function(t,i){i.x=Math.sign(t.x)*this.half_width,i.y=Math.sign(t.y)*this.half_height,i.z=Math.sign(t.z)*this.half_depth},e.BoxShape.prototype.rayIntersect=function(){var t,i,o,n,s,a,r,c=new e.Vector3;return function(h,l){t=0,c.subtractVectors(l,h),i=c.length(),c.scale(1/i);for(var p=0;3>p;p++){if(o=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,Math.abs(c[o])<e.EPSILON&&(h[o]<-r||h[o]>r))return null;if(n=1/c[o],s=(-r-h[o])*n,a=(r-h[o])*n,s>a&&(n=s,s=a,a=n),t=Math.max(t,s),i=Math.min(i,a),t>i)return null}var u=e.ObjectPool.getObject("RayIntersection");u.object=this,u.t=t,u.point.scaleVector(c,t),u.point.add(h);var _=1/0;for(p=0;3>p;p++)o=0===p?"x":1===p?"y":"z",r=0===p?this.half_width:1===p?this.half_height:this.half_depth,r-Math.abs(u.point[o])<_&&(u.normal.x=u.normal.y=u.normal.z=0,u.normal[o]=u.point[o]<0?-1:1,_=r-Math.abs(u.point[o]));return u}}(),e.CapsuleShape=function(t,i,o){this.shapeType=e.Shapes.Type.CapsuleShape,this.radius=t,this.half_height=Math.abs(i),this.material=o||null,this.faceNormals=[],this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb)},e.CapsuleShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.z=-this.radius,t.min.y=-this.half_height-this.radius,t.max.x=t.max.z=this.radius,t.max.y=this.half_height+this.radius},e.CapsuleShape.prototype.getInertiaTensor=function(t){if(-e.EPSILON<=this.half_height&&this.half_height<=e.EPSILON){if(-e.EPSILON<=this.radius&&this.radius<=e.EPSILON)return new e.Matrix3;var i=.4*t*this.radius*this.radius;return new e.Matrix3(i,0,0,0,i,0,0,0,i)}var o=1.5*this.half_height/this.radius,n=t/(1+o),s=t/(1+1/o),a=this.radius*this.radius,r=.4*n*a,c=.0833*s*(3*a+4*this.half_height*this.half_height),h=r+c+n*(3*this.radius+4*this.half_height)*this.half_height/4;return new e.Matrix3(h,0,0,0,r+.5*s*a,0,0,0,h)},e.CapsuleShape.prototype.findSupportPoint=function(t,i){o.normalizeVector(t),i.scaleVector(o,this.radius),i.y+=Math.sign(t.y)*this.half_height},e.CapsuleShape.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=function(t,i,e,o,r){n.subtractVectors(o,e),s.subtractVectors(t,e);var c=n.dot(n),h=n.dot(i),l=n.dot(s),p=i.dot(s),u=s.dot(s),_=c-h*h,f=c*p-l*h,b=c*u-l*l-r*r*c,d=f*f-_*b;if(d>=0){var m=(-f-Math.sqrt(d))/_,y=l+m*h;if(y>0&&c>y)return m;if(0>=y?a.copy(s):a.subtractVectors(t,o),f=i.dot(a),b=a.dot(a)-r*r,d=f*f-b,d>0)return-f-Math.sqrt(d)}return-1};return function(n,s){t.set(0,this.half_height,0),i.set(0,-this.half_height,0),o.subtractVectors(s,n);var a=o.normalize();if(Math.abs(a)<e.EPSILON)return null;var c=r(n,o,t,i,this.radius);if(0>c||c>a)return null;var h=e.ObjectPool.getObject("RayIntersection");return h.object=this,h.point.scaleVector(o,c),h.point.add(n),h.t=c,h.normal.x=h.point.x,h.normal.z=h.point.z,h.normal.y=h.point.y<-this.half_height?h.point.y+this.half_height:h.point.y>this.half_height?h.point.y-this.half_height:0,h.normal.scale(1/this.radius),h}}(),e.CompoundShape=function(){this.shapeType=e.Shapes.Type.CompoundShape,this.child_shapes=[],this.aabb=new e.AABB,this.faceNormals=[],this.center_of_mass=new e.Vector3,this.center_of_mass_override=null,this.updateAABB()},e.CompoundShape.prototype.addChildShape=function(t,i,o){this.child_shapes.push(new e.CompoundShapeChild(t,i,o)),this.updateCenterOfMass(),this.updateAABB(),this.updateFaceNormals()},e.CompoundShape.prototype.removeChildShape=function(t){for(var i=!1,e=0;e<this.child_shapes.length;e++)if(this.child_shapes[e].shape===t){this.child_shapes[e]=this.child_shapes[this.child_shapes.length-1],this.child_shapes.pop(),i=!0;break}return i?(this.updateCenterOfMass(),this.updateAABB(),this.updateFaceNormals(),!0):!1},e.CompoundShape.prototype.updateAABB=function(){this.calculateLocalAABB(this.aabb)},e.CompoundShape.prototype.updateCenterOfMass=function(){var t;if(this.center_of_mass_override)this.center_of_mass.copy(this.center_of_mass_override);else{for(this.center_of_mass.set(0,0,0),t=0;t<this.child_shapes.length;t++)this.center_of_mass.add(this.child_shapes[t].local_position);this.child_shapes.length>0&&this.center_of_mass.scale(1/this.child_shapes.length)}for(t=0;t<this.child_shapes.length;t++)this.child_shapes[t].center_of_mass.copy(this.center_of_mass),this.child_shapes[t].updateDerived()},e.CompoundShape.prototype.updateFaceNormals=function(){this.faceNormals.length=0;for(var t=0;t<this.child_shapes.length;t++)this.faceNormals.push.apply(this.faceNormals,this.child_shapes[t].faceNormals);e.Collision.SAT.removeDuplicatedVectors(this.faceNormals)},e.CompoundShape.prototype.calculateLocalAABB=function(t){if(t.min.x=t.min.y=t.min.z=1/0,t.max.x=t.max.y=t.max.z=-(1/0),0!==this.child_shapes.length){var i,e;for(i=0;i<this.child_shapes.length;i++)e=this.child_shapes[i],t.min.x=Math.min(t.min.x,e.aabb.min.x),t.min.y=Math.min(t.min.y,e.aabb.min.y),t.min.z=Math.min(t.min.z,e.aabb.min.z),t.max.x=Math.max(t.max.x,e.aabb.max.x),t.max.y=Math.max(t.max.y,e.aabb.max.y),t.max.z=Math.max(t.max.z,e.aabb.max.z)}},e.CompoundShape.prototype.computeSteiner=function(t,i,e){e.e00=i*-(t.y*t.y+t.z*t.z),e.e10=i*t.x*t.y,e.e20=i*t.x*t.z,e.e01=i*t.x*t.y,e.e11=i*-(t.x*t.x+t.z*t.z),e.e21=i*t.y*t.z,e.e02=i*t.x*t.z,e.e12=i*t.y*t.z,e.e22=i*-(t.x*t.x+t.y*t.y)},e.CompoundShape.prototype.getInertiaTensor=function(t){var i,n,s,a=new e.Matrix3,r=new e.Matrix3;if(0===this.child_shapes.length||t===1/0)return a.e00=a.e11=a.e22=t,a;var c=t/this.child_shapes.length;for(o.copy(this.center_of_mass),i=0;i<this.child_shapes.length;i++)n=this.child_shapes[i],o.subtract(n.local_position),this.computeSteiner(o,c,r),p.fromMatrix4(n.transform),s=n.shape.getInertiaTensor(c),p.transposeInto(u),p.multiply(s),p.multiply(u),a.e00+=p.e00-r.e00,a.e10+=p.e10-r.e10,a.e20+=p.e20-r.e20,a.e01+=p.e01-r.e01,a.e11+=p.e11-r.e11,a.e21+=p.e21-r.e21,a.e02+=p.e02-r.e02,a.e12+=p.e12-r.e12,a.e22+=p.e22-r.e22,o.copy(n.local_position);return o.subtract(this.center_of_mass),this.computeSteiner(o,c,r),a.e00+=-r.e00,a.e10+=-r.e10,a.e20+=-r.e20,a.e01+=-r.e01,a.e11+=-r.e11,a.e21+=-r.e21,a.e02+=-r.e02,a.e12+=-r.e12,a.e22+=-r.e22,a},e.CompoundShape.prototype.rayIntersect=function(t,i,o){var n,s,a,r=[],c=new e.Vector3,h=new e.Vector3;for(s=0;s<this.child_shapes.length&&(a=this.child_shapes[s],a.transform_inverse.transformVector3Into(t,c),a.transform_inverse.transformVector3Into(i,h),n=a.shape.rayIntersect(c,h),null!=n&&(n.shape=a.shape,a.transform.transformVector3(n.point),r.push(n)),!(r.length>=o));s++);return r},e.CompoundShapeChild=function(t,i,o){this.shape=t,this.local_position=new e.Vector3(i.x,i.y,i.z),this.center_of_mass=new e.Vector3,this.position=new e.Vector3,this.rotation=new e.Quaternion(o.x,o.y,o.z,o.w),this.transform=new e.Matrix4,this.transform_inverse=new e.Matrix4,this.aabb=new e.AABB,this.faceNormals=[],this.updateDerived()},e.CompoundShapeChild.prototype.updateDerived=function(){if(this.position.copy(this.local_position),this.position.subtract(this.center_of_mass),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.rotation.isZero())this.faceNormals=this.shape.faceNormals;else{this.faceNormals.length=0;for(var t=0;t<this.shape.faceNormals.length;t++){var i=new e.Vector3;this.rotation.transformVector3Into(this.shape.faceNormals[t],i),this.faceNormals.push(i)}}},e.ConvexHullShape=function(t,i){this.shapeType=e.Shapes.Type.ConvexHullShape,this.vertices=[],this.edges=[],this.faces=[],this.material=i,this.aabb=new e.AABB,this.faceNormals=[],this.edgeDirections=[],this.volume=0,this.center_of_mass=new e.Vector3,this._integral=new Float32Array(10),this._buildInitialSimplex(t),this._processUnclaimedPoints(),this._calculateVerticesEdgesAndNormalsFromFaces(),this._cleanup(),this.calculateLocalAABB(this.aabb),this.computeVolume()},e.ConvexHullShape.prototype.findSupportPoint=function(t,i){for(var e=null,o=-(1/0),n=0;n<this.vertices.length;n++){var s=this.vertices[n].position.dot(t);s>o&&(o=s,e=this.vertices[n])}i.copy(e.position)},e.ConvexHullShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=1/0,t.max.x=t.max.y=t.max.z=-(1/0);for(var i=0;i<this.vertices.length;i++)t.min.x=Math.min(t.min.x,this.vertices[i].position.x),t.min.y=Math.min(t.min.y,this.vertices[i].position.y),t.min.z=Math.min(t.min.z,this.vertices[i].position.z),t.max.x=Math.max(t.max.x,this.vertices[i].position.x),t.max.y=Math.max(t.max.y,this.vertices[i].position.y),t.max.z=Math.max(t.max.z,this.vertices[i].position.z)},e.ConvexHullShape.prototype.rayIntersect=function(){var t=new e.Vector3,i=0,o=1,n=null,s=!0,a=null,r=0,c=0,h=0;return function(l,p){t.subtractVectors(p,l),i=0,o=1,n=null,s=!0;for(var u=0;u<this.faces.length;u++)if(a=this.faces[u],r=a._getDistanceFromPlaneToPoint(l),c=a.normal.dot(t),h=-r/c,r>0&&(s=!1),c>e.EPSILON)o=Math.min(o,h);else if(c<-e.EPSILON)h>i&&(i=h,n=a);else if(r>e.EPSILON)return null;if(s)return null;var _=e.ObjectPool.getObject("RayIntersection");return _.object=this,_.t=i,_.point.scaleVector(t,i),_.point.add(l),_.normal.copy(n.normal),_}}(),e.ConvexHullShape.prototype.computeVolume=function(){var t=new e.Vector3,i=new Float32Array(6),o=function(t,e,o){var n=t+e,s=t*t,a=s+e*n;i[0]=n+o,i[1]=a+o*i[0],i[2]=t*s+e*a+o*i[1],i[3]=i[1]+t*(i[0]+t),i[4]=i[1]+e*(i[0]+e),i[5]=i[1]+o*(i[0]+o)};return function(){for(var e=0;e<this.faces.length;e++){var n=this.faces[e],s=n.edge,a=s.next;do{var r=s.getHead().position,c=a.getHead().position,h=a.getTail().position,l=c.x-r.x,p=c.y-r.y,u=c.z-r.z,_=h.x-r.x,f=h.y-r.y,b=h.z-r.z,d=p*b-f*u,m=_*u-l*b,y=l*f-_*p;o(r.x,c.x,h.x);var v=i[0],x=i[1],w=i[2],g=i[3],j=i[4],V=i[5];o(r.y,c.y,h.y);var C=i[1],S=i[2],z=i[3],P=i[4],O=i[5];o(r.z,c.z,h.z);var B=i[1],M=i[2],T=i[3],I=i[4],A=i[5],E=n._getDistanceFromPlaneToPoint(t)>0?-1:1;this._integral[0]+=E*d*v,this._integral[1]+=E*d*x,this._integral[2]+=E*m*C,this._integral[3]+=E*y*B,this._integral[4]+=E*d*w,this._integral[5]+=E*m*S,this._integral[6]+=E*y*M,this._integral[7]+=E*d*(r.y*g+c.y*j+h.y*V),this._integral[8]+=E*m*(r.z*z+c.z*P+h.z*O),this._integral[9]+=E*y*(r.x*T+c.x*I+h.x*A),a=a.next}while(a.next!==s)}this._integral[0]*=1/6,this._integral[1]*=1/24,this._integral[2]*=1/24,this._integral[3]*=1/24,this._integral[4]*=1/60,this._integral[5]*=1/60,this._integral[6]*=1/60,this._integral[7]*=1/120,this._integral[8]*=1/120,this._integral[9]*=1/120,this.volume=this._integral[0],this.center_of_mass.x=this._integral[1]/this.volume,this.center_of_mass.y=this._integral[2]/this.volume,this.center_of_mass.z=this._integral[3]/this.volume}}(),e.ConvexHullShape.prototype.getInertiaTensor=function(t){return e.ConvexShape.prototype.getInertiaTensor.call(this,t)},e.ConvexHullShape.prototype._buildInitialSimplex=function(){var t=[a,r,c],i=new e.Vector3,s=null;return function(a){for(var r=a.slice(0),c=null,h=null,l=0;l<t.length;l++){for(var p=1/0,u=-(1/0),_=0;_<r.length;_++){var f=r[_].dot(t[l]);p>f?(c=r[_],p=f):f>u&&(h=r[_],u=f)}if(null!==c&&null!==h&&u>p)break;c=null,h=null}if(null===c||null===h)throw new Error("Degenerate point cloud, either 1D or 2D");var b=null,d=-(1/0);for(l=0;l<r.length;l++)if(s=r[l],s!==c&&s!==h){var m=e.GeometryMethods.findSquaredDistanceFromSegment(s,c,h);m>d&&(d=m,b=s)}if(null===b||Math.abs(d)<e.EPSILON)throw new Error("Degenerate point cloud in 2D");o.subtractVectors(c,h),n.subtractVectors(b,h),i.crossVectors(o,n),i.normalize();var y=h.dot(i),v=null,x=-(1/0);for(l=0;l<r.length;l++)if(s=r[l],s!==c&&s!==h&&s!==b){var w=Math.abs(i.dot(s)-y);w>x&&(x=w,v=s)}if(null===v||Math.abs(x)<e.EPSILON)throw new Error("Degenerate point cloud in 2D");var g=new e.ConvexHullShape.Vertex(c),j=new e.ConvexHullShape.Vertex(h),V=new e.ConvexHullShape.Vertex(b),C=new e.ConvexHullShape.Vertex(v),S=v.dot(i)-y<0,z=[],P=0;if(S)for(z[0]=this._createTriangle(g,j,V),z[1]=this._createTriangle(C,j,g),
z[2]=this._createTriangle(C,V,j),z[3]=this._createTriangle(C,g,V),l=0;3>l;l++)P=(l+1)%3,z[l+1].getEdge(1).setTwin(z[P+1].getEdge(0)),z[l+1].getEdge(2).setTwin(z[0].getEdge(P));else for(z[0]=this._createTriangle(g,V,j),z[1]=this._createTriangle(C,g,j),z[2]=this._createTriangle(C,j,V),z[3]=this._createTriangle(C,V,g),l=0;3>l;l++)P=(l+1)%3,z[l+1].getEdge(0).setTwin(z[P+1].getEdge(1)),z[l+1].getEdge(2).setTwin(z[0].getEdge((3-l)%3));for(this.faces.push(z[0],z[1],z[2],z[3]),l=0;l<r.length;l++)s=r[l],s!==c&&s!==h&&s!==b&&s!==v&&this._assignUnusedVertex(new e.ConvexHullShape.Vertex(s),this.faces)}}(),e.ConvexHullShape.prototype._processUnclaimedPoints=function(){for(var t=this._getNextFaceForExtension();null!==t;){var i=t.tmpClosestOutsideVertex;this._addVertex(i,t),t=this._getNextFaceForExtension()}},e.ConvexHullShape.prototype._addVertex=function(t,i){var o=i.tmpAllOutsideVertices;o[o.indexOf(t)]=o[o.length-1],o.pop();var n=[];this._calculateHorizon(t.position,null,i,n);for(var s=this._addNewFacesFromHorizon(t,n),a=0;a<s.length;a++){var r=s[a],c=!1;do c=this._mergeWithAdjacent(r);while(c);this.faces.push(r)}var h=[];for(a=0;a<this.faces.length;a++){var l=this.faces[a];if(l.tmpStatus!==e.ConvexHullShape.Face.Status.Visible){this.faces[a]=this.faces[this.faces.length-1],this.faces.pop(),a--;for(var p=0;p<l.tmpAllOutsideVertices.length;p++)h.push(l.tmpAllOutsideVertices[p])}}for(a=0;a<h.length;a++)this._assignUnusedVertex(h[a],s)},e.ConvexHullShape.prototype._mergeWithAdjacent=function(t){var i=t.edge;do{var o=i.getOppositeFacePlaneDistance()>-e.EPSILON&&i.twin.getOppositeFacePlaneDistance()>-e.EPSILON;if(o)return this._mergeOnEdge(t,i),!0;i=i.next}while(i!==t.edge);return!1},e.ConvexHullShape.prototype._mergeOnEdge=function(t,i){var o=i.getOppositeFace();o.tmpStatus=e.ConvexHullShape.Face.Status.Deleted;for(var n=i.twin,s=i.previous,a=i.next,r=n.previous,c=n.next,h=s;s.getOppositeFace()===o;)if(s=s.previous,c=c.next,s===h)throw new Error("Degenerated face");for(h=a;a.getOppositeFace()===o;)if(r=r.previous,a=a.next,a===h)throw new Error("Degenerated face");var l;for(l=c;l!==r.next;l=l.next)l.face=t;t.edge===i&&(t.edge=a),r.next=a,a.prev=r,s.next=c,c.prev=s,t.computeNormalAndCentroid()},e.ConvexHullShape.prototype._getNextFaceForExtension=function(){for(var t=null,i=-(1/0),e=0;e<this.faces.length;e++){var o=this.faces[e],n=o.tmpClosestOutsideVertex;null!==n&&n.tmpDistanceToFace>i&&(i=n.tmpDistanceToFace,t=o)}return t},e.ConvexHullShape.prototype._calculateHorizon=function(t,i,o,n){o.tmpStatus=e.ConvexHullShape.Face.Status.Deleted;var s=null;null===i?(i=o.edge,s=i):s=i.next;do{var a=s.getOppositeFace();if(a.tmpStatus===e.ConvexHullShape.Face.Status.Visible){var r=a._getDistanceFromPlaneToPoint(t);r>e.EPSILON?this._calculateHorizon(t,s.twin,a,n):n.push(s),s=s.next}}while(i!==s)},e.ConvexHullShape.prototype._addNewFacesFromHorizon=function(t,i){for(var e=[],o=null,n=null,s=0;s<i.length;s++){var a=i[s],r=this._createTriangle(t,a.getHead(),a.getTail());e.push(r),r.getEdge(2).setTwin(a.twin);var c=r.edge;null!==o?c.next.setTwin(o):n=c,o=c}return n.next.setTwin(o),e},e.ConvexHullShape.prototype._createTriangle=function(t,i,o){var n=new e.ConvexHullShape.Face,s=new e.ConvexHullShape.HalfEdge;s.tail=t,s.face=n;var a=new e.ConvexHullShape.HalfEdge;a.tail=i,a.face=n;var r=new e.ConvexHullShape.HalfEdge;return r.tail=o,r.face=n,s.previous=r,s.next=a,a.previous=s,a.next=r,r.previous=a,r.next=s,n.edge=s,n.computeNormalAndCentroid(),n},e.ConvexHullShape.prototype._assignUnusedVertex=function(t,i){for(var o=0;o<i.length;o++){var n=i[o],s=n._getDistanceFromPlaneToPoint(t.position);if(!(s<=e.EPSILON)){t.tmpDistanceToFace=s,n.tmpAllOutsideVertices.push(t),(null===n.tmpClosestOutsideVertex||n.tmpClosestOutsideVertex.tmpDistanceToFace<s)&&(n.tmpClosestOutsideVertex=t);break}}},e.ConvexHullShape.prototype._calculateVerticesEdgesAndNormalsFromFaces=function(){this.vertices.length=0,this.edges.length=0;for(var t=0;t<this.faces.length;t++){var i=this.faces[t],o=i.edge;this.faceNormals.push(i.normal);do{if(-1===this.edges.indexOf(o)){this.edges.push(o);var n=new e.Vector3;n.subtractVectors(o.getTail(),o.getHead()),n.normalize(),this.edgeDirections.push(n)}var s=o.getTail();-1===this.vertices.indexOf(s)&&this.vertices.push(s),o=o.next}while(o!==i.edge)}},e.ConvexHullShape.prototype._cleanup=function(){for(var t=0;t<this.vertices.length;t++)this.vertices[t].tmpDistanceToFace=0;for(t=0;t<this.faces.length;t++){var i=this.faces[t];i.tmpClosestOutsideVertex=null,i.tmpAllOutsideVertices=[]}},e.ConvexHullShape.Vertex=function(t){this.position=t,this.tmpDistanceToFace=0},e.ConvexHullShape.HalfEdge=function(){this.next=null,this.previous=null,this.twin=null,this.tail=null,this.face=null},e.ConvexHullShape.HalfEdge.prototype.getOppositeFace=function(){return this.twin.face},e.ConvexHullShape.HalfEdge.prototype.getHead=function(){return this.twin.tail},e.ConvexHullShape.HalfEdge.prototype.getTail=function(){return this.tail},e.ConvexHullShape.HalfEdge.prototype.setTwin=function(t){this.twin=t,t.twin=this},e.ConvexHullShape.HalfEdge.prototype.getOppositeFacePlaneDistance=function(){return this.face._getDistanceFromPlaneToPoint(this.twin.face.centroid)},e.ConvexHullShape.Face=function(){this.edge=null,this.normal=new e.Vector3,this.centroid=new e.Vector3,this.planeOffset=0,this.tmpAllOutsideVertices=[],this.tmpClosestOutsideVertex=null,this.tmpStatus=e.ConvexHullShape.Face.Status.Visible},e.ConvexHullShape.Face.prototype._getDistanceFromPlaneToPoint=function(t){return this.normal.dot(t)-this.planeOffset},e.ConvexHullShape.Face.prototype.computeNormalAndCentroid=function(){var t=this.edge;this.centroid.copy(t.getTail().position);for(var i=null,e=null,s=t.next,a=1;t!==s;)null===i?i=s:null===e&&(e=s),this.centroid.add(s.getTail().position),a++,s=s.next;this.centroid.scale(1/a);var r=t.getTail().position,c=i.getTail().position,h=e.getTail().position;o.subtractVectors(r,c),n.subtractVectors(h,c),this.normal.crossVectors(o,n),this.normal.normalize(),this.planeOffset=this.normal.dot(this.centroid)},e.ConvexHullShape.Face.prototype.getEdge=function(t){for(var i=this.edge;t>0;)i=i.next,t--;return i},e.ConvexHullShape.Face.Status={Visible:0,Deleted:1},e.ConvexShape=function(t){this.shapeType=e.Shapes.Type.ConvexShape,this.vertices=[],this.faces=[],this.volume=0,this.center_of_mass=new e.Vector3,this._integral=new Float32Array(10),this.process(t),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.faceNormals=[]},e.ConvexShape.prototype.process=function(t){for(var i=t.slice(),s=null,a=null,r=0;r<i.length;r++){var c=i[r];(null==s||s.x>c.x)&&(s=c),(null==a||a.x>c.x)&&(a=c)}s===a&&(a=t[0]===s?t[1]:t[0]);var h=s,l=a;i.splice(i.indexOf(h),1),i.splice(i.indexOf(l),1);var p,u,_=-(1/0),f=null;for(r=0;r<i.length;r++)p=i[r],u=e.GeometryMethods.findSquaredDistanceFromSegment(p,h,l),u>_&&(_=u,f=r);var b=i[f];for(i.splice(f,1),o.subtractVectors(l,h),n.subtractVectors(b,h),o.cross(n),_=-(1/0),f=null,r=0;r<i.length;r++)p=i[r],u=Math.abs(o.dot(p)),u>_&&(_=u,f=r);var d=i[f];if(i.splice(f,1),o.dot(d)>0){var m=h;h=b,b=m}var y=new e.GjkEpa.Polyhedron({points:[{point:b},{point:l},{point:h},{point:d}]});for(r=0;r<i.length;r++){y.closest_face=null;for(var v=0;v<y.faces.length;v++)if(y.faces[v].active===!0&&y.faces[v].classifyVertex({point:i[r]})>0){y.closest_face=v;break}null!=y.closest_face&&y.addVertex({point:i[r]})}this.faces=y.faces.filter(function(t){return t.active});var x=this;this.faces.forEach(function(t){var i=t.a.point,e=t.b.point,o=t.c.point,n=x.vertices.indexOf(i),s=x.vertices.indexOf(e),a=x.vertices.indexOf(o);-1===n&&x.vertices.push(i),-1===s&&x.vertices.push(e),-1===a&&x.vertices.push(o)}),this.computeVolume(this.faces)},e.ConvexShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=0,t.max.x=t.max.y=t.max.z=0;for(var i=0;i<this.vertices.length;i++)t.min.x=Math.min(t.min.x,this.vertices[i].x),t.min.y=Math.min(t.min.y,this.vertices[i].y),t.min.z=Math.min(t.min.z,this.vertices[i].z),t.max.x=Math.max(t.max.x,this.vertices[i].x),t.max.y=Math.max(t.max.y,this.vertices[i].y),t.max.z=Math.max(t.max.z,this.vertices[i].z)},e.ConvexShape.prototype.computeVolume=function(){var t={point:new e.Vector3},i=new Float32Array(6),o=function(t,e,o){var n=t+e,s=t*t,a=s+e*n;i[0]=n+o,i[1]=a+o*i[0],i[2]=t*s+e*a+o*i[1],i[3]=i[1]+t*(i[0]+t),i[4]=i[1]+e*(i[0]+e),i[5]=i[1]+o*(i[0]+o)};return function(e){for(var n=0;n<e.length;n++){var s=e[n],a=s.a.point,r=s.b.point,c=s.c.point,h=r.x-a.x,l=r.y-a.y,p=r.z-a.z,u=c.x-a.x,_=c.y-a.y,f=c.z-a.z,b=l*f-_*p,d=u*p-h*f,m=h*_-u*l;o(a.x,r.x,c.x);var y=i[0],v=i[1],x=i[2],w=i[3],g=i[4],j=i[5];o(a.y,r.y,c.y);var V=(i[0],i[1]),C=i[2],S=i[3],z=i[4],P=i[5];o(a.z,r.z,c.z);var O=(i[0],i[1]),B=i[2],M=i[3],T=i[4],I=i[5],A=s.classifyVertex(t)>0?-1:1;this._integral[0]+=A*b*y,this._integral[1]+=A*b*v,this._integral[2]+=A*d*V,this._integral[3]+=A*m*O,this._integral[4]+=A*b*x,this._integral[5]+=A*d*C,this._integral[6]+=A*m*B,this._integral[7]+=A*b*(a.y*w+r.y*g+c.y*j),this._integral[8]+=A*d*(a.z*S+r.z*z+c.z*P),this._integral[9]+=A*m*(a.x*M+r.x*T+c.x*I)}this._integral[0]*=1/6,this._integral[1]*=1/24,this._integral[2]*=1/24,this._integral[3]*=1/24,this._integral[4]*=1/60,this._integral[5]*=1/60,this._integral[6]*=1/60,this._integral[7]*=1/120,this._integral[8]*=1/120,this._integral[9]*=1/120,this.volume=this._integral[0],this.center_of_mass.x=this._integral[1]/this.volume,this.center_of_mass.y=this._integral[2]/this.volume,this.center_of_mass.z=this._integral[3]/this.volume}}(),e.ConvexShape.prototype.getInertiaTensor=function(){return function(t){var i=new e.Matrix3;return t/=this.volume,i.e00=(this._integral[5]+this._integral[6])*t,i.e11=(this._integral[4]+this._integral[6])*t,i.e22=(this._integral[4]+this._integral[5])*t,i.e10=i.e01=-this._integral[7]*t,i.e21=i.e12=-this._integral[8]*t,i.e20=i.e02=-this._integral[9]*t,i.e00-=t*(this.center_of_mass.y*this.center_of_mass.y+this.center_of_mass.z*this.center_of_mass.z),i.e11-=t*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.z*this.center_of_mass.z),i.e22-=t*(this.center_of_mass.x*this.center_of_mass.x+this.center_of_mass.y*this.center_of_mass.y),i.e10+=t*this.center_of_mass.x*this.center_of_mass.y,i.e01+=t*this.center_of_mass.x*this.center_of_mass.y,i.e21+=t*this.center_of_mass.y*this.center_of_mass.z,i.e12+=t*this.center_of_mass.y*this.center_of_mass.z,i.e20+=t*this.center_of_mass.x*this.center_of_mass.z,i.e02+=t*this.center_of_mass.x*this.center_of_mass.z,i}}(),e.ConvexShape.prototype.findSupportPoint=function(t,i){for(var e,o,n=-(1/0),s=0;s<this.vertices.length;s++)o=this.vertices[s].dot(t),o>n&&(n=o,e=s);i.copy(this.vertices[e])},e.ConvexShape.prototype.rayIntersect=function(){{var t,i,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=new e.Vector3,c=new e.Vector3;new e.Vector3,new e.Vector3}return function(h,l){t=0,o.subtractVectors(l,h),i=o.length(),o.scale(1/i);for(var p=0;p<this.faces.length;p++){var u=this.faces[p];n.subtractVectors(u.b.point,u.a.point),s.subtractVectors(u.c.point,u.a.point),a.crossVectors(o,s);var _=n.dot(a);if(!(_<e.EPSILON)){var f=1/_;r.subtractVectors(h,u.a.point);var b=f*r.dot(a);if(!(0>b)){c.crossVectors(r,n);var d=f*o.dot(c);if(!(0>d||b+d>1)){var m=f*s.dot(c);if(!(t>m||m>i)){var y=e.ObjectPool.getObject("RayIntersection");return y.object=this,y.t=m,y.point.scaleVector(o,m),y.point.add(h),y.normal.copy(u.normal),y}}}}}return null}}(),e.MeshShape=function(t,i,o){this.shapeType=e.Shapes.Type.MeshShape,this.vertices=t,this.triangles=[];for(var n=0;n<i.length;n+=3)this.triangles.push(new e.TriangleShape(t[i[n]],t[i[n+1]],t[i[n+2]]));this.volume=0,this.center_of_mass=new e.Vector3,this._integral=new Float32Array(10),this.hierarchy=new e.BVH(this.triangles).tree;var s=this.triangles.map(function(t){return new e.GjkEpa.Face(null,{point:t.a},{point:t.b},{point:t.c})});e.ConvexShape.prototype.computeVolume.call(this,s),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.faceNormals=[],this.material=o||null},e.MeshShape.prototype.clone=function(){var t=Object.create(e.MeshShape.prototype);return t.vertices=this.vertices,t.triangles=this.triangles,t.volume=this.volume,t.center_of_mass=this.center_of_mass,t._integral=this._integral,t.hierarchy=this.hierarchy,t.aabb=this.aabb,t.material=this.material,t},e.MeshShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=0,t.max.x=t.max.y=t.max.z=0;for(var i=0;i<this.vertices.length;i++)t.min.x=Math.min(t.min.x,this.vertices[i].x),t.min.y=Math.min(t.min.y,this.vertices[i].y),t.min.z=Math.min(t.min.z,this.vertices[i].z),t.max.x=Math.max(t.max.x,this.vertices[i].x),t.max.y=Math.max(t.max.y,this.vertices[i].y),t.max.z=Math.max(t.max.z,this.vertices[i].z)},e.MeshShape.prototype.getInertiaTensor=function(t){return e.ConvexShape.prototype.getInertiaTensor.call(this,t)},e.MeshShape.prototype.findSupportPoint=function(t,i){},e.MeshShape.prototype.rayIntersect=function(){var t=[],i=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};return function(e,o){if(!this.hierarchy)return null;var n,s=[this.hierarchy];t.length=0;for(var a=0;s.length>0;)if(a++,n=s.shift(),n.aabb.testRayIntersect(e,o))if(n.isLeaf()){var r=n.object.rayIntersect(e,o);null!=r&&t.push(r)}else s.push(n.left,n.right);return t.sort(i),t[0]||null}}(),e.PlaneShape=function(t,i,o){this.shapeType=e.Shapes.Type.PlaneShape,this.orientation=t,this.half_width=i,this.half_length=o,this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.faceNormals=[],0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0)},e.PlaneShape.prototype.calculateLocalAABB=function(t){0===this.orientation?(this._half_width=0,this._half_height=this.half_width,this._half_depth=this.half_length,t.min.x=0,t.min.y=-this.half_width,t.min.z=-this.half_length,t.max.x=0,t.max.y=this.half_width,t.max.z=this.half_length):1===this.orientation?(this._half_width=this.half_width,this._half_height=0,this._half_depth=this.half_length,t.min.x=-this.half_width,t.min.y=0,t.min.z=-this.half_length,t.max.x=this.half_width,t.max.y=0,t.max.z=this.half_length):(this._half_width=this.half_width,this._half_height=this.half_length,this._half_depth=0,t.min.x=-this.half_width,t.min.y=-this.half_length,t.min.z=0,t.max.x=this.half_width,t.max.y=this.half_length,t.max.z=0)},e.PlaneShape.prototype.getInertiaTensor=function(t){var i=this.half_width*this.half_width*4,o=this.half_length*this.half_length*4,n=.0833*t,s=n*o,a=n*(i+o),r=n*i;return 0===this.orientation?new e.Matrix3(a,0,0,0,s,0,0,0,r):1===this.orientation?new e.Matrix3(s,0,0,0,a,0,0,0,r):new e.Matrix3(a,0,0,0,r,0,0,0,s)},e.PlaneShape.prototype.findSupportPoint=function(t,i){i.x=t.x<0?-this._half_width:this._half_width,i.y=t.y<0?-this._half_height:this._half_height,i.z=t.z<0?-this._half_depth:this._half_depth},e.PlaneShape.prototype.rayIntersect=function(){var t,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3;return function(s,a){if(0===this.orientation?(i.x=1,i.y=i.z=0):1===this.orientation?(i.y=1,i.x=i.z=0):(i.z=1,i.x=i.y=0),o.subtractVectors(a,s),t=-i.dot(s)/i.dot(o),0>t||t>1)return null;if(n.scaleVector(o,t),n.add(s),n.x<-this._half_width||n.x>this._half_width)return null;if(n.y<-this._half_height||n.y>this._half_height)return null;if(n.z<-this._half_depth||n.z>this._half_depth)return null;var r=e.ObjectPool.getObject("RayIntersection");return r.object=this,r.t=t*o.length(),r.point.copy(n),r.normal.copy(i),r}}(),e.SphereShape=function(t,i){this.shapeType=e.Shapes.Type.SphereShape,this.radius=t,this.aabb=new e.AABB,this.material=i||null,this.faceNormals=[],this.calculateLocalAABB(this.aabb)},e.SphereShape.prototype.calculateLocalAABB=function(t){t.min.x=t.min.y=t.min.z=-this.radius,t.max.x=t.max.y=t.max.z=this.radius},e.SphereShape.prototype.getInertiaTensor=function(t){var i=.4*t*this.radius*this.radius;return new e.Matrix3(i,0,0,0,i,0,0,0,i)},e.SphereShape.prototype.findSupportPoint=function(t,i){o.normalizeVector(t),i.scaleVector(o,this.radius)},e.SphereShape.prototype.rayIntersect=function(){var t,i=new e.Vector3;return function(o,n){if(i.subtractVectors(n,o),t=i.length(),Math.abs(t)<e.EPSILON)return null;i.scale(1/t);var s=o.dot(i),a=o.lengthSquared()-this.radius*this.radius;if(s>=0&&a>=0)return null;var r=s*s-a;if(0>r)return null;var c=Math.sqrt(r),h=-s-c;if(0>h&&(h=-s+c),h>t)return null;var l=e.ObjectPool.getObject("RayIntersection");return l.object=this,l.point.scaleVector(i,h),l.point.add(o),l.t=h,l.normal.normalizeVector(l.point),l}}(),e.TriangleShape=function(t,i,s){this.shapeType=e.Shapes.Type.TriangleShape,this.a=t,this.b=i,this.c=s,this.normal=new e.Vector3,o.subtractVectors(this.b,this.a),n.subtractVectors(this.c,this.a),this.normal.crossVectors(o,n),this.volume=this.normal.length()/2,this.normal.normalize(),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.faceNormals=[]},e.TriangleShape.prototype.calculateLocalAABB=function(t){t.min.x=Math.min(this.a.x,this.b.x,this.c.x),t.min.y=Math.min(this.a.y,this.b.y,this.c.y),t.min.z=Math.min(this.a.z,this.b.z,this.c.z),t.max.x=Math.max(this.a.x,this.b.x,this.c.x),t.max.y=Math.max(this.a.y,this.b.y,this.c.y),t.max.z=Math.max(this.a.z,this.b.z,this.c.z)},e.TriangleShape.prototype.getInertiaTensor=function(t){return new e.Matrix3(0,0,0,0,0,0,0,0,0)},e.TriangleShape.prototype.classifyVertex=function(t){var i=this.normal.dot(this.a);return this.normal.dot(t)-i},e.TriangleShape.prototype.findSupportPoint=function(t,i){var e,o=-(1/0);e=t.dot(this.a),e>o&&(i.copy(this.a),o=e),e=t.dot(this.b),e>o&&(i.copy(this.b),o=e),e=t.dot(this.c),e>o&&i.copy(this.c)},e.TriangleShape.prototype.rayIntersect=function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3;return function(r,c){t.subtractVectors(this.b,this.a),i.subtractVectors(this.c,this.a),o.crossVectors(t,i),n.subtractVectors(c,r);var h=-n.dot(o);if(0>=h)return null;s.subtractVectors(r,this.a);var l=s.dot(o)/h;if(0>l||l>1)return null;a.crossVectors(s,n);var p=i.dot(a)/h,u=-t.dot(a)/h;if(p+u>1||0>p||0>u)return null;var _=e.ObjectPool.getObject("RayIntersection");return _.object=this,_.t=l*n.length(),_.point.scaleVector(n,l),_.point.add(r),_.normal.copy(this.normal),_}}(),e.Shapes.Type={BoxShape:1,CapsuleShape:2,CompoundShape:4,ConvexHullShape:8,ConvexShape:16,MeshShape:32,PlaneShape:64,SphereShape:128,TriangleShape:256},e.Shapes={},e.CollisionUtils={},e.CollisionUtils.canBodiesCollide=function(t,i){if(null===t.world||null===i.world)return!0;var e=t.world.collision_matrix;return(t._is_static||t._is_kinematic)&&(i._is_static||i._is_kinematic)?!1:e[t.layer]&&e[t.layer][i.layer]===!1?!1:!0},e.CollisionUtils.combineFrictions=function(t,i,e,o){return null===e.material&&null===o.material?(t.friction+i.friction)/2:null===e.material?this.combineValues(0,o.material.frictionCombine,t.friction||0,o.material.dynamicFriction):null===o.material?this.combineValues(e.material.frictionCombine,0,e.material.dynamicFriction,o.friction||0):this.combineValues(e.material.frictionCombine,o.material.frictionCombine,e.material.dynamicFriction,o.material.dynamicFriction)},e.CollisionUtils.combineRestitutions=function(t,i,e,o){return null===e.material&&null===o.material?(t.restitution+i.restitution)/2:null===e.material?this.combineValues(0,o.material.bounceCombine,t.restitution||0,o.material.bounciness):null===o.material?this.combineValues(e.material.bounceCombine,0,e.material.bounciness,i.restitution||0):this.combineValues(e.material.bounceCombine,o.material.bounceCombine,e.material.bounciness,o.material.bounciness)},e.CollisionUtils.combineValues=function(t,i,e,o){switch(Math.max(t,i)){case 1:return e*o;case 2:return Math.min(e,o);case 3:return Math.max(e,o);default:return(e+o)/2}},e.GeometryMethods={findClosestPointInTriangle:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e,n,s,a,r){var c;t.subtractVectors(s,n),i.subtractVectors(a,n),o.subtractVectors(e,n);var h=t.dot(o),l=i.dot(o);if(0>=h&&0>=l)return void r.copy(n);o.subtractVectors(e,s);var p=t.dot(o),u=i.dot(o);if(p>=0&&p>=u)return void r.copy(s);var _=h*u-p*l;if(0>=_&&h>=0&&0>=p)return c=h/(h-p),void r.set(n.x+t.x*c,n.y+t.y*c,n.z+t.z*c);o.subtractVectors(e,a);var f=t.dot(o),b=i.dot(o);if(b>=0&&b>=f)return void r.copy(a);var d,m=f*l-h*b;if(0>=m&&l>=0&&0>=b)return d=l/(l-b),void r.set(n.x+i.x*d,n.y+i.y*d,n.z+i.z*d);var y=p*b-f*u;if(0>=y&&u-p>=0&&f-b>=0)return d=(u-p)/(u-p+(f-b)),void r.set(s.x+(a.x-s.x)*d,s.y+(a.y-s.y)*d,s.z+(a.z-s.z)*d);var v=y+m+_;c=m/v,d=_/v,r.set(t.x*c+n.x+i.x*d,t.y*c+n.y+i.y*d,t.z*c+n.z+i.z*d)}}(),findBarycentricCoordinates:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=0;return function(s,a,r,c,h){t.subtractVectors(r,a),i.subtractVectors(c,a),o.subtractVectors(s,a);var l=t.dot(t),p=t.dot(i),u=i.dot(i),_=o.dot(t),f=o.dot(i),b=o.dot(o),d=l*u-p*p;return Math.abs(d)<e.EPSILON?Math.abs(l)<e.EPSILON?(n=Math.sqrt(b/u),void h.set(1-n,0,n)):(n=Math.sqrt(b/l),void h.set(1-n,n,0)):(h.y=(u*_-p*f)/d,h.z=(l*f-p*_)/d,void(h.x=1-h.y-h.z))}}(),findSquaredDistanceFromSegment:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3;return function(e,n,s){t.subtractVectors(n,s),i.subtractVectors(n,e),o.subtractVectors(s,e);var a=i.dot(t);if(0>=a)return i.dot(i);var r=t.dot(t);return a>=r?o.dot(o):i.dot(i)-a*a/r}}(),findClosestPointOnASegment:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=0;return function(s,a,r,c){t.subtractVectors(a,s),i.copy(t),i.normalize(),o.subtractVectors(r,s),c.copy(i),c.scale(o.dot(i)),n=t.dot(c)/t.dot(t),n=e.Math.Utils.clamp(n,0,1),c.copy(t),c.scale(n),c.add(s)}}(),findClosestPointsOnSegments:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3;return function(s,a,r,c,h,l){t.subtractVectors(a,s),i.subtractVectors(c,r),o.subtractVectors(s,r);var p,u,_=t.dot(t),f=i.dot(i),b=i.dot(o);if(_<=e.EPSILON&&f<=e.EPSILON)return p=u=0,h.copy(s),l.copy(r),n.subtractVectors(h,l),n.dot(n);if(_<=e.EPSILON)p=0,u=b/f,u=e.Utils.clamp(u,0,1);else{var d=t.dot(o);if(f<=e.EPSILON)u=0,p=e.Math.Utils.clamp(-d/_,0,1);else{var m=t.dot(i),y=_*f-m*m;p=0!==y?e.Math.Utils.clamp((m*b-d*f)/y,0,1):0,u=(m*p+b)/f,0>u?(u=0,p=e.Math.Utils.clamp(-d/_,0,1)):u>1&&(u=1,p=e.Math.Utils.clamp((m-d)/_,0,1))}}return h.scaleVector(t,p),h.add(s),l.scaleVector(i,u),l.add(r),n.subtractVectors(h,l),n.dot(n)}}(),findClosestPointToPlaneOnLineSegment:function(){return function(t,i,o,n,s){var a=t.dot(i),r=o.dot(i)-a,c=n.dot(i)-a;return r<-e.EPSILON&&c<-e.EPSILON?r>c?(s.copy(o),r):(s.copy(n),c):r>e.EPSILON&&c>e.EPSILON?c>r?(s.copy(o),r):(s.copy(n),c):(s.scaleVector(i,-c),s.add(n),0)}}(),projectPointOnPlane:function(){var t=new e.Vector3,i=0;return function(e,o,n,s){return t.subtractVectors(n,e),i=t.dot(o),s.scaleVector(o,-i),s.add(n),i}}(),getLineSegmentsIntersection:function(){var t=new e.Vector3,i=new e.Vector3,o=new e.Vector3,n=new e.Vector3,s=new e.Vector3,a=new e.Vector3,r=0,c=0,h=0;return function(l,p,u,_,f){return t.subtractVectors(p,l),i.subtractVectors(_,u),o.subtractVectors(u,l),n.crossVectors(o,i),a.crossVectors(t,i),r=a.lengthSquared(),r<e.EPSILON?!1:(c=n.dot(a)/r,0>c||c>1?!1:(s.crossVectors(o,t),h=s.dot(a)/r,0>h||h>1?!1:(f.scaleVector(t,c),f.add(l),!0)))}}()},function(){e.MinHeap=function(t){this.heap=null==t?[]:t.slice(),this.heap.length>0&&this.heapify()},e.MinHeap.prototype={heapify:function(){for(var t=~~((this.heap.length-2)/2);t>=0;)this.siftUp(t,this.heap.length-1),t--},siftUp:function(t,i){for(var e=t;i>=2*e+1;){var o=2*e+1;if(i>=o+1&&this.heap[o+1].valueOf()<this.heap[o].valueOf()&&o++,!(this.heap[o].valueOf()<this.heap[e].valueOf()))return;var n=this.heap[o];this.heap[o]=this.heap[e],this.heap[e]=n,e=o}},push:function(t){this.heap.push(t);for(var i=this.heap.length-1;0!==i;){var e=~~((i-1)/2);if(this.heap[e].valueOf()>this.heap[i].valueOf()){var o=this.heap[e];this.heap[e]=this.heap[i],this.heap[i]=o}i=e}},peek:function(){return this.heap.length>0?this.heap[0]:null},pop:function(){var t=this.heap[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.length=this.heap.length-1,this.siftUp(0,this.heap.length-1),t}}}(),e.Utility={getUid:function(){var t=0;return function(){return t++}}()},e.LineSweptShape=function(t,i,o){this.start=t,this.end=i,this.shape=o,this.direction=new e.Vector3,this.direction.subtractVectors(i,t),this.length=this.direction.length(),this.direction.normalize(),this.aabb=new e.AABB,this.calculateLocalAABB(this.aabb),this.material=null},e.LineSweptShape.prototype.calculateLocalAABB=function(t){this.shape.calculateLocalAABB(t),t.min.x=Math.min(t.min.x+this.start.x,t.min.x+this.end.x),t.min.y=Math.min(t.min.y+this.start.y,t.min.y+this.end.y),t.min.z=Math.min(t.min.z+this.start.z,t.min.z+this.end.z),t.max.x=Math.max(t.max.x+this.start.x,t.max.x+this.end.x),t.max.y=Math.max(t.max.y+this.start.y,t.max.y+this.end.y),t.max.z=Math.max(t.max.z+this.start.z,t.max.z+this.end.z)},e.LineSweptShape.prototype.getInertiaTensor=function(t){return this.shape.getInertiaTensor(t)},e.LineSweptShape.prototype.findSupportPoint=function(t,i){this.shape.findSupportPoint(t,i);var e=this.direction.dot(t);i.add(0>e?this.start:this.end)},e.LineSweptShape.prototype.rayIntersect=function(){return null},e.AABB=function(t,i){this.min=t||new e.Vector3,this.max=i||new e.Vector3},e.AABB.prototype.copy=function(t){this.min.x=t.min.x,this.min.y=t.min.y,this.min.z=t.min.z,this.max.x=t.max.x,this.max.y=t.max.y,this.max.z=t.max.z},e.AABB.prototype.combineAABBs=function(t,i){this.min.x=Math.min(t.min.x,i.min.x),this.min.y=Math.min(t.min.y,i.min.y),this.min.z=Math.min(t.min.z,i.min.z),this.max.x=Math.max(t.max.x,i.max.x),this.max.y=Math.max(t.max.y,i.max.y),this.max.z=Math.max(t.max.z,i.max.z)},e.AABB.prototype.transform=function(){var t=new e.Vector3,i=new e.Vector3;return function(e,o){t.set(0,0,0),o.transformVector3Into(t,i);for(var n=[e.min.x,e.min.y,e.min.z],s=[e.max.x,e.max.y,e.max.z],a=[i.x,i.y,i.z],r=[i.x,i.y,i.z],c=[o.e00,o.e01,o.e02,o.e10,o.e11,o.e12,o.e20,o.e21,o.e22],h=0;3>h;h++)for(var l=0;3>l;l++){var p=c[3*h+l]*n[l],u=c[3*h+l]*s[l];u>p?(a[h]+=p,r[h]+=u):(a[h]+=u,r[h]+=p)}this.min.set(a[0],a[1],a[2]),this.max.set(r[0],r[1],r[2])}}(),e.AABB.prototype.intersects=function(t){return this.max.x<t.min.x||this.max.y<t.min.y||this.max.z<t.min.z||this.min.x>t.max.x||this.min.y>t.max.y||this.min.z>t.max.z?!1:!0},e.AABB.prototype.testRayIntersect=function(){var t,i,o,n,s,a=new e.Vector3;return function(r,c){t=0,a.subtractVectors(c,r),i=a.length(),a.scale(1/i);var h,l;if(h=this.min.x,l=this.max.x,Math.abs(a.x)<e.EPSILON){if(r.x<h||r.x>l)return!1}else if(o=1/a.x,n=(h-r.x)*o,s=(l-r.x)*o,n>s&&(o=n,n=s,s=o),t=Math.max(t,n),i=Math.min(i,s),t>i)return!1;if(h=this.min.y,l=this.max.y,Math.abs(a.y)<e.EPSILON){if(r.y<h||r.y>l)return!1}else if(o=1/a.y,n=(h-r.y)*o,s=(l-r.y)*o,n>s&&(o=n,n=s,s=o),t=Math.max(t,n),i=Math.min(i,s),t>i)return!1;if(h=this.min.z,l=this.max.z,Math.abs(a.z)<e.EPSILON){if(r.z<h||r.z>l)return!1}else if(o=1/a.z,n=(h-r.z)*o,s=(l-r.z)*o,n>s&&(o=n,n=s,s=o),t=Math.max(t,n),i=Math.min(i,s),t>i)return!1;return!0}}(),function(){function t(t){var i=t.max.x-t.min.x,e=t.max.y-t.min.y,o=t.max.z-t.min.z;return i*(e+o)+e*o}var i=function(t){this.aabb=new e.AABB,this.area=0,this.parent=null,this.left=null,this.right=null,this.morton=null,this.object=t||null};i.prototype={isLeaf:function(){return null!=this.object},computeBounds:function(i){this.isLeaf()?this.aabb.copy(this.object.aabb):this.aabb.combineAABBs(this.left.aabb,this.right.aabb),this.area=t(this.aabb)},valueOf:function(){return this.area}};var o=function(){function o(t){return t=4278190335&(t^t<<16),t=50393103&(t^t<<8),t=51130563&(t^t<<4),t=153391689&(t^t<<2)}function n(t,i,e){return(o(e)<<2)+(o(i)<<1)+o(t)}var s=new e.AABB,a=function(t,i){for(var e=t.max.x-t.min.x,o=t.max.y-t.min.y,s=t.max.z-t.min.z,r=512,c=r/e,h=r/o,l=r/s,p=0;p<i.length;p++){var u=i[p],_=(u.aabb.max.x-u.aabb.min.x)/2+u.aabb.min.x,f=(u.aabb.max.y-u.aabb.min.y)/2+u.aabb.min.y,b=(u.aabb.max.z-u.aabb.min.z)/2+u.aabb.min.z;u.morton=n((_+t.min.x)*c,(f+t.min.y)*h,(b+t.min.z)*l)}i.sort(a.mortonSort);var d=a.buildTree(i,29);return a.combineCluster(d,1),d};return a.mortonSort=function(t,i){return t.morton<i.morton?-1:t.morton>i.morton?1:0},a.clusterReductionCount=function(t){var i=Math.pow(t,.5)/2,e=.5;return Math.max(i*Math.pow(t,e),1)},a.buildTree=function(t,i){var e=[];if(t.length<a.max_bucket_size)e.push.apply(e,t),a.combineCluster(e,a.clusterReductionCount(a.max_bucket_size));else{var o=[],n=[];if(1>i)o=t.slice(0,t.length/2),n=t.slice(t.length/2);else for(var s=1<<i,r=0;r<t.length;r++){var c=t[r];c.morton&s?n.push(c):o.push(c)}e.push.apply(e,a.buildTree(o,i-1)),e.push.apply(e,a.buildTree(n,i-1)),a.combineCluster(e,a.clusterReductionCount(e.length))}return e},a.combineCluster=function(t,o){if(t.length<=1)return t;for(var n,s=new e.MinHeap,r=0;r<t.length;r++)n=new i,n.left=t[r],n.right=a.findBestMatch(t,t[r]),n.computeBounds(),s.push(n);for(var c;t.length>o;)for(c=s.pop(),t.splice(t.indexOf(c.left),1),t.splice(t.indexOf(c.right),1),t.push(c),s.heap.length=0,r=0;r<t.length;r++)n=new i,n.left=t[r],n.right=a.findBestMatch(t,t[r]),n.computeBounds(),s.push(n)},a.findBestMatch=function(i,e){for(var o,n=1/0,a=0,r=0;r<i.length;r++)i[r]!==e&&(s.combineAABBs(e.aabb,i[r].aabb),o=t(s),n>o&&(n=o,a=r));return i[a]},a.max_bucket_size=20,a}();e.BVH=function(t){for(var n=[],s=new e.AABB,a=0;a<t.length;a++){s.combineAABBs(s,t[a].aabb);var r=new i(t[a]);r.computeBounds(),n.push(r)}this.tree=o(s,n)[0]},e.BVH.AAC=o}(),e.ContactDetails=function(){this.uid=e.Utility.getUid(),this.object_a=null,this.object_b=null,this.object_a_version=-1,this.object_b_version=-1,this.shape_a=null,this.shape_b=null,this.is_lightweight=!1,this.contact_point=new e.Vector3,this.contact_point_in_a=new e.Vector3,this.contact_point_in_b=new e.Vector3,this.contact_normal=new e.Vector3,this.penetration_depth=0,this.restitution=0,this.friction=0,this.constraint=null,this.tag=null,this.contactConstraint=null,this.frictionConstraint=null,this.listeners={}},e.EventEmitter.apply(e.ContactDetails),e.ContactDetails.prototype.destroy=function(){null!==this.contactConstraint&&(this.contactConstraint.deactivate(),this.contactConstraint=null),null!==this.frictionConstraint&&(this.frictionConstraint.deactivate(),this.frictionConstraint=null),e.ObjectPool.freeObject("ContactDetails",this)},e.ContactManifold=function(){this.uid="",this.object_a=null,this.object_b=null,this.points=[],this.next_manifold=null},e.ContactManifold.prototype.findWeakestContact=function(t){var i,e,s=-1,a=t.penetration_depth;for(i=0;4>i;i++)e=this.points[i],e.penetration_depth>a&&(a=e.penetration_depth,s=i);var r=0,c=0,h=0,l=0;0!==s&&(o.subtractVectors(t.contact_point_in_a,this.points[1].contact_point_in_a),n.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),o.cross(n),r=o.lengthSquared()),1!==s&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),n.subtractVectors(this.points[3].contact_point_in_a,this.points[2].contact_point_in_a),o.cross(n),c=o.lengthSquared()),2!==s&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),n.subtractVectors(this.points[3].contact_point_in_a,this.points[1].contact_point_in_a),o.cross(n),h=o.lengthSquared()),3!==s&&(o.subtractVectors(t.contact_point_in_a,this.points[0].contact_point_in_a),n.subtractVectors(this.points[2].contact_point_in_a,this.points[1].contact_point_in_a),o.cross(n),l=o.lengthSquared());var p=0,u=r;return c>u&&(p=1,u=c),h>u&&(p=2,u=h),l>u&&(p=3),p},e.ContactManifold.prototype.addContact=function(t){var i;for(i=0;i<this.points.length;i++)if(this.points[i].contact_point.distanceTo(t.contact_point)<=.02)return void t.destroy();var e=0===this.points.length;if(e&&t.object_a.onCollisionContactEnter&&t.object_a.onCollisionContactEnter(t),t.object_a_version=t.object_a.version,
t.object_b_version=t.object_b.version,this.points.length<4)this.points.push(t);else{var o=this.findWeakestContact(t);this.points[o].destroy(),this.points[o]=t}},e.ContactManifold.prototype.update=function(){var t=new e.Vector3,i=new e.Vector3,n=new e.Vector3,s=e.EPSILON;return function(){for(var e=0;e<this.points.length;e++){var a=this.points[e];a.object_a.transform.transformVector3Into(a.contact_point_in_a,t),a.object_b.transform.transformVector3Into(a.contact_point_in_b,i),a.contact_point.addVectors(t,i),a.contact_point.scale(.5),n.subtractVectors(t,i),a.penetration_depth=n.dot(a.contact_normal),(a.object_a_version!==a.object_a.version||a.object_b_version!==a.object_b.version)&&(a.penetration_depth=-(1/0));var r=1===this.points.length;if(a.penetration_depth<-s)r&&this.object_a.onCollisionContactExit&&this.object_a.onCollisionContactExit(a),a.destroy(),this.points[e]=this.points[this.points.length-1],this.points.pop();else{o.scaleVector(a.contact_normal,a.penetration_depth),o.subtractVectors(t,o),o.subtractVectors(i,o);var c=o.length();c>s&&(r&&this.object_a.onCollisionContactExit&&this.object_a.onCollisionContactExit(a),a.destroy(),this.points[e]=this.points[this.points.length-1],this.points.pop())}}0!==this.points.length&&this.object_a.onCollisionContactStay&&this.object_a.onCollisionContactStay(this.points[this.points.length-1])}}(),e.ContactManifoldList=function(){this.first=null,this.cache={}},e.ContactManifoldList.prototype.insert=function(t){var i=t.object_a.id>t.object_b.id?t.object_b.id:t.object_a.id,e=t.object_a.id+t.object_b.id-i;t.uid=i+":"+e,this.cache[t.uid]=t,t.next_manifold=this.first,this.first=t},e.ContactManifoldList.prototype["delete"]=function(t,i){null==t?this.first=i.next_manifold:t.next_manifold=i.next_manifold,this.cache[i.uid]=null},e.ContactManifoldList.prototype.getManifoldForObjects=function(t,i){var o=t.id>i.id?i.id:t.id,n=t.id+i.id-o,s=o+":"+n,a=this.cache[s];return a||(a=e.ObjectPool.getObject("ContactManifold"),a.object_a=t,a.object_b=i,this.insert(a)),a},e.IterativeSolver=function(){this.existing_contact_ids={},this.contact_constraints=[],this.friction_constraints=[],this.all_constraints=[],this.constraints=[],this.max_iterations=10,this.penetrations_max_iterations=5,this.relaxation=.9,this.sor_weight=.85,this.warmstarting_factor=.95,this.min_row_response=1e-5},e.IterativeSolver.prototype.onContactDeactivate=function(t){var i=this.contact_constraints.indexOf(t);i>=0&&(this.contact_constraints[i]=this.contact_constraints[this.contact_constraints.length-1],this.contact_constraints.length-=1),delete this.existing_contact_ids[t.contact.uid]},e.IterativeSolver.prototype.onFrictionDeactivate=function(t){var i=this.friction_constraints.indexOf(t);i>=0&&(this.friction_constraints[i]=this.friction_constraints[this.friction_constraints.length-1],this.friction_constraints.length-=1)},e.IterativeSolver.prototype.addConstraint=function(t){-1===this.constraints.indexOf(t)&&this.constraints.push(t)},e.IterativeSolver.prototype.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints[i]=this.constraints[this.constraints.length-1],this.constraints.length-=1)},e.IterativeSolver.prototype.processContactManifolds=function(t){var i,o,n,s,a;for(o=t.first;o;){for(n=o.points.length,i=0;n>i;i++){s=o.points[i];var r=this.existing_contact_ids.hasOwnProperty(s.uid);r||(this.existing_contact_ids[s.uid]=!0,a=e.ObjectPool.getObject("ContactConstraint"),a.buildFromContact(s),s.constraint=a,this.contact_constraints.push(a),a.solver=this,s.friction>0&&(a=e.ObjectPool.getObject("FrictionConstraint"),a.buildFromContact(s),this.friction_constraints.push(a),a.solver=this))}o=o.next_manifold}this.all_constraints.length=0,Array.prototype.push.apply(this.all_constraints,this.friction_constraints),Array.prototype.push.apply(this.all_constraints,this.constraints),Array.prototype.push.apply(this.all_constraints,this.contact_constraints)},e.IterativeSolver.prototype.prepareConstraints=function(t){var i,e,o,n,s=this.all_constraints.length;for(o=0;s>o;o++)if(i=this.all_constraints[o],i.active!==!1)for(i.update(t),n=0;n<i.rows.length;n++)e=i.rows[n],e.multiplier=0,e.computeB(i),e.computeD(),e.computeEta(i,t)},e.IterativeSolver.prototype.resolveContacts=function(){var t,i,n,s,a,r,c,h,l,p,u,_,f,b,d,m=0,y=this.relaxation;for(t=0;t<this.penetrations_max_iterations;t++){for(m=0,a=0;a<this.contact_constraints.length;a++){i=this.contact_constraints[a],s=i.rows[0],c=s.jacobian,_=s.B,n=0,i.object_a_is_dynamic()&&(h=i.object_a.linear_factor,l=i.object_a.angular_factor,p=i.object_a.push_velocity,u=i.object_a.turn_velocity,n+=c[0]*h.x*p.x+c[1]*h.y*p.y+c[2]*h.z*p.z+c[3]*l.x*u.x+c[4]*l.y*u.y+c[5]*l.z*u.z),i.object_b_is_dynamic()&&(h=i.object_b.linear_factor,l=i.object_b.angular_factor,p=i.object_b.push_velocity,u=i.object_b.turn_velocity,n+=c[6]*h.x*p.x+c[7]*h.y*p.y+c[8]*h.z*p.z+c[9]*l.x*u.x+c[10]*l.y*u.y+c[11]*l.z*u.z),r=(i.contact.penetration_depth-n)/s.D||0;var v=s.multiplier;s.multiplier=Math.max(s.lower_limit,Math.min(v+r,s.upper_limit)),r=s.multiplier-v,m=Math.max(m,r),i.object_a_is_dynamic()&&(p=i.object_a.push_velocity,u=i.object_a.turn_velocity,p.x+=r*_[0],p.y+=r*_[1],p.z+=r*_[2],u.x+=r*_[3],u.y+=r*_[4],u.z+=r*_[5]),i.object_b_is_dynamic()&&(p=i.object_b.push_velocity,u=i.object_b.turn_velocity,p.x+=r*_[6],p.y+=r*_[7],p.z+=r*_[8],u.x+=r*_[9],u.y+=r*_[10],u.z+=r*_[11])}if(m>=-e.EPSILON&&m<=e.EPSILON)break}for(a=0;a<this.contact_constraints.length;a++)i=this.contact_constraints[a],s=i.rows[0],c=s.jacobian,f=s.multiplier,i.object_a_is_dynamic()&&(h=i.object_b.linear_factor,l=i.object_b.angular_factor,b=f*y,d=i.object_a._mass_inverted*f*y,i.object_a.position.x+=d*c[0]*h.x,i.object_a.position.y+=d*c[1]*h.y,i.object_a.position.z+=d*c[2]*h.z,o.x=b*c[3]*l.x,o.y=b*c[4]*l.y,o.z=b*c[5]*l.z,i.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_a.integrateRotation(1,o)),i.object_b_is_dynamic()&&(h=i.object_b.linear_factor,l=i.object_b.angular_factor,b=f*y,d=i.object_b._mass_inverted*f*y,i.object_b.position.x+=d*c[6]*h.x,i.object_b.position.y+=d*c[7]*h.y,i.object_b.position.z+=d*c[8]*h.z,o.x=b*c[9]*l.x,o.y=b*c[10]*l.y,o.z=b*c[11]*l.z,i.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_b.integrateRotation(1,o)),s.multiplier=0},e.IterativeSolver.prototype.solveConstraints=function(){var t,i,e,o,n,s,a,r,c,h,l,p,u,_,f=this.all_constraints.length,b=0;for(n=0;f>n;n++)if(t=this.all_constraints[n],t.active!==!1)for(s=0;s<t.rows.length;s++)e=t.rows[s],o=e.multiplier_cached*this.warmstarting_factor,e.multiplier=o,l=e.B,Math.abs(e.D)<this.min_row_response||(t.object_a_is_dynamic()&&(h=t.object_a.solver_impulse,h[0]+=o*l[0],h[1]+=o*l[1],h[2]+=o*l[2],h[3]+=o*l[3],h[4]+=o*l[4],h[5]+=o*l[5]),t.object_b_is_dynamic()&&(h=t.object_b.solver_impulse,h[0]+=o*l[6],h[1]+=o*l[7],h[2]+=o*l[8],h[3]+=o*l[9],h[4]+=o*l[10],h[5]+=o*l[11]));for(a=0;a<this.max_iterations;a++){for(b=0,n=0;f>n;n++)if(t=this.all_constraints[n],t.active!==!1)for(i=t.rows.length,s=0;i>s;s++)if(e=t.rows[s],!(Math.abs(e.D)<this.min_row_response)){c=0,_=e.jacobian,l=e.B,t.object_a_is_dynamic()&&(p=t.object_a.linear_factor,u=t.object_a.angular_factor,h=t.object_a.solver_impulse,c+=_[0]*p.x*h[0]+_[1]*p.y*h[1]+_[2]*p.z*h[2]+_[3]*u.x*h[3]+_[4]*u.y*h[4]+_[5]*u.z*h[5]),t.object_b_is_dynamic()&&(p=t.object_b.linear_factor,u=t.object_b.angular_factor,h=t.object_b.solver_impulse,c+=_[6]*p.x*h[0]+_[7]*p.y*h[1]+_[8]*p.z*h[2]+_[9]*u.x*h[3]+_[10]*u.y*h[4]+_[11]*u.z*h[5]),r=((e.eta-c)/e.D||0)*t.factor;var d=e.multiplier,m=d+r;m=this.sor_weight*m+(1-this.sor_weight)*d,e.multiplier=Math.max(e.lower_limit,Math.min(m,e.upper_limit)),r=e.multiplier-d;var y=(t.object_a_is_dynamic()?t.object_a._mass:0)+(t.object_b_is_dynamic()?t.object_b._mass:0);b=Math.max(b,Math.abs(r)/y),t.object_a_is_dynamic()&&(h=t.object_a.solver_impulse,h[0]+=r*l[0],h[1]+=r*l[1],h[2]+=r*l[2],h[3]+=r*l[3],h[4]+=r*l[4],h[5]+=r*l[5]),t.object_b_is_dynamic()&&(h=t.object_b.solver_impulse,h[0]+=r*l[6],h[1]+=r*l[7],h[2]+=r*l[8],h[3]+=r*l[9],h[4]+=r*l[10],h[5]+=r*l[11])}if(.1>=b)break}},e.IterativeSolver.prototype.applyConstraints=function(t){var i,e,s,a,r,c,h,l,p,u,_=this.all_constraints.length;for(a=0;_>a;a++)if(i=this.all_constraints[a],i.active!==!1){for(e=i.rows.length,i.last_impulse.x=i.last_impulse.y=i.last_impulse.z=0,r=0;e>r;r++)s=i.rows[r],s.multiplier_cached=s.multiplier,c=s.jacobian,Math.abs(s.D)<this.min_row_response||(i.object_a_is_dynamic()&&(h=i.object_a._mass_inverted*t*s.multiplier,l=t*s.multiplier,p=i.object_a.linear_factor,u=i.object_a.angular_factor,n.x=h*c[0]*p.x,n.y=h*c[1]*p.y,n.z=h*c[2]*p.z,i.object_a.linear_velocity.add(n),i.last_impulse.add(n),o.x=l*c[3]*u.x,o.y=l*c[4]*u.y,o.z=l*c[5]*u.z,i.object_a.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_a.angular_velocity.add(o),i.last_impulse.add(o)),i.object_b_is_dynamic()&&(h=i.object_b._mass_inverted*t*s.multiplier,l=t*s.multiplier,p=i.object_b.linear_factor,u=i.object_b.angular_factor,n.x=h*c[6]*p.x,n.y=h*c[7]*p.y,n.z=h*c[8]*p.z,i.object_b.linear_velocity.add(n),i.last_impulse.add(n),o.x=l*c[9]*u.x,o.y=l*c[10]*u.y,o.z=l*c[11]*u.z,i.object_b.inverseInertiaTensorWorldFrame.transformVector3(o),i.object_b.angular_velocity.add(o),i.last_impulse.add(o)));i.breaking_threshold>0&&i.last_impulse.lengthSquared()>=i.breaking_threshold*i.breaking_threshold&&(i.active=!1)}},e.NarrowPhase=function(){this.contact_manifolds=new e.ContactManifoldList},e.NarrowPhase.prototype.updateContactManifolds=function(){for(var t=this.contact_manifolds.first,i=null;null!==t;)t.update(),0===t.points.length?(e.ObjectPool.freeObject("ContactManifold",t),this.contact_manifolds["delete"](i,t),t=t.next_manifold):(i=t,t=t.next_manifold)},e.NarrowPhase.prototype.midPhase=function(t,i){var o,n,s;t.shape.shapeType===e.Shapes.Type.CompoundShape?(o=t,n=i,s=!0):(o=i,n=t,s=!1);for(var a=e.ObjectPool.getObject("RigidBodyProxy"),r=null,c=null,h=null,l=null,p=0;p<o.shape.child_shapes.length;p++){var u=o.shape.child_shapes[p];if(a.setFrom(o,u),a.shape.shapeType===e.Shapes.Type.CompoundShape||n.shape.shapeType===e.Shapes.Type.CompoundShape)h=this.midPhase(a,n);else{if(h=this.getContacts(a,n),null===h)continue;for(var _=0;_<h.length;_++){var f=h[_];f.tag||(f.object_a===a?(f.object_a=o,r=a,c=n):(f.object_b=o,r=n,c=a,s=!s),f.object_a=r,f.object_b=c,f.shape_a=s?n.shape:a.shape,f.shape_b=s?a.shape:n.shape,this.addContact(r,c,f))}}l=l||h}return e.ObjectPool.freeObject("RigidBodyProxy",a),l},e.NarrowPhase.prototype.meshCollision=function(){function t(t,i,l){s.copy(t.transform_inverse),s.multiply(i.transform);for(var p=null,u=t.shape,_=i.shape,f=[t.shape.hierarchy,i.shape.hierarchy];f.length;){var b=f.shift(),d=f.shift();if(b.isLeaf()&&d.isLeaf()){s.transformVector3Into(d.object.a,a.a),s.transformVector3Into(d.object.b,a.b),s.transformVector3Into(d.object.c,a.c),o.subtractVectors(a.b,a.a),n.subtractVectors(a.c,a.a),a.normal.crossVectors(o,n),a.normal.normalize();var m=l._shouldPerformLightweightCollisionBetween(t,i);if(p=e.Collision.triangleTriangle(b.object,a,m),null!==p)for(var y=0;y<p.length;y++){var v=p[y];t.transform.rotateVector3(v.contact_normal),t.transform.transformVector3(v.contact_point),t.transform.transformVector3(v.contact_point_in_b),i.transform_inverse.transformVector3(v.contact_point_in_b),v.shape_a=u,v.shape_b=_,v.object_a=t,v.object_b=i,l.addContact(t,i,v)}}else b.isLeaf()?(h.transform(d.left.aabb,s),b.aabb.intersects(h)&&f.push(b,d.left),c.transform(d.right.aabb,s),b.aabb.intersects(c)&&f.push(b,d.right)):d.isLeaf()?(r.transform(d.aabb,s),r.intersects(b.left.aabb)&&f.push(b.left,d),r.intersects(b.right.aabb)&&f.push(b.right,d)):(h.transform(d.left.aabb,s),c.transform(d.right.aabb,s),b.left.aabb.intersects(h)&&f.push(b.left,d.left),b.left.aabb.intersects(c)&&f.push(b.left,d.right),b.right.aabb.intersects(h)&&f.push(b.right,d.left),b.right.aabb.intersects(c)&&f.push(b.right,d.right))}return p}function i(t,i,o,n){var s=e.ObjectPool.getObject("RigidBodyProxy"),a=new e.CompoundShapeChild(t,new e.Vector3,new e.Quaternion);s.setFrom(i,a);var r=e.GjkEpa.findContacts(s,o,n);return e.ObjectPool.freeObject("RigidBodyProxy",s),r}var s=new e.Matrix4,a=new e.TriangleShape(new e.Vector3,new e.Vector3,new e.Vector3),r=new e.AABB,c=new e.AABB,h=new e.AABB,l=function(){var t=new e.Matrix4,o=new e.AABB;return function(e,n,s){t.copy(n.transform),t.multiply(e.transform_inverse),o.transform(n.aabb,e.transform_inverse);for(var a,r=[e.shape.hierarchy],c=null,h=null;a=r.shift();)if(a.aabb.intersects(o))if(a.isLeaf()){var l=s._shouldPerformLightweightCollisionBetween(e,n);if(c=i(a.object,e,n,l),null===c)continue;for(var p=0;p<c.length;p++){var u=c[p];u.shape_a=e.shape,u.shape_b=n.shape,s.addContact(u.object_a,u.object_b,u)}h=h||c}else r.push(a.left,a.right);return h}}();return function(i,o){var n=i.shape.shapeType===e.Shapes.Type.MeshShape,s=o.shape.shapeType===e.Shapes.Type.MeshShape;return n&&s?t(i,o,this):n?l(i,o,this):l(o,i,this)}}(),e.NarrowPhase.prototype.getContacts=function(t,i){if(!t.aabb.intersects(i.aabb))return null;if(t.shape.shapeType===e.Shapes.Type.CompoundShape||i.shape.shapeType===e.Shapes.Type.CompoundShape)return this.midPhase(t,i);if(t.shape.shapeType===e.Shapes.Type.MeshShape||i.shape.shapeType===e.Shapes.Type.MeshShape)return this.meshCollision(t,i);var o=this._shouldPerformLightweightCollisionBetween(t,i),n=e.Collision.Factory.getCollisionMethod(t.shape,i.shape),s=n(t,i,o);if(null===s)return null;for(var a=0;a<s.length;a++){var r=s[a];r.shape_a=t.shape,r.shape_b=i.shape}return s},e.NarrowPhase.prototype.addContact=function(t,i,o){if(null!==t.world&&null!==i.world&&!o.tag){for(o.tag=!0;null!=o.object_a.parent;)o.object_a.shape_data.transform.transformVector3(o.contact_point_in_a),o.object_a=o.object_a.parent;for(;null!=o.object_b.parent;)o.object_b.shape_data.transform.transformVector3(o.contact_point_in_b),o.object_b=o.object_b.parent;if(o.is_lightweight)return void(o.object_a.onTriggerContactEnter&&o.object_a.onTriggerContactEnter(o));o.restitution=e.CollisionUtils.combineRestitutions(o.object_a,o.object_b,o.shape_a,o.shape_b),o.friction=e.CollisionUtils.combineFrictions(o.object_a,o.object_b,o.shape_a,o.shape_b),this.contact_manifolds.getManifoldForObjects(o.object_a,o.object_b).addContact(o)}},e.NarrowPhase.prototype.generateContacts=function(t){var i=t.length;this.updateContactManifolds();for(var e=0;i>e;e++){var o=this.getContacts(t[e][0],t[e][1]);if(null!==o)for(var n=0;n<o.length;n++){var s=o[n];this.addContact(s.object_a,s.object_b,s)}}},e.NarrowPhase.prototype.removeBody=function(t){for(var i=this.contact_manifolds.first;null!=i;){if(i.object_a===t||i.object_b===t){for(var e=0;e<i.points.length;e++)i.points[e].destroy();i.points.length=0}i=i.next}},e.NarrowPhase.prototype._shouldPerformLightweightCollisionBetween=function(t,i){return t.is_trigger||i.is_trigger},e.ObjectPool={types:{},pools:{},registerType:function(t,i){this.types[t]=i,this.pools[t]=[]},getObject:function(t){var i=this.pools[t];if(0!==i.length){var e=i.pop();return e.tag=null,e}return this.types[t]()},freeObject:function(t,i){null!=i.removeAllListeners&&i.removeAllListeners(),this.pools[t].push(i)}},e.ObjectPool.registerType("ContactDetails",function(){return new e.ContactDetails}),e.ObjectPool.registerType("ContactManifold",function(){return new e.ContactManifold}),e.ObjectPool.registerType("GJK2SupportPoint",function(){return new e.GjkEpa.SupportPoint(new e.Vector3,new e.Vector3,new e.Vector3)}),e.ObjectPool.registerType("ConstraintRow",function(){return new e.ConstraintRow}),e.ObjectPool.registerType("ContactConstraint",function(){return new e.ContactConstraint}),e.ObjectPool.registerType("FrictionConstraint",function(){return new e.FrictionConstraint}),e.ObjectPool.registerType("RayIntersection",function(){return new e.RayIntersection}),e.ObjectPool.registerType("RigidBodyProxy",function(){return new e.RigidBodyProxy}),e.PhysicMaterial=function(t){this.name=t.name,this.bounciness=t.bounciness,this.dynamicFriction=t.dynamicFriction,this.staticFriction=t.staticFriction,this.frictionCombine=t.frictionCombine,this.bounceCombine=t.bounceCombine},e.RigidBodyProxy=function(){this.parent=null,this.id=null,this.shape=null,this.aabb=new e.AABB,this._mass=null,this._mass_inverted=null,this.position=new e.Vector3,this.rotation=new e.Quaternion,this.transform=new e.Matrix4,this.transform_inverse=new e.Matrix4,this.restitution=null,this.friction=null,this.is_kinematic=!1,this.is_trigger=!1},Object.defineProperty(e.RigidBodyProxy.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t,this._mass_inverted=1/t,this.inertiaTensor=this.shape.getInertiaTensor(this.is_kinematic?1/0:t)}}),e.RigidBodyProxy.prototype.setFrom=function(t,i){this.parent=t,this.id=t.id,this.shape=i.shape,this.shape_data=i,this._mass=t._mass,this.is_kinematic=t.is_kinematic,t.transform.transformVector3Into(i.position,this.position),this.rotation.multiplyQuaternions(t.rotation,i.rotation),this.transform.makeTransform(this.rotation,this.position),this.transform.invertInto(this.transform_inverse),this.aabb.transform(this.shape.aabb,this.transform),this.restitution=t.restitution,this.friction=t.friction,this.is_trigger=t.is_trigger,this.faceNormals=t.faceNormals},e.RigidBodyProxy.prototype.findSupportPoint=e.RigidBody.prototype.findSupportPoint,e.RigidBodyProxy.prototype.getRigidBody=function(){for(var t=this.parent;t.parent;)t=this.parent;return t},e.World=function(t,i,o){this.ticks=0,this.broadphase=t,this.narrowphase=i,this.solver=o,o.world=this,this.rigid_bodies=[],this.gravity=new e.Vector3(0,-9.8,0),this.force_generators=[],this.collision_matrix={},this.listeners={}},e.EventEmitter.apply(e.World),e.World.prototype.step=function(t,i){i=i||t;var e,n,s,a,r,c;for(s=t/i,e=0;s>e;e++){this.ticks++,n=Math.min(i,t),t-=i,this.emit("stepStart",this.ticks,n);var h=this.rigid_bodies;for(a=0,r=h.length;r>a;a++)c=h[a],c._is_kinematic||(c._mass!==1/0&&c.use_gravity&&(o.scaleVector(c.gravity||this.gravity,c._mass*n),c.accumulated_force.add(o)),c._mass!==1/0&&(o.scaleVector(c.linear_acceleration,c._mass*n),c.accumulated_force.add(o),o.scaleVector(c.angular_acceleration,c._mass*n),c.accumulated_torque.add(o)));for(a=0,r=this.force_generators.length;r>a;a++)this.force_generators[a].applyForce();for(a=0,r=h.length;r>a;a++)h[a].updateDerived();for(this.drawDebug(),this.broadphase.update(),this.narrowphase.generateContacts(this.broadphase.collision_pairs),this.solver.processContactManifolds(this.narrowphase.contact_manifolds),this.solver.prepareConstraints(n),this.solver.resolveContacts(),this.solver.solveConstraints(),this.solver.applyConstraints(n),a=0,r=h.length;r>a;a++)c=h[a],c.integrate(n);this.emit("stepEnd",this.ticks,n)}},e.World.prototype.drawDebug=function(){if(this.debug){var t,i,o,n,s,a;for(t=0;t<this.rigid_bodies.length;t++)for(o=this.rigid_bodies[t],o.debug&&(n=o.aabb,pc.Application.getApplication().renderWireCube((new pc.Mat4).setTRS(new pc.Vec3(n.min.x+n.max.x,n.min.y+n.max.y,n.min.z+n.max.z).scale(.5),pc.Quat.IDENTITY,new pc.Vec3(n.min.x-n.max.x,n.min.y-n.max.y,n.min.z-n.max.z).scale(-1)),new pc.Color(1,0,0,1),pc.LINEBATCH_OVERLAY)),s=o.shape.child_shapes||[],i=0;i<s.length;i++)a=s[i].shape,a.debug&&(n=new e.AABB,n.transform(s[i].aabb,o.transform),pc.Application.getApplication().renderWireCube((new pc.Mat4).setTRS(new pc.Vec3(n.min.x+n.max.x,n.min.y+n.max.y,n.min.z+n.max.z).scale(.5),pc.Quat.IDENTITY,new pc.Vec3(n.min.x-n.max.x,n.min.y-n.max.y,n.min.z-n.max.z).scale(-1)),new pc.Color(0,1,0,1),pc.LINEBATCH_OVERLAY))}},e.World.prototype.addRigidBody=function(t){if(t.world)throw new Error("The body already belongs to a physics world!");t.world=this,t.updateDerived(),this.rigid_bodies.push(t),this.broadphase.addBody(t)},e.World.prototype.removeRigidBody=function(t){var i;for(i=0;i<this.rigid_bodies.length;i++)if(this.rigid_bodies[i]===t){this.rigid_bodies.splice(i,1),this.broadphase.removeBody(t);break}t.world=null,this.narrowphase.removeBody(t)},e.World.prototype.updateObjectLayer=function(t,i){this.broadphase.updateObjectLayer(t,i)},e.World.prototype.updateObjectStaticFlag=function(t,i){this.broadphase.updateObjectStaticFlag(t,i)},e.World.prototype.updateObjectKinematicFlag=function(t,i){this.broadphase.updateObjectKinematicFlag(t,i)},e.World.prototype.addForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return;this.force_generators.push(t)},e.World.prototype.removeForceGenerator=function(t){var i,e;for(i=0,e=this.force_generators.length;e>i;i++)if(this.force_generators[i]===t)return void this.force_generators.splice(i,1)},e.World.prototype.addConstraint=function(t){this.solver.addConstraint(t)},e.World.prototype.removeConstraint=function(t){this.solver.removeConstraint(t)},function(){var t=function(t,i){return t.t<i.t?-1:t.t>i.t?1:0};e.World.prototype.rayIntersect=function(i,e,o,n){var s=this.broadphase.rayIntersect(i,e,0,n);return s.sort(t),s.slice(0,o)},e.World.prototype.shapeIntersect=function(i,o,n,s,a){var r=new e.LineSweptShape(o,n,i),c=new e.RigidBody(r,0);c.updateDerived();for(var h=this.broadphase.intersectsWith(c,a),l=[],p=0;p<h.length;p++){var u=this.narrowphase.getContact(c,h[p]);if(null!=u){var _=e.ObjectPool.getObject("RayIntersection");_.normal.copy(u.contact_normal),_.point.scaleVector(u.contact_normal,-u.penetration_depth),_.point.add(u.contact_point),_.t=_.point.distanceTo(o),_.object=u.shape_b===r?u.object_a:u.object_b,_.shape=u.shape_b===r?u.shape_a:u.shape_b,l.push(_)}if(s<=l.length)break}return l.sort(t),l}}(),"undefined"!=typeof window&&(window.Goblin=e),"undefined"!=typeof self&&(self.Goblin=e),"undefined"!=typeof module&&(module.exports=e)}();